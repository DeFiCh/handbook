<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Interchain Exchange - DeFiChain Handbook</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../../prelude.html">Prelude</a></li><li class="chapter-item "><div>Introduction</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div>Getting Started</div></li></ol></li><li class="chapter-item expanded "><a href="../../concepts.html">Concepts</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../block.html">Blocks and the Blockchain</a></li><li class="chapter-item "><a href="../../transaction.html">Transactions</a></li><li class="chapter-item "><a href="../../customtx.html">Custom Transactions</a></li><li class="chapter-item "><a href="../../proto.html">Protocol and Network</a></li><li class="chapter-item expanded "><a href="../../pinkpaper/index.html">Pink Paper</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../pinkpaper/emission/index.html">Emission</a></li><li class="chapter-item "><a href="../../pinkpaper/fees/index.html">Fees</a></li><li class="chapter-item "><a href="../../pinkpaper/futures/index.html">Futures</a></li><li class="chapter-item "><a href="../../pinkpaper/governance/index.html">Governance</a></li><li class="chapter-item expanded "><a href="../../pinkpaper/interchain-exchange/index.html" class="active">Interchain Exchange</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../pinkpaper/interchain-exchange/fees.html">Fees</a></li></ol></li><li class="chapter-item "><a href="../../pinkpaper/loan/index.html">Loan</a></li><li class="chapter-item "><a href="../../pinkpaper/operator/index.html">Operator</a></li><li class="chapter-item "><a href="../../pinkpaper/price-oracle/index.html">Price Oracle</a></li></ol></li></ol></li><li class="chapter-item "><div>DFIPS</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../dfips/2203.html">DFIP 2203</a></li></ol></li><li class="chapter-item "><a href="../../guides.html">Guides</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../defid.html">Using defid - The Reference Node</a></li><li class="chapter-item "><a href="../../node/wallet.html">Using a Wallet</a></li></ol></li><li class="chapter-item "><a href="../../concepts.html">References</a></li><li class="chapter-item "><div>Ecosystem</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div>Wallets</div></li></ol></li><li class="chapter-item "><div>Resources</div></li><li class="chapter-item "><div>Drafts</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../drafts/releases.html">Releases</a></li><li class="chapter-item "><div>Code Conventions</div></li><li class="chapter-item "><div>Git Conventions</div></li><li class="chapter-item "><a href="../../drafts/loans.html">Loans</a></li></ol></li><li class="chapter-item "><a href="../../glossary.html">Glossary</a></li><li class="chapter-item "><a href="../../faq.html">FAQ</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">DeFiChain Handbook</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/DeFiCh/handbook/tree/main/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/DeFiCh/handbook/edit/main/src/pinkpaper/interchain-exchange/README.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="interchain-exchange"><a class="header" href="#interchain-exchange">Interchain Exchange</a></h1>
<h2 id="goals"><a class="header" href="#goals">Goals</a></h2>
<p>Allow users to trustlessly and seamlessly swap between DST and Bitcoin BTC. BTC in the rest of this document will only referring to BTC on Bitcoin blockchain and not BTC DST.</p>
<p>Key areas of focus, in decreasing order of importance:</p>
<ol>
<li>Safety</li>
<li>User experience – it should be easily presentable on a client UI</li>
<li>Seamlessness - most of the steps should be automated at client</li>
</ol>
<h2 id="components"><a class="header" href="#components">Components</a></h2>
<ol>
<li>
<p>Hash Time Lock Contract</p>
<ul>
<li>A.k.a. HTLC</li>
<li>Part of Bitcoin script, and DFC side, it's a new construct for DST.</li>
<li>Requires both participants to be active.</li>
<li>H = Hash(S)</li>
</ul>
</li>
<li>
<p>Inter-chain Exchange</p>
<ul>
<li>A.k.a. ICX / XCX</li>
<li>This is on-chain (DeFiChain) trustless exchange with &quot;traditional&quot; orderbook</li>
</ul>
</li>
<li>
<p>SPV wallet</p>
<ul>
<li>Simple Payment Verification Bitcoin wallet</li>
<li>Distributed as part of DeFiChain node</li>
<li>This is why we are only supporting Bitcoin, at least for now.</li>
</ul>
</li>
</ol>
<h2 id="glossary"><a class="header" href="#glossary">Glossary</a></h2>
<ol>
<li>Buyer vs Seller</li>
<li>Maker vs Taker</li>
</ol>
<h2 id="scenarios"><a class="header" href="#scenarios">Scenarios</a></h2>
<p>2 scenarios:</p>
<ol>
<li>
<p>DST seller maker, wants BTC</p>
<ul>
<li>Paired with BTC seller taker</li>
</ul>
</li>
<li>
<p>BTC seller maker, wants DST</p>
<ul>
<li>Paired with DST seller taker</li>
</ul>
</li>
</ol>
<h2 id="scenario-1"><a class="header" href="#scenario-1">Scenario 1</a></h2>
<p><img src="img/xcx-scenario1.png" alt="Scenario 1" /></p>
<p>Alice
- Sells DST, wants BTC
- Maker</p>
<p>Bob
- Sells BTC, wants DST
- Taker</p>
<ol>
<li>
<p>Alice, as maker, puts up an order:</p>
<ul>
<li>For sale: 10 TSLA DST</li>
<li>unitPrice: 0.02 <em>(BTC - $800 each for BTC at $40k)</em></li>
<li>expiry: 2880 blocks</li>
<li>optionFeePerUnit: 8 <em>(DFI)</em></li>
</ul>
</li>
<li>
<p>Bob, as taker:</p>
<ul>
<li>Wants to buy just 2.5 TSLA, not all 10. <em>(partial order)</em></li>
<li>Makes an acceptance offer.</li>
<li>Transmits <code>optionFeePerUnit * unit</code> 8 * 2.5 = 20 DFI alongside the order into HTLC. No payment DFI is locked up yet, only 20 DFI for optionFee</li>
<li>UX: either browse orderbook, or do a market order <em>(easier: always match with the best price)</em></li>
</ul>
</li>
<li>
<p>Alice accepts the offer</p>
<ul>
<li>UX side this is automatically accepted</li>
<li>Moves 2.5 TSLA from the order into DFC DST HTLC (also known as ICX Contract).</li>
<li>Properties of HTLC:
<ul>
<li>2.5 TSLA locked up for 120 blocks (1 hour)</li>
<li>with H provided, where H = Hash(S) the funds for Bob can be unlocked from this HTLC.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Bob sees the DST HTLC, verifies the following:</p>
<ul>
<li>Amount, token, time locked up and recipient is correct.</li>
<li>Waits for sufficient confirmation at DFC side to ensure finality.</li>
<li>Bob, now initiates on the Bitcoin side, HTLC for:
<ul>
<li>2.5 * 0.02 = 0.05 BTC</li>
<li>With the same H. Take note that Alice knows S, but Bob does not know S.</li>
<li>Time limit is 30 minutes.</li>
</ul>
</li>
<li>Bob updates ICX C on this HTLC.</li>
</ul>
</li>
<li>
<p>Alice accepting Bitcoin</p>
<ul>
<li>Alice confirms that HTLC properties are correct, amount, time, recipient.</li>
<li>Waits for sufficient confirmation at Bitcoin blockchain to ensure finality.</li>
<li>Claims Bitcoin by revealing S.</li>
</ul>
</li>
<li>
<p>Bob now claims DST.</p>
<ul>
<li>Bob sees that Alice has claimed and revealed S.</li>
<li>Bob claims DST too by using the same S.</li>
<li>DST is claimed on ICX C itself, this sends DST to Bob, and refunds Bob the <code>optionFee</code>.</li>
</ul>
</li>
</ol>
<h3 id="bad-actors"><a class="header" href="#bad-actors">Bad actors</a></h3>
<ol>
<li>N/A</li>
<li>N/A</li>
<li>If Alice does not accept, Bob's offer expires after 20 blocks and takes back <code>optionFee</code>.</li>
<li>If Bob does not honor the BTC side, Alice receives back her 2.5 TSLA after 1 hour + <code>optionFee</code>.</li>
</ol>
<h2 id="scenario-2"><a class="header" href="#scenario-2">Scenario 2</a></h2>
<p><img src="img/xcx-scenario2.png" alt="Scenario 2" /></p>
<p>Charlie
- Sells BTC, wants DST
- Maker</p>
<p>Dave
- Sells DST, wants BTC
- Taker</p>
<ol>
<li>
<p>Charlie, as maker, puts up an order:</p>
<ul>
<li>Buying: 10 TSLA DST</li>
<li>unitPrice: 0.02 <em>(BTC - $800 each for BTC at $40k)</em></li>
<li>expiry: 2880 blocks</li>
<li>optionFeePerUnit: 8 <em>(DFI)</em></li>
</ul>
</li>
<li>
<p>Dave, as taker:</p>
<ul>
<li>Wants to sell just 2.5 TSLA, not all 10. <em>(partial order)</em></li>
<li>Makes an acceptance offer.</li>
<li>Transmits <code>optionFeePerUnit * unit</code> 8 * 2.5 = 20 DFI alongside the order into HTLC. No payment DFI is locked up yet, only 20 optionFee DFI.</li>
<li>UX: either browse orderbook, or do a market order <em>(easier: always match with the best price)</em></li>
</ul>
</li>
<li>
<p>Charlie accepts the offer</p>
<ul>
<li>Charlie comes up with S. Computes H where H = Hash(S).</li>
<li>Charlie locks up BTC on the Bitcoin HTLC for:
<ul>
<li>2.5 * 0.02 = 0.05 BTC</li>
<li>With H. Take note that Charlie knows S, but Dave does not know S.</li>
<li>Time limit is 1 hour (6 blocks).</li>
</ul>
</li>
<li>and creates ICX Contract with H, and Bitcoin HTLC address.</li>
<li>Dave's <code>optionFee</code> is locked in ICX C.</li>
</ul>
</li>
<li>
<p>Dave sees that Charlie has accepted the offer and that BTC is now locked in HTLC</p>
<ul>
<li>Validates that BTC HTLS is correctly set up - amount, time, recipient</li>
<li>Waits for sufficient confirmation on BTC side to ensure finality.</li>
<li>Moves 2.5 TSLA from the order into DFC ICX C (no need to provide H as contract already know H)</li>
</ul>
</li>
<li>
<p>Charlie accepts DST</p>
<ul>
<li>Waits for sufficient confirmation on DFC side to ensure finality.</li>
<li>Claims DST by revealing S</li>
<li>This sends DST to Charlie and refunds <code>optionFee</code> to Dave.</li>
</ul>
</li>
<li>
<p>Dave now claims BTC</p>
<ul>
<li>using the same S on the BTC HTLC</li>
</ul>
</li>
</ol>
<h3 id="bad-actors-1"><a class="header" href="#bad-actors-1">Bad actors</a></h3>
<ol>
<li>N/A</li>
<li>N/A</li>
<li>If Charlie does not accept, Bob's offer expires after 10 blocks and takes back <code>optionFee</code>.</li>
<li>If Bob does not honor the BTC side, Alice receives back her 2.5 TSLA after 1 hour + <code>optionFee</code>.</li>
</ol>
<h1 id="override-notice-fees-and-incentives"><a class="header" href="#override-notice-fees-and-incentives">Override Notice: Fees and Incentives</a></h1>
<p><em>TODO: Cleanup this document to be coherent</em></p>
<p>The above document has parts overriden by the <a href="fees.html">fees document</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../pinkpaper/governance/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../pinkpaper/interchain-exchange/fees.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../pinkpaper/governance/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../pinkpaper/interchain-exchange/fees.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_line_numbers = true;
        </script>
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../../scripts/mermaid.min.js"></script>
        <script type="text/javascript" src="../../scripts/mermaid-init.js"></script>
    </body>
</html>
