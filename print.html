<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>DeFiChain Handbook</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="prelude.html">Prelude</a></li><li class="chapter-item "><div>Introduction</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div>Getting Started</div></li></ol></li><li class="chapter-item "><a href="concepts.html">Concepts</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="concepts/block.html">Blocks and the Blockchain</a></li><li class="chapter-item "><a href="concepts/transaction.html">Transactions</a></li><li class="chapter-item "><a href="concepts/customtx.html">Custom Transactions</a></li><li class="chapter-item "><a href="concepts/proto.html">Protocol and Network</a></li><li class="chapter-item "><a href="pinkpaper/index.html">Pink Paper</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="pinkpaper/emission/index.html">Emission</a></li><li class="chapter-item "><a href="pinkpaper/fees/index.html">Fees</a></li><li class="chapter-item "><a href="pinkpaper/futures/index.html">Futures</a></li><li class="chapter-item "><a href="pinkpaper/governance/index.html">Governance</a></li><li class="chapter-item "><a href="pinkpaper/interchain-exchange/index.html">Interchain Exchange</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="pinkpaper/interchain-exchange/fees.html">Fees</a></li></ol></li><li class="chapter-item "><a href="pinkpaper/loan/index.html">Loan</a></li><li class="chapter-item "><a href="pinkpaper/operator/index.html">Operator</a></li><li class="chapter-item "><a href="pinkpaper/price-oracle/index.html">Price Oracle</a></li></ol></li></ol></li><li class="chapter-item "><div>DFIPS</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="dfips/2203.html">DFIP 2203</a></li></ol></li><li class="chapter-item "><a href="guides.html">Guides</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="guides/defid.html">Installing defid - The Reference Node</a></li><li class="chapter-item "><a href="guides/upgrading.html">Upgrading defid</a></li><li class="chapter-item "><a href="guides/compiling.html">Compiling from source</a></li><li class="chapter-item "><a href="guides/testing.html">Running tests</a></li><li class="chapter-item "><a href="guides/wallet.html">Using a Wallet</a></li><li class="chapter-item "><a href="guides/loans.html">Loans</a></li><li class="chapter-item "><a href="guides/dex.html">Decentralised Exchange</a></li><li class="chapter-item "><a href="guides/guide_floppynet.html">Run a Local Node in Floppynet</a></li><li class="chapter-item "><a href="guides/guide_floppynet_short.html">Connect Metamask to Floppynet</a></li><li class="chapter-item "><a href="guides/guide_changi.html">Run a Local Node in Changi Testnet</a></li><li class="chapter-item "><a href="guides/guide_changi_short.html">Connect Metamask to Changi Testnet</a></li></ol></li><li class="chapter-item "><a href="concepts.html">References</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="references/hardforks.html">Hard forks</a></li><li class="chapter-item "><a href="references/governance_variables.html">Governance Variables</a></li><li class="chapter-item "><a href="references/burn.html">Burns</a></li></ol></li><li class="chapter-item "><div>Ecosystem</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div>Wallets</div></li></ol></li><li class="chapter-item "><div>Resources</div></li><li class="chapter-item "><div>Drafts</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="drafts/releases.html">Releases</a></li><li class="chapter-item "><div>Code Conventions</div></li><li class="chapter-item "><div>Git Conventions</div></li></ol></li><li class="chapter-item "><a href="glossary.html">Glossary</a></li><li class="chapter-item "><a href="faq.html">FAQ</a></li><li class="chapter-item "><a href="issues.html">Open Issues</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">DeFiChain Handbook</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/DeFiCh/handbook/tree/main/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="prelude"><a class="header" href="#prelude">Prelude</a></h1>
<h2 id="whats-the-goal-of-this-handbook"><a class="header" href="#whats-the-goal-of-this-handbook">What's the goal of this handbook?</a></h2>
<p>To slowly start building this up:</p>
<ul>
<li>Critical docs: Concepts, Guides and References.
<ul>
<li>Concepts: The internal technical detail, research and relevant topics.</li>
<li>Guides: A guide on how the features can be used from a user perspective.
<ul>
<li>User: How to interact and use the node as a regular user.</li>
<li>Developer: How to interact on a deeper perspective as a developer.</li>
<li>Institution: How to interact with the node for exchanges, dealing with updates, best practices etc.</li>
</ul>
</li>
<li>References: A to-the-point reference that's used for quick references.</li>
</ul>
</li>
<li>Standard practices for coding, git, things like how to add a new data structure, add rpc, etc</li>
<li>Testing: how to write a test and contribute (so we can welcome external contributions too), and release checks</li>
<li>Links to pink paper, external resources of all kind (a dedicated page similar to github awesome-{x} repos.</li>
<li>Anything that's doesn't belong in the source code or is process related.</li>
</ul>
<h2 id="how-do-i-read-and-write-this-handbook"><a class="header" href="#how-do-i-read-and-write-this-handbook">How do I read and write this handbook?</a></h2>
<p>The book uses the simplest Markdown generator available, <code>mdbook</code> - intentionally.
No big features. It's simple. Any engineer should be able to learn and use it
in minutes - not hours.</p>
<ul>
<li><a href="https://rust-lang.github.io/mdBook/guide/reading.html">Reading the handbook</a></li>
<li><a href="https://rust-lang.github.io/mdBook/guide/creating.html">Contributing to the handbook</a></li>
</ul>
<p>Learn about it here: <a href="https://rust-lang.github.io/mdBook/index.html">mdbook</a></p>
<h2 id="attributions"><a class="header" href="#attributions">Attributions</a></h2>
<p>Parts of this handbook were edited from the <a href="https://en.bitcoin.it/wiki/Main_Page">Bitcoin Wiki</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="concepts"><a class="header" href="#concepts">Concepts</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="blocks-and-the-blockchain"><a class="header" href="#blocks-and-the-blockchain">Blocks and the Blockchain</a></h1>
<p>Each DeFiChain block consists of</p>
<ul>
<li>a block header: contains metadata about the block and its contents and links to previous block</li>
<li>a body: contains a list of transactions in that block.</li>
</ul>
<p>Blocks are identified by their <a href="concepts/./glossary.html#hashing">SHA256 hashes</a>.</p>
<h2 id="block-header"><a class="header" href="#block-header">Block header</a></h2>
<p>The header format of DeFiChain blocks is as follows. The implementation of the block header can be found in the class <code>CBlockHeader</code> in file <a href="https://github.com/DeFiCh/ain/blob/master/src/primitives/block.h#L23"><code>src/primitives/block.h</code></a>.</p>
<table><thead><tr><th>Name</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>nVersion</td><td>int32_t</td><td>Used to create and accept soft forks. Usually 536870912. For details on how nVersion is processed and used, read <a href="https://github.com/bitcoin/bips/blob/master/bip-0009.mediawiki">BIP9</a>.</td></tr>
<tr><td>hashPrevBlock</td><td>uint256</td><td><a href="concepts/./glossary.html#hashing">Double SHA256 hash</a> of previous block header.</td></tr>
<tr><td>hashMerkleRoot</td><td>uint256</td><td><a href="concepts/./glossary.html#hashing">Double SHA256 hash</a> of merkle root of transaction <a href="concepts/./glossary.html#merkle-trees">merkle tree</a>.</td></tr>
<tr><td>nTime</td><td>uint32_t</td><td>Unix time of when the miner started hashing the header (according to the miner). Must be strictly greater than the median time of the previous 11 blocks.</td></tr>
<tr><td>nBits</td><td>uint32_t</td><td>Used for PoS mining. An encoded version of the target threshold this block’s header hash must be less than or equal to.</td></tr>
<tr><td><del>deprecatedHeight</del><strong>*</strong></td><td>uint64_t</td><td>[<strong>*No longer in use</strong>] Block height of the current block. Block height is tracked by <code>CBlockIndex</code> instead of block headers themselves, this remains in the block header for compatibility with previous versions of the node. Removal of this field would require a <a href="https://en.wikipedia.org/wiki/Fork_(blockchain)#Hard_fork">hard fork</a>.</td></tr>
<tr><td>mintedBlocks</td><td>uint64_t</td><td>Number of blocks this masternode has mined.</td></tr>
<tr><td>stakeModifier</td><td>uint256</td><td>A stake modifier is a collective source of random entropy for PoS mining. It is equal to <code>SHA256({previous stake modifier}, {masternode ID}).</code></td></tr>
<tr><td>sig</td><td>vector<unsigned char></td><td>Signed digest block header using miner's public key.</td></tr>
</tbody></table>
<h2 id="block-body"><a class="header" href="#block-body">Block Body</a></h2>
<p>The block body consists of</p>
<ul>
<li>a list of pointers which map to transactions</li>
<li>a local variable <code>fChecked</code> (not shared between nodes) to track if the block has been successfully validated previously</li>
</ul>
<p>The list of transactions has type <code>vector&lt;CTransactionRef&gt;</code>, and each <code>CTransactionRef</code> points to a <a href="https://github.com/DeFiCh/ain/blob/master/src/primitives/transaction.h#L210"><code>CTransaction</code></a>. The contents of each Transaction as well as the different types of Transactions are detailed in the <a href="concepts/./transaction.html">Transactions document</a>.</p>
<h2 id="external-resources"><a class="header" href="#external-resources">External Resources</a></h2>
<ul>
<li><a href="https://developer.bitcoin.org/reference/block_chain.html">Bitcoin Block Reference</a></li>
<li><a href="https://www.datadriveninvestor.com/2019/11/21/a-decomposition-of-the-bitcoin-block-header/">A Decomposition Of The Bitcoin Block Header</a></li>
<li><a href="https://en.bitcoin.it/wiki/Protocol_documentation">Bitcoin Protocol Documentation</a></li>
<li><a href="https://en.wikipedia.org/wiki/Fork_(blockchain)">Blockchain Forking</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="transactions"><a class="header" href="#transactions">Transactions</a></h1>
<p>Transactions</p>
<ul>
<li>are used to transfer DFI and dTokens</li>
<li>have inputs and outputs</li>
<li>difference between inputs and outputs is considered a <em>transaction fee</em></li>
<li><strong>not</strong> encrypted</li>
<li>identified by their <a href="concepts/./glossary.html#hashing">SHA256 hashes</a></li>
</ul>
<p><a href="concepts/./customtx.html">Custom Transactions</a> also exist to interact with dApps such as the DeX and Loans.</p>
<h2 id="transaction-format"><a class="header" href="#transaction-format">Transaction Format</a></h2>
<p>Block bodies contain <a href="https://github.com/DeFiCh/ain/blob/master/src/primitives/transaction.h#L210"><code>CTransaction</code></a> which have the following structure:</p>
<table><thead><tr><th>Name</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>nVersion</td><td>int32_t</td><td>Currently <code>4</code>.</td></tr>
<tr><td>vin</td><td>vector<CTxIn></td><td>List of input transactions.</td></tr>
<tr><td>vout</td><td>vector<CTxOut></td><td>List of output transactions.</td></tr>
<tr><td>nLockTime</td><td>uint32_t</td><td>Block height or timestamp when transaction is final</td></tr>
<tr><td>hash</td><td>uint256</td><td>Hash of transaction without witness data.</td></tr>
<tr><td>m_witness_hash</td><td>uint256</td><td>Hash of transaction with witness data.</td></tr>
</tbody></table>
<p><code>CTxIn</code> is an input transaction, and has the following structure:</p>
<table><thead><tr><th>Name</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>prevout</td><td>COutPoint</td><td>Hash and index of transaction holding the output to spend.</td></tr>
<tr><td>scriptSig</td><td>CScript</td><td>Transaction unlocking script.</td></tr>
<tr><td>nSequence</td><td>uint32_t</td><td>Sequence number. Defaults to 0xFFFFFFFE.</td></tr>
<tr><td>scriptWitness</td><td>CScriptWitness</td><td>Witness data for this input transaction.</td></tr>
</tbody></table>
<p>Similar to Bitcoin's script system, a <code>scriptPubKey</code> must be able to unlock the respective <code>scriptSig</code>.</p>
<p>Each non-coinbase input spends an outpoint (<code>COutPoint</code>) from a previous transaction. Coinbase transactions set <code>prevout</code> to <code>null</code>, and encode the block height in <code>scriptSig</code>.</p>
<p><code>CTxOut</code> is the output of the current transaction, and has the following structure:</p>
<table><thead><tr><th>Name</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>nValue</td><td>CAmount</td><td>Amount of DFI to spend.</td></tr>
<tr><td>scriptPubKey</td><td>CScript</td><td>Defines the conditions which must be satisfied to spend this output.</td></tr>
<tr><td>nTokenId</td><td>DCT_ID</td><td>ID of token transferred. DFI has ID 0.</td></tr>
</tbody></table>
<h2 id="coinbase-transaction"><a class="header" href="#coinbase-transaction">Coinbase Transaction</a></h2>
<p>Coinbase transactions have the following properties</p>
<ul>
<li>it is the first transaction in a block</li>
<li>there can only be one coinbase transaction per block</li>
<li>creates new DFI in mining masternode's wallet</li>
</ul>
<p>The base block reward is split into 6 different recipients. Recipients marked with UTXO are the only outputs present in the coinbase transaction.</p>
<table><thead><tr><th>Recipient</th><th>Coinbase allocation</th><th>Description</th></tr></thead><tbody>
<tr><td>Masternode (UTXO)</td><td>33.33%</td><td>Masternode rewards. Masternode also receives additional income from transaction fees.</td></tr>
<tr><td>Community Fund (UTXO)</td><td>4.91%</td><td>Community fund controlled by the Foundation, used to finance DeFiChain initiatives. <a href="https://github.com/DeFiCh/dfips">ref</a></td></tr>
<tr><td>Anchor</td><td>0.02%</td><td>Fund to pay the Bitcoin transaction fee for anchoring.</td></tr>
<tr><td>Liquidity Pools</td><td>25.45%</td><td>Distributed to LP providers as incentive.</td></tr>
<tr><td>Loans</td><td>24.68%</td><td>Incentives for atomic swap and DeFiChain futures.</td></tr>
<tr><td>Options</td><td>9.88%</td><td>Distributed to options holders. Not in use currently.</td></tr>
<tr><td>Unallocated</td><td>1.73%</td><td>N/A</td></tr>
</tbody></table>
<h2 id="external-resources-1"><a class="header" href="#external-resources-1">External Resources</a></h2>
<ul>
<li><a href="https://en.bitcoin.it/wiki/Script">Bitcoin Script</a></li>
<li><a href="https://www.mycryptopedia.com/scriptpubkey-scriptsig/">scriptPubKey &amp; scriptSig Explained</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="custom-transactions"><a class="header" href="#custom-transactions">Custom Transactions</a></h1>
<p>Custom Transactions are special transactions to interact with dApps on DeFiChain, such as Vaults and the DeX.</p>
<p>Custom transaction can be identified by the first <code>vout</code> of a transaction</p>
<ul>
<li>begin with a <code>OP_RETURN</code></li>
<li>followed by a <code>DfTx</code> marker (serialized in UTF as <code>44665478</code>)</li>
<li>followed by one character marker denoting the type of transaction (serialized in UTF), conversion table <a href="https://github.com/DeFiCh/ain/blob/9911c9032b33576143e3ce658540978d9393bd05/src/masternodes/mn_checks.h#L37-L107">here</a></li>
<li>followed by custom transaction data, if required</li>
</ul>
<p>For example, in the following custom transaction</p>
<pre><code class="language-json">&quot;vout&quot;: [
{
    &quot;value&quot;: 0.00000000,
    &quot;n&quot;: 0,
    &quot;scriptPubKey&quot;: {
    &quot;asm&quot;: &quot;OP_RETURN 446654784301d823ad3976574a50001f4ca5a5326a1c1232a0a70000&quot;,
    &quot;hex&quot;: &quot;6a054466547841&quot;,
    &quot;type&quot;: &quot;nulldata&quot;
    },
    &quot;tokenId&quot;: 0
},
...
]
</code></pre>
<p>The custom transaction can be broken down to</p>
<table><thead><tr><th>asm</th><th>Meaning</th></tr></thead><tbody>
<tr><td>44665478</td><td>DfTx marker</td></tr>
<tr><td>43</td><td><code>C</code> in UTF, <a href="https://github.com/DeFiCh/ain/blob/9911c9032b33576143e3ce658540978d9393bd05/src/masternodes/mn_checks.h#L43">corresponds to CreateMasternode message</a> (<a href="https://github.com/DeFiCh/ain/blob/9911c9032b33576143e3ce658540978d9393bd05/src/masternodes/mn_checks.h#L193-L209">CCreateMasterNodeMessage</a>)</td></tr>
<tr><td>01</td><td><code>operatorType</code> variable</td></tr>
<tr><td>d823ad3976574a50001f4ca5a5326a1c1232a0a7</td><td><code>operatorAuthAddress</code> variable</td></tr>
<tr><td>0000</td><td><code>timelock</code> variable</td></tr>
</tbody></table>
<h2 id="transaction-types"><a class="header" href="#transaction-types">Transaction Types</a></h2>
<h3 id="masternodes"><a class="header" href="#masternodes">Masternodes</a></h3>
<h4 id="createmasternode"><a class="header" href="#createmasternode">CreateMasterNode</a></h4>
<p>Creates a new masternode in the network</p>
<p><em>Marker: <code>C</code></em></p>
<h5 id="message-format"><a class="header" href="#message-format">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>operatorType</td><td>char</td><td>1 for P2PKH, 4 for P2WPKH</td></tr>
<tr><td>operatorAuthAddress</td><td>CKeyID</td><td>DeFiChain address of masternode operator</td></tr>
<tr><td>timelock</td><td>uint16_t</td><td>minimum time that masternode must be active, either 0, 5 or 10 years</td></tr>
</tbody></table>
<h4 id="resignmasternode"><a class="header" href="#resignmasternode">ResignMasternode</a></h4>
<p>Removes enabled or pre-enabled masternode from network.</p>
<p><em>Marker: <code>R</code></em></p>
<h5 id="message-format-1"><a class="header" href="#message-format-1">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>nodeID</td><td>uint256</td><td>ID of masternode to resign</td></tr>
</tbody></table>
<h4 id="setforcedrewardaddress"><a class="header" href="#setforcedrewardaddress">SetForcedRewardAddress</a></h4>
<p>Sets reward address for masternode.</p>
<p><em>Marker: <code>F</code></em></p>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>nodeID</td><td>uint256</td><td>masternode ID</td></tr>
<tr><td>rewardAddressType</td><td>char</td><td>1 for P2PKH, 4 for P2WPKH</td></tr>
<tr><td>rewardAddress</td><td>CKeyID</td><td>new DeFiChain address for rewards</td></tr>
</tbody></table>
<h4 id="remforcedrewardaddress"><a class="header" href="#remforcedrewardaddress">RemForcedRewardAddress</a></h4>
<p>Removes reward address for masternode if any.</p>
<p><em>Marker: <code>f</code></em></p>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>nodeID</td><td>uint256</td><td>masternode ID</td></tr>
</tbody></table>
<h4 id="updatemasternode"><a class="header" href="#updatemasternode">UpdateMasternode</a></h4>
<p>Updates masternode metadata.</p>
<p><em>Marker: <code>m</code></em></p>
<h5 id="message-format-2"><a class="header" href="#message-format-2">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>operatorType</td><td>char</td><td>1 for P2PKH, 4 for P2WPKH</td></tr>
<tr><td>operatorAuthAddress</td><td>CKeyID</td><td>DeFiChain address of masternode operator</td></tr>
<tr><td>timelock</td><td>uint16_t</td><td>minimum time that masternode must be active, either 0, 5 or 10 years</td></tr>
</tbody></table>
<h3 id="custom-tokens"><a class="header" href="#custom-tokens">Custom Tokens</a></h3>
<h4 id="createtoken"><a class="header" href="#createtoken">CreateToken</a></h4>
<p>Creates new custom token.</p>
<p><em>Marker: <code>T</code></em></p>
<h5 id="message-format-3"><a class="header" href="#message-format-3">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>token</td><td>CToken</td><td>token definition</td></tr>
</tbody></table>
<p>Class <code>CToken</code> has the following structure</p>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>symbol</td><td>string</td><td>token ticker</td></tr>
<tr><td>name</td><td>string</td><td>name of token</td></tr>
<tr><td>decimal</td><td>uint8_t</td><td>how divisible a token can be, fixed to <code>8</code></td></tr>
<tr><td>limit</td><td>CAmount</td><td>deprecated</td></tr>
<tr><td>flags</td><td>uint8_t</td><td>sets options for token</td></tr>
</tbody></table>
<p>The following flags are available for a token:</p>
<table><thead><tr><th>Bit index</th><th>Flag</th></tr></thead><tbody>
<tr><td>0</td><td>None</td></tr>
<tr><td>1</td><td>Mintable</td></tr>
<tr><td>2</td><td>Tradeable</td></tr>
<tr><td>3</td><td>DeFi Asset Token (tokens backed by collateral, e.g. dBTC)</td></tr>
<tr><td>4</td><td>Liquidity Pool Share</td></tr>
<tr><td>5</td><td>Finalized</td></tr>
<tr><td>6</td><td>Loan Token</td></tr>
<tr><td>7</td><td>Unused</td></tr>
</tbody></table>
<p>Tokens are mintable and tradeable by default.</p>
<h4 id="minttoken"><a class="header" href="#minttoken">MintToken</a></h4>
<p>Mints new custom tokens.</p>
<p><em>Marker: <code>M</code></em></p>
<h5 id="message-format-4"><a class="header" href="#message-format-4">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>balances</td><td>CBalances</td><td>amount and type of token to mint</td></tr>
</tbody></table>
<h4 id="updatetoken"><a class="header" href="#updatetoken">UpdateToken</a></h4>
<p>Set DAT flag for a token to true or false. <strong>Deprecated.</strong></p>
<p><em>Marker: <code>N</code></em></p>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>tokenTx</td><td>uint256</td><td>CreateToken transaction for a custom token</td></tr>
<tr><td>isDAT</td><td>bool</td><td>is token a DAT</td></tr>
</tbody></table>
<h4 id="updatetokenany"><a class="header" href="#updatetokenany">UpdateTokenAny</a></h4>
<p>Update a token, supports all fields in CToken.</p>
<p><em>Marker: <code>n</code></em></p>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>balances</td><td>CBalances</td><td>amount and type of token to mint</td></tr>
</tbody></table>
<h3 id="dex"><a class="header" href="#dex">DeX</a></h3>
<h4 id="createpoolpair"><a class="header" href="#createpoolpair">CreatePoolPair</a></h4>
<p>Create new liquidity pool.</p>
<p><em>Marker: <code>p</code></em></p>
<h5 id="message-format-5"><a class="header" href="#message-format-5">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>poolPair</td><td>CPoolPairMessage</td><td>metadata for liquidity pool</td></tr>
<tr><td>pairSymbol</td><td>string</td><td>name of liquidity pool</td></tr>
<tr><td>rewards</td><td>CBalances</td><td>percentage of coinbase liquidity rewards allocated to pool</td></tr>
</tbody></table>
<p><code>CPoolPairMessage</code> has the following message structure:</p>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>idTokenA</td><td>DCT_ID</td><td>token ID for first token in LP</td></tr>
<tr><td>idTokenB</td><td>string</td><td>token ID for second token in LP</td></tr>
<tr><td>commission</td><td>CAmount</td><td>define fees for swap</td></tr>
<tr><td>ownerAddress</td><td>CScript</td><td>owner of DeX pool</td></tr>
<tr><td>status</td><td>bool</td><td>pool status (active/inactive)</td></tr>
</tbody></table>
<h4 id="updatepoolpair"><a class="header" href="#updatepoolpair">UpdatePoolPair</a></h4>
<p>Update a liquidity pool.</p>
<p><em>Marker: <code>u</code></em></p>
<h5 id="message-format-6"><a class="header" href="#message-format-6">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>poolId</td><td>DCT_ID</td><td>pool ID</td></tr>
<tr><td>status</td><td>bool</td><td>set pool status (active/inactive)</td></tr>
<tr><td>commission</td><td>CAmount</td><td>define fees for swap</td></tr>
<tr><td>ownerAddress</td><td>CScript</td><td>owner of DeX pool</td></tr>
<tr><td>rewards</td><td>CBalances</td><td>percentage of coinbase liquidity rewards allocated to pool P2WPKH</td></tr>
</tbody></table>
<h4 id="poolswap"><a class="header" href="#poolswap">PoolSwap</a></h4>
<p>Swap tokens using a liqidity pool. <strong>Deprecated.</strong></p>
<p><em>Marker: <code>s</code></em></p>
<h5 id="message-format-7"><a class="header" href="#message-format-7">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>from</td><td>CScript</td><td>transaction input</td></tr>
<tr><td>to</td><td>CScript</td><td>transaction output</td></tr>
<tr><td>idTokenFrom</td><td>DCT_ID</td><td>input token ID</td></tr>
<tr><td>idTokenTo</td><td>DCT_ID</td><td>output token ID</td></tr>
<tr><td>amountFrom</td><td>CAmount</td><td>amount of tokens to swap</td></tr>
<tr><td>maxPrice</td><td>PoolPrice</td><td>maximum possible price</td></tr>
</tbody></table>
<h4 id="poolswapv2"><a class="header" href="#poolswapv2">PoolSwapV2</a></h4>
<p>Swap tokens using a liqidity pool. Has 16 digits precision instead of 8 in V1.</p>
<p><em>Marker: <code>i</code></em></p>
<h5 id="message-format-8"><a class="header" href="#message-format-8">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>swapInfo</td><td>CPoolSwapMessage</td><td>swap metadata (contents of V1 message)</td></tr>
<tr><td>poolIDs</td><td>vector&lt;DCT_ID&gt;</td><td>IDs of pools to swap with</td></tr>
</tbody></table>
<h4 id="addpoolliquidity"><a class="header" href="#addpoolliquidity">AddPoolLiquidity</a></h4>
<p>Mint LP tokens and add liquidity to a liquidity pool.</p>
<p><em>Marker: <code>l</code></em></p>
<h5 id="message-format-9"><a class="header" href="#message-format-9">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>from</td><td>CAccounts</td><td>dToken input</td></tr>
<tr><td>shareAddress</td><td>CScript</td><td>address for LP rewards</td></tr>
</tbody></table>
<h4 id="removepoolliquidity"><a class="header" href="#removepoolliquidity">RemovePoolLiquidity</a></h4>
<p>Redeem LP tokens and withdraw liquidity from a liquidity pool.</p>
<p><em>Marker: <code>r</code></em></p>
<h5 id="message-format-10"><a class="header" href="#message-format-10">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>from</td><td>CAccounts</td><td>LP token input</td></tr>
<tr><td>amount</td><td>CTokenAmount</td><td>withdrawal amount</td></tr>
</tbody></table>
<h3 id="accounts"><a class="header" href="#accounts">Accounts</a></h3>
<h4 id="utxostoaccount"><a class="header" href="#utxostoaccount">UtxosToAccount</a></h4>
<p>Spend UTXOs from a wallet and transfer tokens to to any DeFiChain address.</p>
<p><em>Marker: <code>U</code></em></p>
<h5 id="message-format-11"><a class="header" href="#message-format-11">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>to</td><td>CAccounts</td><td>account and amount of tokens to send</td></tr>
</tbody></table>
<h4 id="accounttoutxos"><a class="header" href="#accounttoutxos">AccountToUtxos</a></h4>
<p>Creates UTXO from a wallet account.</p>
<p><em>Marker: <code>b</code></em></p>
<h5 id="message-format-12"><a class="header" href="#message-format-12">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>from</td><td>CScript</td><td>UTXOs to spend</td></tr>
<tr><td>balances</td><td>CBalances</td><td>amount of DFI to send</td></tr>
<tr><td>mintingOutputsStart</td><td>uint32_t</td><td>number of transaction outputs</td></tr>
</tbody></table>
<h4 id="accounttoaccount"><a class="header" href="#accounttoaccount">AccountToAccount</a></h4>
<p>Transfer tokens between a wallet and any DeFiChain address.</p>
<p><em>Marker: <code>B</code></em></p>
<h5 id="message-format-13"><a class="header" href="#message-format-13">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>from</td><td>CScript</td><td>UTXOs to spend</td></tr>
<tr><td>to</td><td>CBalances</td><td>account to send tokens to</td></tr>
</tbody></table>
<h4 id="anyaccountstoaccounts"><a class="header" href="#anyaccountstoaccounts">AnyAccountsToAccounts</a></h4>
<p>Transfer tokens from any DeFiChain address to any DeFiChain address.</p>
<p><em>Marker: <code>a</code></em></p>
<h5 id="message-format-14"><a class="header" href="#message-format-14">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>from</td><td>CScript</td><td>UTXOs to spend</td></tr>
<tr><td>to</td><td>CBalances</td><td>account to send tokens to</td></tr>
</tbody></table>
<h4 id="smartcontract"><a class="header" href="#smartcontract">SmartContract</a></h4>
<p>Interact with DFIP2201 contract.</p>
<p><em>Marker: <code>K</code></em></p>
<h5 id="message-format-15"><a class="header" href="#message-format-15">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>name</td><td>string</td><td>name of the smart contract</td></tr>
<tr><td>accounts</td><td>CAccounts</td><td>account and amount of tokens to send</td></tr>
</tbody></table>
<h4 id="dfip2203"><a class="header" href="#dfip2203">DFIP2203</a></h4>
<p>Interact with DFIP2203 (Futures) contract.</p>
<p><em>Marker: <code>Q</code></em></p>
<h5 id="message-format-16"><a class="header" href="#message-format-16">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>owner</td><td>CScript</td><td>address to fund contract and recieve token</td></tr>
<tr><td>source</td><td>CTokenAmount</td><td>amount of tokens to fund future contract</td></tr>
<tr><td>destination</td><td>uint32_t</td><td>set underlying asset (if source id DUSD)</td></tr>
<tr><td>withdraw</td><td>bool</td><td>withdraw asset to owner address</td></tr>
</tbody></table>
<h3 id="governance"><a class="header" href="#governance">Governance</a></h3>
<h4 id="setgovvariable"><a class="header" href="#setgovvariable">SetGovVariable</a></h4>
<p>Update governance variables.</p>
<p><em>Marker: <code>G</code></em></p>
<h5 id="message-format-17"><a class="header" href="#message-format-17">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>govs</td><td>map&lt;shared_ptr<GovVariable>&gt;</td><td>list of variables and values to update</td></tr>
</tbody></table>
<h4 id="setgovvariableheight"><a class="header" href="#setgovvariableheight">SetGovVariableHeight</a></h4>
<p>Set one governance variable at a particular block height.</p>
<p><em>Marker: <code>j</code></em></p>
<h5 id="message-format-18"><a class="header" href="#message-format-18">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>govs</td><td>shared_ptr<GovVariable></td><td>variable name and value to update</td></tr>
<tr><td>startHeight</td><td>uint32_t</td><td>height at which change is in effect</td></tr>
</tbody></table>
<h3 id="authorisation"><a class="header" href="#authorisation">Authorisation</a></h3>
<h4 id="autoauthprep"><a class="header" href="#autoauthprep">AutoAuthPrep</a></h4>
<p>This is an empty custom transaction.</p>
<p><em>Marker: <code>A</code></em></p>
<h3 id="oracles"><a class="header" href="#oracles">Oracles</a></h3>
<h4 id="appointoracle"><a class="header" href="#appointoracle">AppointOracle</a></h4>
<p>Create new oracle at an address.</p>
<p><em>Marker: <code>o</code></em></p>
<h4 id="message-format-19"><a class="header" href="#message-format-19">Message Format</a></h4>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>oracleAddress</td><td>CScript</td><td>address of new oracle</td></tr>
<tr><td>weightage</td><td>uint8_t</td><td>oracle weightage</td></tr>
<tr><td>availablePairs</td><td>set<CTokenCurrencyPair></td><td>set of token prices available</td></tr>
</tbody></table>
<h4 id="removeoracleappoint"><a class="header" href="#removeoracleappoint">RemoveOracleAppoint</a></h4>
<p>Remove existing oracle.</p>
<p><em>Marker: <code>h</code></em></p>
<h4 id="message-format-20"><a class="header" href="#message-format-20">Message Format</a></h4>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>oracleId</td><td>COracleId</td><td>oracle ID</td></tr>
</tbody></table>
<h4 id="updateoracleappoint"><a class="header" href="#updateoracleappoint">UpdateOracleAppoint</a></h4>
<p>Update existing oracle.</p>
<p><em>Marker: <code>t</code></em></p>
<h4 id="message-format-21"><a class="header" href="#message-format-21">Message Format</a></h4>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>oracleId</td><td>COracleId</td><td>oracle ID</td></tr>
<tr><td>newOracleAppoint</td><td>CAppointOracleMessage</td><td>new oracle metadata (contents of AppointOracle message)</td></tr>
</tbody></table>
<h4 id="setoracledata"><a class="header" href="#setoracledata">SetOracleData</a></h4>
<p>Update oracle prices.</p>
<p><em>Marker: <code>y</code></em></p>
<h4 id="message-format-22"><a class="header" href="#message-format-22">Message Format</a></h4>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>oracleId</td><td>COracleId</td><td>oracle ID</td></tr>
<tr><td>timestamp</td><td>int64_t</td><td>timestamp of oracle data</td></tr>
<tr><td>prices</td><td>CTokenPrices</td><td>array of price and token strings</td></tr>
</tbody></table>
<h3 id="interchain-exchange-icx"><a class="header" href="#interchain-exchange-icx">Interchain Exchange (ICX)</a></h3>
<p><em>ICX is currently disabled on the mainnet.</em></p>
<h4 id="icxcreateorder"><a class="header" href="#icxcreateorder">ICXCreateOrder</a></h4>
<p>Create ICX order.</p>
<p><em>Marker: <code>1</code></em></p>
<h4 id="message-format-23"><a class="header" href="#message-format-23">Message Format</a></h4>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>orderType</td><td>uint8_t</td><td>is maker buying or selling DFI</td></tr>
<tr><td>idToken</td><td>DCT_ID</td><td>token ID on DeFiChain</td></tr>
<tr><td>ownerAddress</td><td>CScript</td><td>address for funding DeFiChain transaction fees</td></tr>
<tr><td>receivePubkey</td><td>CPubKey</td><td>public key which can claim external HTLC</td></tr>
<tr><td>amountFrom</td><td>CAmount</td><td>amount of asset to be sold</td></tr>
<tr><td>amountToFill</td><td>CAmount</td><td>amount of tokens in order available to fill</td></tr>
<tr><td>orderPrice</td><td>CAmount</td><td>quoted price of asset</td></tr>
<tr><td>expiry</td><td>uint32_t</td><td>block height for order expiry</td></tr>
</tbody></table>
<h4 id="icxmakeoffer"><a class="header" href="#icxmakeoffer">ICXMakeOffer</a></h4>
<p>Make an offer for an ICX order.</p>
<p><em>Marker: <code>2</code></em></p>
<h4 id="message-format-24"><a class="header" href="#message-format-24">Message Format</a></h4>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>orderTx</td><td>uint256</td><td>transaction ID of order</td></tr>
<tr><td>amount</td><td>CAmount</td><td>amount of asset to swap</td></tr>
<tr><td>ownerAddress</td><td>CScript</td><td>address for funding DeFiChain transaction fees</td></tr>
<tr><td>receivePubkey</td><td>CPubKey</td><td>public key which can claim external HTLC</td></tr>
<tr><td>expiry</td><td>uint32_t</td><td>block height for order expiry</td></tr>
<tr><td>takerFee</td><td>CAmount</td><td>taker fee</td></tr>
</tbody></table>
<h4 id="icxsubmitdfchtlc"><a class="header" href="#icxsubmitdfchtlc">ICXSubmitDFCHTLC</a></h4>
<p>Submit a DFI hash time lock contract (HTLC) for offer.</p>
<p><em>Marker: <code>3</code></em></p>
<h4 id="message-format-25"><a class="header" href="#message-format-25">Message Format</a></h4>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>offerTx</td><td>uint256</td><td>transaction ID of offer</td></tr>
<tr><td>amount</td><td>CAmount</td><td>amount to put in HTLC</td></tr>
<tr><td>hash</td><td>uint256</td><td>hash of seed used for the hash lock</td></tr>
<tr><td>timeout</td><td>uint32_t</td><td>timeout for expiration of HTLC in DeFiChain blocks</td></tr>
</tbody></table>
<h4 id="icxsubmitexthtlc"><a class="header" href="#icxsubmitexthtlc">ICXSubmitEXTHTLC</a></h4>
<p>Submit a BTC hash time lock contract (HTLC) for offer.</p>
<p><em>Marker: <code>4</code></em></p>
<h4 id="message-format-26"><a class="header" href="#message-format-26">Message Format</a></h4>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>offerTx</td><td>uint256</td><td>transaction ID of offer</td></tr>
<tr><td>amount</td><td>CAmount</td><td>amount to put in HTLC</td></tr>
<tr><td>hash</td><td>uint256</td><td>hash of seed used for the hash lock</td></tr>
<tr><td>htlcscriptAddress</td><td>string</td><td>script address of external htlc</td></tr>
<tr><td>ownerPubkey</td><td>CPubKey</td><td>refund address in case of HTLC timeout</td></tr>
<tr><td>timeout</td><td>uint32_t</td><td>timeout for expiration of HTLC in DeFiChain blocks</td></tr>
</tbody></table>
<h4 id="icxclaimdfchtlc"><a class="header" href="#icxclaimdfchtlc">ICXClaimDFCHTLC</a></h4>
<p>Claim a DFI HTLC.</p>
<p><em>Marker: <code>5</code></em></p>
<h4 id="message-format-27"><a class="header" href="#message-format-27">Message Format</a></h4>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>dfchtlcTx</td><td>uint256</td><td>transaction ID of DeFiChain HTLC</td></tr>
<tr><td>seed</td><td>vector<unsigned char></td><td>secret seed for claiming HTLC</td></tr>
</tbody></table>
<h4 id="icxcloseorder"><a class="header" href="#icxcloseorder">ICXCloseOrder</a></h4>
<p>Close an ICX order.</p>
<p><em>Marker: <code>6</code></em></p>
<h4 id="message-format-28"><a class="header" href="#message-format-28">Message Format</a></h4>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>orderTx</td><td>uint256</td><td>transaction ID of ICX order</td></tr>
</tbody></table>
<h4 id="icxcloseoffer"><a class="header" href="#icxcloseoffer">ICXCloseOffer</a></h4>
<p>Close an ICX offer.</p>
<p><em>Marker: <code>7</code></em></p>
<h4 id="message-format-29"><a class="header" href="#message-format-29">Message Format</a></h4>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>offerTx</td><td>uint256</td><td>transaction ID of ICX offer</td></tr>
</tbody></table>
<h3 id="loans"><a class="header" href="#loans">Loans</a></h3>
<h4 id="setloancollateraltoken"><a class="header" href="#setloancollateraltoken">SetLoanCollateralToken</a></h4>
<p>Sets what tokens are allowed as collateral.</p>
<p><em>Marker: <code>c</code></em></p>
<h5 id="message-format-30"><a class="header" href="#message-format-30">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>idToken</td><td>DCT_ID</td><td>token ID</td></tr>
<tr><td>factor</td><td>CAmount</td><td>minimum collateralization ratio</td></tr>
<tr><td>fixedIntervalPriceId</td><td>CTokenCurrencyPair</td><td>oracle price for current loan period</td></tr>
<tr><td>activateAfterBlock</td><td>uint32_t</td><td>block number at which change will be activated</td></tr>
</tbody></table>
<h4 id="setloantoken"><a class="header" href="#setloantoken">SetLoanToken</a></h4>
<p>Sets loan token.</p>
<p><em>Marker: <code>g</code></em></p>
<h5 id="message-format-31"><a class="header" href="#message-format-31">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>symbol</td><td>string</td><td>ticker for loan token</td></tr>
<tr><td>name</td><td>string</td><td>name of loan token</td></tr>
<tr><td>fixedIntervalPriceId</td><td>CTokenCurrencyPair</td><td>oracle price for current loan period</td></tr>
<tr><td>mintable</td><td>bool</td><td>token's mintable property, defaults to true</td></tr>
<tr><td>interest</td><td>CAmount</td><td>interest rate for the token</td></tr>
</tbody></table>
<h4 id="updateloantoken"><a class="header" href="#updateloantoken">UpdateLoanToken</a></h4>
<p>Update loan token.</p>
<p><em>Marker: <code>x</code></em></p>
<h5 id="message-format-32"><a class="header" href="#message-format-32">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>tokenTx</td><td>uint256</td><td>token creation tx</td></tr>
<tr><td>symbol</td><td>string</td><td>ticker for loan token</td></tr>
<tr><td>name</td><td>string</td><td>name of loan token</td></tr>
<tr><td>fixedIntervalPriceId</td><td>CTokenCurrencyPair</td><td>oracle price for current loan period</td></tr>
<tr><td>mintable</td><td>bool</td><td>token's mintable property, defaults to true</td></tr>
<tr><td>interest</td><td>CAmount</td><td>interest rate for the token</td></tr>
</tbody></table>
<h4 id="loanscheme"><a class="header" href="#loanscheme">LoanScheme</a></h4>
<p>Create a loan scheme.</p>
<p><em>Marker: <code>L</code></em></p>
<h5 id="message-format-33"><a class="header" href="#message-format-33">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>identifier</td><td>string</td><td>loan scheme identifier</td></tr>
<tr><td>updateHeight</td><td>uint64_t</td><td>block height to create scheme at</td></tr>
<tr><td>ratio</td><td>uint32_t</td><td>minimum collateralization ratio</td></tr>
<tr><td>rate</td><td>CAmount</td><td>interest rate</td></tr>
</tbody></table>
<h4 id="defaultloanscheme"><a class="header" href="#defaultloanscheme">DefaultLoanScheme</a></h4>
<p>Set default loan scheme.</p>
<p><em>Marker: <code>d</code></em></p>
<h5 id="message-format-34"><a class="header" href="#message-format-34">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>identifier</td><td>string</td><td>loan scheme identifier</td></tr>
</tbody></table>
<h4 id="destroyloanscheme"><a class="header" href="#destroyloanscheme">DestroyLoanScheme</a></h4>
<p>Delete existing loan scheme.</p>
<p><em>Marker: <code>D</code></em></p>
<h5 id="message-format-35"><a class="header" href="#message-format-35">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>identifier</td><td>string</td><td>loan scheme identifier</td></tr>
<tr><td>destroyHeight</td><td>uint64_t</td><td>block height to destroy scheme at</td></tr>
</tbody></table>
<h4 id="vault"><a class="header" href="#vault">Vault</a></h4>
<p>Create new vault.</p>
<p><em>Marker: <code>V</code></em></p>
<h5 id="message-format-36"><a class="header" href="#message-format-36">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>ownerAddress</td><td>CScript</td><td>owner of vault</td></tr>
<tr><td>schemeId</td><td>string</td><td>loan scheme to use</td></tr>
</tbody></table>
<h4 id="closevault"><a class="header" href="#closevault">CloseVault</a></h4>
<p>Close existing vault.</p>
<p><em>Marker: <code>e</code></em></p>
<h5 id="message-format-37"><a class="header" href="#message-format-37">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>vaultId</td><td>CVaultId</td><td>ID of vault</td></tr>
<tr><td>to</td><td>CScript</td><td>address to send collateral to</td></tr>
</tbody></table>
<h4 id="updatevault"><a class="header" href="#updatevault">UpdateVault</a></h4>
<p>Update existing open vault.</p>
<p><em>Marker: <code>v</code></em></p>
<h5 id="message-format-38"><a class="header" href="#message-format-38">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>vaultId</td><td>CVaultId</td><td>ID of vault</td></tr>
<tr><td>ownerAddress</td><td>CScript</td><td>owner of vault</td></tr>
<tr><td>schemeId</td><td>string</td><td>loan scheme to use</td></tr>
</tbody></table>
<h4 id="deposittovault"><a class="header" href="#deposittovault">DepositToVault</a></h4>
<p>Deposit collateral in a vault.</p>
<p><em>Marker: <code>S</code></em></p>
<h5 id="message-format-39"><a class="header" href="#message-format-39">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>vaultId</td><td>CVaultId</td><td>ID of vault</td></tr>
<tr><td>from</td><td>CScript</td><td>address funding the vault</td></tr>
<tr><td>amount</td><td>CTokenAmount</td><td>amount of tokens to deposit</td></tr>
</tbody></table>
<h4 id="withdrawfromvault"><a class="header" href="#withdrawfromvault">WithdrawFromVault</a></h4>
<p>Withdraw collateral in a vault.</p>
<p><em>Marker: <code>J</code></em></p>
<h5 id="message-format-40"><a class="header" href="#message-format-40">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>vaultId</td><td>CVaultId</td><td>ID of vault</td></tr>
<tr><td>to</td><td>CScript</td><td>address to send collateral to</td></tr>
<tr><td>amount</td><td>CTokenAmount</td><td>amount of tokens to deposit</td></tr>
</tbody></table>
<h4 id="takeloan"><a class="header" href="#takeloan">TakeLoan</a></h4>
<p>Mint loan token against a loan vault.</p>
<p><em>Marker: <code>X</code></em></p>
<h5 id="message-format-41"><a class="header" href="#message-format-41">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>vaultId</td><td>CVaultId</td><td>ID of vault</td></tr>
<tr><td>to</td><td>CScript</td><td>address to send loan tokens to</td></tr>
<tr><td>amount</td><td>CBalances</td><td>amount of loan token to mint</td></tr>
</tbody></table>
<h4 id="paybackloan"><a class="header" href="#paybackloan">PaybackLoan</a></h4>
<p>Repay an existing loan. <strong>Deprecated</strong>.</p>
<p><em>Marker: <code>H</code></em></p>
<h5 id="message-format-42"><a class="header" href="#message-format-42">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>vaultId</td><td>CVaultId</td><td>ID of vault</td></tr>
<tr><td>from</td><td>CScript</td><td>address repaying the loan</td></tr>
<tr><td>amount</td><td>CBalances</td><td>amount of loan token to repay</td></tr>
</tbody></table>
<h4 id="paybackloanv2"><a class="header" href="#paybackloanv2">PaybackLoanV2</a></h4>
<p>Repay an existing loan.</p>
<p><em>Marker: <code>k</code></em></p>
<h5 id="message-format-43"><a class="header" href="#message-format-43">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>vaultId</td><td>CVaultId</td><td>ID of vault</td></tr>
<tr><td>from</td><td>CScript</td><td>address repaying the loan</td></tr>
<tr><td>loans</td><td>map&lt;DCT_ID, CBalances&gt;</td><td>amount of loan token to repay</td></tr>
</tbody></table>
<h4 id="auctionbid"><a class="header" href="#auctionbid">AuctionBid</a></h4>
<p>Bid for an auction on a vault.</p>
<p><em>Marker: <code>I</code></em></p>
<h5 id="message-format-44"><a class="header" href="#message-format-44">Message Format</a></h5>
<table><thead><tr><th>Variable</th><th>Data Type</th><th>Description</th></tr></thead><tbody>
<tr><td>vaultId</td><td>CVaultId</td><td>ID of vault</td></tr>
<tr><td>index</td><td>uint32_t</td><td>auction index</td></tr>
<tr><td>from</td><td>CScript</td><td>address to recieve vault collateral</td></tr>
<tr><td>amount</td><td>CTokenAmount</td><td>bid amount</td></tr>
</tbody></table>
<h4 id="futureswapexecution"><a class="header" href="#futureswapexecution">FutureSwapExecution</a></h4>
<p><em>Unimplemented</em></p>
<p><em>Marker: <code>q</code></em></p>
<h4 id="futureswaprefund"><a class="header" href="#futureswaprefund">FutureSwapRefund</a></h4>
<p><em>Unimplemented</em></p>
<p><em>Marker: <code>w</code></em></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="protocol-and-network"><a class="header" href="#protocol-and-network">Protocol and Network</a></h1>
<div style="break-before: page; page-break-before: always;"></div><p><img src="pinkpaper/files/pinkpaper-banner.svg" alt="DeFiChain Pink Paper" /></p>
<p>This is a working version of the Pink Paper for <a href="https://defichain.com">DeFiChain</a>.</p>
<p>Comments and pull requests are welcomed.</p>
<h2 id="goals"><a class="header" href="#goals">Goals</a></h2>
<ol>
<li>Lay out the roadmap for DeFiChain for the next few quarters, esp. 2021/2022.</li>
<li>To form the basis of an open discussion with DeFiChain community on the direction of the project.</li>
<li>Provide a general product and design direction for the engineering team.</li>
</ol>
<h2 id="sections"><a class="header" href="#sections">Sections</a></h2>
<table><thead><tr><th>#</th><th>Topic</th><th>Remarks</th></tr></thead><tbody>
<tr><td>1</td><td><a href="pinkpaper/README.html">Introduction</a></td><td>This document.</td></tr>
<tr><td>2</td><td><a href="pinkpaper//emission">Emission rate</a></td><td>Under implementation. Targeting May 2021 upgrade.</td></tr>
<tr><td>3</td><td><a href="pinkpaper//governance">Governance</a></td><td>Also community development fund management. <br> Under implementation. Targeting May 2021 upgrade.</td></tr>
<tr><td>4</td><td><a href="pinkpaper//price-oracle">Price oracle</a></td><td>Under implementation. Targeting May 2021 upgrade.</td></tr>
<tr><td>5</td><td><a href="pinkpaper//interchain-exchange">Interchain exchange (ICX)</a></td><td>Also Bitcoin atomic swap. Under implementation. Targeting May 2021 upgrade.</td></tr>
<tr><td>6</td><td><a href="pinkpaper//fees">Fees</a></td><td>Draft. Partial implementation.</td></tr>
<tr><td>7</td><td><a href="pinkpaper//futures">Futures</a></td><td>Early draft.</td></tr>
<tr><td>8</td><td><a href="pinkpaper//operator">Operator</a></td><td>Early draft.</td></tr>
<tr><td>9</td><td>Loan &amp; decentralized tokenization</td><td>Early draft.</td></tr>
<tr><td>10</td><td>Automated options</td><td>Early draft.</td></tr>
<tr><td>11</td><td>Non-Fungible Token (NFT)</td><td>Early draft.</td></tr>
</tbody></table>
<h4 id="see-also"><a class="header" href="#see-also">See also</a></h4>
<ul>
<li><a href="pinkpaper//files/2021-03-30%20DeFiChain%20PinkPaper%20Overview.pdf">Presentation deck on 2021-03-30</a></li>
</ul>
<h2 id="disclaimers"><a class="header" href="#disclaimers">Disclaimers</a></h2>
<ol>
<li>Content may be updated without notice.</li>
<li>Content does not guarantee implementation and does not imply implementation order.</li>
<li>Actual implementation may differ from the paper.</li>
<li>This my no means signify acceptance by the DeFiChain users and masternode owners.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dfi-emission-rate"><a class="header" href="#dfi-emission-rate">DFI emission rate</a></h1>
<h2 id="current"><a class="header" href="#current">Current</a></h2>
<p>From <a href="https://defichain.com/white-paper/#dfi-coin">white-paper</a>:</p>
<blockquote>
<p>DeFiChain is initially launched with a 200 DFI block reward, of which 10% goes to the community fund. The Foundation pledges to guarantee this 200 DFI block reward for at least 1,050,000 blocks since the the first genesis block, so approximately 1 year.</p>
</blockquote>
<p>The white paper lays out the expectation for the first year that the block reward is flat at 200 DFI. </p>
<p>2 DFIPs have since been made and implemented that affected the allocation of the 200 DFI, while the total emission remains consistent at 200 DFI.</p>
<ul>
<li><a href="https://github.com/DeFiCh/dfips/issues/1">DFIP #1: Bitcoin anchor reward source and mechanics adjustments</a> where 0.1 DFI is reduced from community fund to cater for anchor reward</li>
<li><a href="https://github.com/DeFiCh/dfips/issues/2">DFIP #2: DeFi incentive funding</a> where the original 180 DFI per block mining reward is reduced to 135 DFI </li>
</ul>
<p>To keep the total supply of DFI capped at 1.2 billion, the emission rate of DFI cannot stay consistent forever and will have to be reduced over time.</p>
<h2 id="foundation-and-community-fund"><a class="header" href="#foundation-and-community-fund">Foundation and Community Fund</a></h2>
<p>To further decentralize the governance of DeFiChain, the Foundation's role must be diminished significantly, and should not be holding any DFI. As such, it is proposed for the Foundation tokens to be burned entirely so no individuals or entities hold the private keys to the Foundation's DFI.</p>
<p>Community Fund today accumulates at 19.9 DFI per block and requires community funding proposal (CFP) to be made and votes to be called for the fund to be <em>manually</em> released. </p>
<p>Community Fund should be removed from address with private key to consensus-managed on-chain voting.</p>
<h2 id="emission-rate"><a class="header" href="#emission-rate">Emission rate</a></h2>
<h3 id="goals-1"><a class="header" href="#goals-1">Goals</a></h3>
<ol>
<li>Maintain the same emission rate on the first cycle.</li>
<li>Avoid the dramatic &quot;halving&quot; like Bitcoin's.</li>
<li>Maintain the 1.2 billion DFI cap.</li>
<li>Maintain a steady expected emission rate for foreseeable future.</li>
</ol>
<h3 id="current-rate"><a class="header" href="#current-rate">Current rate</a></h3>
<p>The current emission rate of DFI is 258.1 DFI per block – some of it are funded by airdrop fund.</p>
<table><thead><tr><th>Description</th><th>DFI per block</th></tr></thead><tbody>
<tr><td>Mining reward</td><td>135</td></tr>
<tr><td>Community fund</td><td>19.9</td></tr>
<tr><td>Anchor reward</td><td>0.1</td></tr>
<tr><td><em>DeFi incentives</em></td><td></td></tr>
<tr><td>BTC-DFI</td><td>80</td></tr>
<tr><td>ETH-DFI</td><td>15</td></tr>
<tr><td>USDT-DFI</td><td>5</td></tr>
<tr><td>LTC-DFI</td><td>2</td></tr>
<tr><td>BCH-DFI</td><td>1</td></tr>
<tr><td>DOGE-DFI</td><td>0.1</td></tr>
<tr><td><strong>TOTAL</strong></td><td>258.1</td></tr>
</tbody></table>
<p>The same rate will be retained on the first cycle. </p>
<p>On top of the above, the following will also be pre-allocated on the first cycle:</p>
<table><thead><tr><th>Description</th><th>In use today?</th><th>DFI per block</th><th>Proportion</th></tr></thead><tbody>
<tr><td>Mining reward</td><td>Yes</td><td>135</td><td>33.33% (guaranteed)</td></tr>
<tr><td>Community fund</td><td>Yes</td><td>19.9</td><td>4.91%</td></tr>
<tr><td>Anchor reward</td><td>Yes</td><td>0.1</td><td>0.02%</td></tr>
<tr><td>DEX liquidity mining</td><td>Yes</td><td>103.1</td><td>25.45%</td></tr>
<tr><td>Atomic swap incentives</td><td>No</td><td>50</td><td>12.34%</td></tr>
<tr><td>Futures incentives</td><td>No</td><td>50</td><td>12.34%</td></tr>
<tr><td>Options incentives</td><td>No</td><td>40</td><td>9.88%</td></tr>
<tr><td>Unallocated incentives</td><td>No</td><td>6.94</td><td>1.71%</td></tr>
<tr><td><strong>TOTAL</strong></td><td></td><td>405.04</td><td>100%</td></tr>
</tbody></table>
<h3 id="cycle--reduction"><a class="header" href="#cycle--reduction">Cycle &amp; Reduction</a></h3>
<p>Emission rate will start at 405.04 DFI on the first cycle so that it flows smoothly with no change before the implementation. The increment on the first cycle is coming from the <a href="https://github.com/DeFiCh/dfips/issues/17">destruction of Foundation-owned DFI</a>.</p>
<p>Cycle period is 32,690 blocks, at 37 seconds per block, each cycle takes approximately 2 weeks. </p>
<p>Every cycle, the block reward reduces by 1.658%. The splitting of the rewards for respective incentives will be maintained at the same proportion as laid out on the schedule above.</p>
<p>Unused reward will be burned. Burned rewards will not be re-introduced, therefore counted towards the 1.2 billion supply cap.</p>
<p>Rewards proposed may be adjusted with future on-chain governance changes, however, masternode (mining) rewards are guaranteed to be 33.33% of the total block reward.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fees-on-defichain"><a class="header" href="#fees-on-defichain">Fees on DeFiChain</a></h1>
<p>Usage of DeFiChain generally consists of the following fees:</p>
<ol>
<li>Miner fee</li>
<li>Operator fee</li>
<li>DeFi fee</li>
</ol>
<h2 id="miner-fee"><a class="header" href="#miner-fee">Miner fee</a></h2>
<p>Miner fee is the small fee, paid in UTXO DFI, to masternodes (also referred to as miners) for transaction validation and inclusion in a block.</p>
<p>This works the same as Bitcoin blockchain, measured in data size, e.g. price per byte.</p>
<h2 id="operator-fee"><a class="header" href="#operator-fee">Operator fee</a></h2>
<p>As part of DeFiChain generalization, many services will soon be run by <a href="pinkpaper/fees/../operator">operators</a>.</p>
<p>For providing of services and applications on DeFiChain, operators are able to determine fees for the services that they would charge freely. Fees can be in any form of tokens, DFI or operators' own tokens, or a combination of multiple tokens. What an operator chooses to do with the operator fee is at the operator's discretion.</p>
<h2 id="defi-fee"><a class="header" href="#defi-fee">DeFi fee</a></h2>
<p>DeFi fee is charged for all DeFi transactions on DeFiChain regardless of operators.</p>
<h3 id="fee-schedule"><a class="header" href="#fee-schedule">Fee schedule</a></h3>
<p>All fees are burned in a trackable and transparent manner.</p>
<p>The following fees are for illustrative purposes only and have yet to be fully determined.</p>
<table><thead><tr><th>Operations</th><th style="text-align: right">Burn amount (in DFI)</th></tr></thead><tbody>
<tr><td><strong>Masternode</strong></td><td style="text-align: right"></td></tr>
<tr><td>Registration</td><td style="text-align: right">10</td></tr>
<tr><td><strong>Operator</strong></td><td style="text-align: right"></td></tr>
<tr><td>Registration</td><td style="text-align: right">1000</td></tr>
<tr><td><strong>Tokenization</strong></td><td style="text-align: right"></td></tr>
<tr><td>Create a new token</td><td style="text-align: right">100</td></tr>
<tr><td><strong>Liquidity pool</strong></td><td style="text-align: right"></td></tr>
<tr><td>Create pool</td><td style="text-align: right">300</td></tr>
<tr><td>Swap (for non-DFI pairs)</td><td style="text-align: right">0.01</td></tr>
<tr><td><strong>Governance</strong></td><td style="text-align: right"></td></tr>
<tr><td>Initiate community fund request</td><td style="text-align: right">5</td></tr>
<tr><td>Initiate vote of confidence</td><td style="text-align: right">25</td></tr>
<tr><td>Initiate block reward reallocation proposal</td><td style="text-align: right">250</td></tr>
<tr><td><strong>Interchain exchange</strong></td><td style="text-align: right"></td></tr>
<tr><td>Atomic swap</td><td style="text-align: right">0.01</td></tr>
<tr><td><strong>Oracle</strong></td><td style="text-align: right"></td></tr>
<tr><td>Create price feed</td><td style="text-align: right">100</td></tr>
<tr><td>Appoint oracle</td><td style="text-align: right">20</td></tr>
<tr><td><strong>Loan</strong></td><td style="text-align: right"></td></tr>
<tr><td>Loan interest</td><td style="text-align: right">TBD</td></tr>
<tr><td>Liquidation fee</td><td style="text-align: right">TBD</td></tr>
<tr><td><strong>Option pool</strong></td><td style="text-align: right"></td></tr>
<tr><td>Create pool</td><td style="text-align: right">300</td></tr>
<tr><td>Option contract creation</td><td style="text-align: right">0.01</td></tr>
<tr><td>Bonus payout fee</td><td style="text-align: right">TBD</td></tr>
<tr><td><strong>Future</strong></td><td style="text-align: right"></td></tr>
<tr><td>Create future market</td><td style="text-align: right">300</td></tr>
<tr><td>Trade fee</td><td style="text-align: right">TBD</td></tr>
</tbody></table>
<div style="break-before: page; page-break-before: always;"></div><h1 id="futures"><a class="header" href="#futures">Futures</a></h1>
<p>Stocks, commodities and real-world tokenization will be offered on DeFiChain via futures contract, offered by <a href="pinkpaper/futures//operator">Operators</a>.</p>
<p>Future is offered by operators with the assistance of price oracles, allowing prices of assets to be tracked, real world or otherwise.</p>
<p>DeFiChain will support 2 types of futures:</p>
<ol>
<li>Fixed expiry</li>
</ol>
<ul>
<li>With a fixed expiry at a certain date in the future.</li>
<li>At the time of expiry,</li>
</ul>
<ol start="2">
<li>Perpetual swap</li>
</ol>
<ul>
<li>With funding mechanics</li>
</ul>
<h2 id="mechanics"><a class="header" href="#mechanics">Mechanics</a></h2>
<ol>
<li>Margin contract</li>
</ol>
<ul>
<li>Trader is able to fund their Future trading position through this margin contract.</li>
<li>Contract can be funded with DFI and other tokens that operators decide, e.g. BTC.</li>
<li>Operator can also define <em>initial margin</em> and <em>maintenance margin</em> for a margin contract.</li>
</ul>
<ol start="2">
<li>Asset</li>
</ol>
<ul>
<li>Operator decide assets to list.</li>
<li>Assets can be stocks, commodities or anything that has a price. It is operator's responsibility to ensure that there are good price oracles for traded assets.</li>
</ul>
<ol start="3">
<li>Order</li>
</ol>
<ul>
<li>User is able to make an order. It can be a <strong>long</strong> or <strong>short</strong> order.</li>
<li>Orders are matched automatically on-chain.</li>
</ul>
<ol start="4">
<li>Settlement</li>
</ol>
<ul>
<li>Fixed expiry future will be settled automatically based on settlement oracle price published.</li>
<li>Perpetual swap future has no settlement. There is instead a <strong>funding rate mechanism</strong>.</li>
</ul>
<ol start="5">
<li>Perpetual swap funding</li>
</ol>
<ul>
<li>Funding rate is automatically determined by DeFiChain based on fixed algorithm: oracle price, perpetual swap trading price.</li>
<li>Funding period can be set by operator, but it should be between 1x to a max of 12x per day. For reference, most centralized perpetual swap offerings have a 8h funding interval (3x per day).</li>
</ul>
<ol start="6">
<li>Liquidation</li>
</ol>
<ul>
<li>When net margin (total margin + unrealized PnL) is less than maintenance margin, forced liquidation would occur.</li>
<li>TBD: Either automated, operator-run, or community-run with incentives.</li>
</ul>
<h3 id="enahncements"><a class="header" href="#enahncements">Enahncements</a></h3>
<ol>
<li>Future can further be enhanced to allow leverage. DeFiChain will start with no leverage (1x) and will introduce leverage once the mechanisms are stable.</li>
</ol>
<h2 id="rpc"><a class="header" href="#rpc">RPC</a></h2>
<p><em>TK</em></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="on-chain-governance"><a class="header" href="#on-chain-governance">On-chain Governance</a></h1>
<h2 id="governance-summary"><a class="header" href="#governance-summary">Governance summary</a></h2>
<p>Voting is carried out every 130,000 blocks, roughly once every calendar month.</p>
<p>Types of governance:</p>
<ol>
<li>
<p>Community development fund request proposal</p>
<ul>
<li>Requesting of community development fund.</li>
<li>Requires simple majority (&gt; 50%) by non-neutral voting masternodes to pass.</li>
<li>Fee: 10 DFI per proposal</li>
</ul>
</li>
<li>
<p>Block reward reallocation proposal</p>
<ul>
<li>Note the miner's reward (PoS) are guaranteed and cannot be reallocated.</li>
<li>Requires super majority (&gt; 66.67%) by non-neutral voting masternodes to pass.</li>
<li>Fee: 500 DFI per proposal</li>
</ul>
</li>
<li>
<p>Vote of confidence</p>
<ul>
<li>General directional vote, not consensus enforceable.</li>
<li>Requires super majority (&gt; 66.67%) by non-neutral voting masternodes to pass.</li>
<li>Fee: 50 DFI per proposal</li>
</ul>
</li>
</ol>
<p>All fees are trackably burned.</p>
<h2 id="community-fund-request-proposal-cfp"><a class="header" href="#community-fund-request-proposal-cfp">Community fund request proposal (CFP)</a></h2>
<h3 id="current-1"><a class="header" href="#current-1">Current</a></h3>
<p>Currently every block creates 19.9 DFI to community fund address that is controlled by Foundation.</p>
<h3 id="improvements"><a class="header" href="#improvements">Improvements</a></h3>
<p>The amount at <code>dZcHjYhKtEM88TtZLjp314H2xZjkztXtRc</code> will be moved to a community balance, we call this the &quot;Community Development Fund&quot;.</p>
<p>This fund, will be similar to Incentive Funding and Anchor Reward, they have no private keys and are unrealized by default unless allocated.</p>
<p>Voting is carried our every 90,000 blocks (roughly once every calendar month). This should be configurable as chainparams and requires a hardfork to update. The block where the vote is finalized is also known as &quot;Voting Finalizing Block&quot;.</p>
<p>User is able to submit a fund request that is to be voted by masternodes. Each fund request costs non-refundable 10 DFI. The 10 DFI is not burned, but being added to the proposal for that will be paid out to all voting masternodes to encourage participation. Each fund request can be also specify <code>cycle</code>. Cycle is defaulted to <code>1</code> for one-off fund request, this also allows for periodic fund requests where a request is for a fixed amount to be paid out every cycle (every 90,000 blocks) for the specified cycles if the funding request remains APPROVED state.</p>
<h3 id="data-structure-of-a-funding-request"><a class="header" href="#data-structure-of-a-funding-request">Data structure of a funding request</a></h3>
<h4 id="user-submitted-data"><a class="header" href="#user-submitted-data">User submitted data</a></h4>
<ol>
<li>Title (required, this may also be implemented as hash of title to conserve on-chain storage)</li>
<li>Payout address (required) this can be different from requester's address</li>
<li>Finalize after block (optional, default=curr block + (blocks per cycle / 2))
<ul>
<li>Max valid value would be curr block + 3 * blocks per cycle. No minimum.</li>
<li>The rationale for this value is to allow sufficient time for requests to be discussed and voted on, esp. when it is submitted closer to the end of current voting cycle.</li>
</ul>
</li>
<li>Amount per period (in DFI)</li>
<li>Period requested (required, integer, default=1)</li>
</ol>
<h4 id="internal-data"><a class="header" href="#internal-data">Internal data</a></h4>
<ol>
<li>Completed payment periods (integer)</li>
<li>State</li>
<li>Voting data</li>
</ol>
<h4 id="states-of-funding-request"><a class="header" href="#states-of-funding-request">States of funding request</a></h4>
<p>Funding requests can have one of the following states</p>
<ol>
<li><code>VOTING</code>: Successfully submitted request, currently undergoing voting state</li>
<li><code>REJECTED</code>: At voting finalizing block, if a request does not achieve. This is a FINAL state and cannot be re-opened.</li>
<li><code>COMPLETED</code>: A funding request that has been paid out entirely. When completed payment periods is equals to period requested, request is marked as <code>COMPLETED</code>. . This is a FINAL state and cannot be re-opened.</li>
</ol>
<p>The absence of the state <code>APPROVED</code> is intended. An approved request will simply have its payout made and increment the completed payment period. If payment has been completed fully, request state will be changed to <code>COMPLETED</code>, which is a final state. A corollary to this allows for a request that requested for a payout of 1000 DFI every month and has received for 2 months to be rejected at the 3rd month if there are more no votes to yes votes.</p>
<h3 id="rpc-1"><a class="header" href="#rpc-1">RPC</a></h3>
<ol>
<li>
<p><code>creategovcfr '{DATA}'</code></p>
<ul>
<li><code>DATA</code> is serialized JSON with the following:
<ul>
<li><code>title</code></li>
<li><code>finalizeAfter</code>: Defaulted to current block height + 90000/2. All eligible proposals have to be submitted at least 90k blocks before the finalizing block and not more than 270k blocks before.</li>
<li><code>cycles</code>: Defaulted to <code>1</code> if unspecified.</li>
<li><code>amount</code>: in DFI.</li>
<li><code>payoutAddress</code>: DFI address</li>
</ul>
</li>
<li>10 DFI is paid along with the submission.</li>
<li>Request is finalized after submission, no edits are possible thereafter.</li>
<li>Returns <code>txid</code>. The <code>txid</code> is also used as the proposal ID.</li>
</ul>
</li>
<li>
<p><code>vote PROPOSALID DECISION</code></p>
<ul>
<li><code>PROPOSALID</code> is the <code>txid</code> of the submitted funding request.</li>
<li><code>DECISION</code> can be either of the following:
<ul>
<li><code>yes</code></li>
<li><code>no</code></li>
<li><code>neutral</code></li>
</ul>
</li>
<li>A masternode is able to change the vote decisions before the request is finalized, the last vote as seen on the block BEFORE finalizing block is counted.</li>
</ul>
</li>
</ol>
<h2 id="votes"><a class="header" href="#votes">Votes</a></h2>
<p>A masternode is deemed to be eligible to cast a vote if ALL the following conditions are satisfied:</p>
<ol>
<li>The masternode is in <code>ENABLED</code> state during vote submission AND at vote finalizing block.</li>
<li>The masternode has successfully minted at least 1 block during vote submission AND at vote finalizing block.</li>
</ol>
<p>Any eligible masternodes can cast a vote to any proposal that is in <code>VOTING</code> state, regardless of completed payment period.</p>
<p>Masternodes are able to cast any of the following votes:</p>
<ol>
<li>YES</li>
<li>NO</li>
<li>NEUTRAL</li>
</ol>
<p>At every vote finalizing block, a community fund proposal (CFP) is deemed to be eligible to be paid out of all the followings are true:</p>
<ol>
<li>There are more YES votes than NO votes. Simple majority wins. NEUTRAL votes are not counted. If there are equal amount of YES and NO votes, the CFR is deemed to have failed and rejected.</li>
<li>The voting masternodes eligibility must be <code>ENABLED</code> at the finalizing block and have mined at least 1 block.</li>
<li>Quorum: All proposals require at least 1% of voting masternodes of all active masternodes that mined at least 1 block before the finalizing block.</li>
</ol>
<h2 id="other-proposals"><a class="header" href="#other-proposals">Other proposals</a></h2>
<p>Other proposals such as block reallocation proposal and vote of confidence will follow the same voting cycle.</p>
<h2 id="supplementary-website"><a class="header" href="#supplementary-website">Supplementary website</a></h2>
<p>While blockchain's as data storage is desired to maintain impartiality and anonymity of discussions, it is not a conducive medium for a wider discussion. A supplementary website will be made available to facilitate all proposal discussions and track the progress.</p>
<p>A good supplementary website is suggested to carry the following features:</p>
<ol>
<li><strong>Proposer identification</strong> to facilitate meaningful discussion among the community and the proposer. This does not, however, imply the need of a user account system.</li>
<li><strong>Proposal extension and title hash validation</strong>. As the blockchain only contains the hash of title, the supplementary website must allow the proposer to enter the full proposal title hash and enter any additional descriptions on the proposals.</li>
<li><strong>Vote tracking</strong>. Ability to track votes as it happens.</li>
</ol>
<p>An example good supplementary website would be https://www.dashcentral.org/budget for Dash.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="interchain-exchange"><a class="header" href="#interchain-exchange">Interchain Exchange</a></h1>
<h2 id="goals-2"><a class="header" href="#goals-2">Goals</a></h2>
<p>Allow users to trustlessly and seamlessly swap between DST and Bitcoin BTC. BTC in the rest of this document will only referring to BTC on Bitcoin blockchain and not BTC DST.</p>
<p>Key areas of focus, in decreasing order of importance:</p>
<ol>
<li>Safety</li>
<li>User experience – it should be easily presentable on a client UI</li>
<li>Seamlessness - most of the steps should be automated at client</li>
</ol>
<h2 id="components"><a class="header" href="#components">Components</a></h2>
<ol>
<li>
<p>Hash Time Lock Contract</p>
<ul>
<li>A.k.a. HTLC</li>
<li>Part of Bitcoin script, and DFC side, it's a new construct for DST.</li>
<li>Requires both participants to be active.</li>
<li>H = Hash(S)</li>
</ul>
</li>
<li>
<p>Inter-chain Exchange</p>
<ul>
<li>A.k.a. ICX / XCX</li>
<li>This is on-chain (DeFiChain) trustless exchange with &quot;traditional&quot; orderbook</li>
</ul>
</li>
<li>
<p>SPV wallet</p>
<ul>
<li>Simple Payment Verification Bitcoin wallet</li>
<li>Distributed as part of DeFiChain node</li>
<li>This is why we are only supporting Bitcoin, at least for now.</li>
</ul>
</li>
</ol>
<h2 id="glossary"><a class="header" href="#glossary">Glossary</a></h2>
<ol>
<li>Buyer vs Seller</li>
<li>Maker vs Taker</li>
</ol>
<h2 id="scenarios"><a class="header" href="#scenarios">Scenarios</a></h2>
<p>2 scenarios:</p>
<ol>
<li>
<p>DST seller maker, wants BTC</p>
<ul>
<li>Paired with BTC seller taker</li>
</ul>
</li>
<li>
<p>BTC seller maker, wants DST</p>
<ul>
<li>Paired with DST seller taker</li>
</ul>
</li>
</ol>
<h2 id="scenario-1"><a class="header" href="#scenario-1">Scenario 1</a></h2>
<p><img src="pinkpaper/interchain-exchange/img/xcx-scenario1.png" alt="Scenario 1" /></p>
<p>Alice
- Sells DST, wants BTC
- Maker</p>
<p>Bob
- Sells BTC, wants DST
- Taker</p>
<ol>
<li>
<p>Alice, as maker, puts up an order:</p>
<ul>
<li>For sale: 10 TSLA DST</li>
<li>unitPrice: 0.02 <em>(BTC - $800 each for BTC at $40k)</em></li>
<li>expiry: 2880 blocks</li>
<li>optionFeePerUnit: 8 <em>(DFI)</em></li>
</ul>
</li>
<li>
<p>Bob, as taker:</p>
<ul>
<li>Wants to buy just 2.5 TSLA, not all 10. <em>(partial order)</em></li>
<li>Makes an acceptance offer.</li>
<li>Transmits <code>optionFeePerUnit * unit</code> 8 * 2.5 = 20 DFI alongside the order into HTLC. No payment DFI is locked up yet, only 20 DFI for optionFee</li>
<li>UX: either browse orderbook, or do a market order <em>(easier: always match with the best price)</em></li>
</ul>
</li>
<li>
<p>Alice accepts the offer</p>
<ul>
<li>UX side this is automatically accepted</li>
<li>Moves 2.5 TSLA from the order into DFC DST HTLC (also known as ICX Contract).</li>
<li>Properties of HTLC:
<ul>
<li>2.5 TSLA locked up for 120 blocks (1 hour)</li>
<li>with H provided, where H = Hash(S) the funds for Bob can be unlocked from this HTLC.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Bob sees the DST HTLC, verifies the following:</p>
<ul>
<li>Amount, token, time locked up and recipient is correct.</li>
<li>Waits for sufficient confirmation at DFC side to ensure finality.</li>
<li>Bob, now initiates on the Bitcoin side, HTLC for:
<ul>
<li>2.5 * 0.02 = 0.05 BTC</li>
<li>With the same H. Take note that Alice knows S, but Bob does not know S.</li>
<li>Time limit is 30 minutes.</li>
</ul>
</li>
<li>Bob updates ICX C on this HTLC.</li>
</ul>
</li>
<li>
<p>Alice accepting Bitcoin</p>
<ul>
<li>Alice confirms that HTLC properties are correct, amount, time, recipient.</li>
<li>Waits for sufficient confirmation at Bitcoin blockchain to ensure finality.</li>
<li>Claims Bitcoin by revealing S.</li>
</ul>
</li>
<li>
<p>Bob now claims DST.</p>
<ul>
<li>Bob sees that Alice has claimed and revealed S.</li>
<li>Bob claims DST too by using the same S.</li>
<li>DST is claimed on ICX C itself, this sends DST to Bob, and refunds Bob the <code>optionFee</code>.</li>
</ul>
</li>
</ol>
<h3 id="bad-actors"><a class="header" href="#bad-actors">Bad actors</a></h3>
<ol>
<li>N/A</li>
<li>N/A</li>
<li>If Alice does not accept, Bob's offer expires after 20 blocks and takes back <code>optionFee</code>.</li>
<li>If Bob does not honor the BTC side, Alice receives back her 2.5 TSLA after 1 hour + <code>optionFee</code>.</li>
</ol>
<h2 id="scenario-2"><a class="header" href="#scenario-2">Scenario 2</a></h2>
<p><img src="pinkpaper/interchain-exchange/img/xcx-scenario2.png" alt="Scenario 2" /></p>
<p>Charlie
- Sells BTC, wants DST
- Maker</p>
<p>Dave
- Sells DST, wants BTC
- Taker</p>
<ol>
<li>
<p>Charlie, as maker, puts up an order:</p>
<ul>
<li>Buying: 10 TSLA DST</li>
<li>unitPrice: 0.02 <em>(BTC - $800 each for BTC at $40k)</em></li>
<li>expiry: 2880 blocks</li>
<li>optionFeePerUnit: 8 <em>(DFI)</em></li>
</ul>
</li>
<li>
<p>Dave, as taker:</p>
<ul>
<li>Wants to sell just 2.5 TSLA, not all 10. <em>(partial order)</em></li>
<li>Makes an acceptance offer.</li>
<li>Transmits <code>optionFeePerUnit * unit</code> 8 * 2.5 = 20 DFI alongside the order into HTLC. No payment DFI is locked up yet, only 20 optionFee DFI.</li>
<li>UX: either browse orderbook, or do a market order <em>(easier: always match with the best price)</em></li>
</ul>
</li>
<li>
<p>Charlie accepts the offer</p>
<ul>
<li>Charlie comes up with S. Computes H where H = Hash(S).</li>
<li>Charlie locks up BTC on the Bitcoin HTLC for:
<ul>
<li>2.5 * 0.02 = 0.05 BTC</li>
<li>With H. Take note that Charlie knows S, but Dave does not know S.</li>
<li>Time limit is 1 hour (6 blocks).</li>
</ul>
</li>
<li>and creates ICX Contract with H, and Bitcoin HTLC address.</li>
<li>Dave's <code>optionFee</code> is locked in ICX C.</li>
</ul>
</li>
<li>
<p>Dave sees that Charlie has accepted the offer and that BTC is now locked in HTLC</p>
<ul>
<li>Validates that BTC HTLS is correctly set up - amount, time, recipient</li>
<li>Waits for sufficient confirmation on BTC side to ensure finality.</li>
<li>Moves 2.5 TSLA from the order into DFC ICX C (no need to provide H as contract already know H)</li>
</ul>
</li>
<li>
<p>Charlie accepts DST</p>
<ul>
<li>Waits for sufficient confirmation on DFC side to ensure finality.</li>
<li>Claims DST by revealing S</li>
<li>This sends DST to Charlie and refunds <code>optionFee</code> to Dave.</li>
</ul>
</li>
<li>
<p>Dave now claims BTC</p>
<ul>
<li>using the same S on the BTC HTLC</li>
</ul>
</li>
</ol>
<h3 id="bad-actors-1"><a class="header" href="#bad-actors-1">Bad actors</a></h3>
<ol>
<li>N/A</li>
<li>N/A</li>
<li>If Charlie does not accept, Bob's offer expires after 10 blocks and takes back <code>optionFee</code>.</li>
<li>If Bob does not honor the BTC side, Alice receives back her 2.5 TSLA after 1 hour + <code>optionFee</code>.</li>
</ol>
<h1 id="override-notice-fees-and-incentives"><a class="header" href="#override-notice-fees-and-incentives">Override Notice: Fees and Incentives</a></h1>
<p><em>TODO: Cleanup this document to be coherent</em></p>
<p>The above document has parts overriden by the <a href="pinkpaper/interchain-exchange/fees.html">fees document</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="interchain-exchange-fees"><a class="header" href="#interchain-exchange-fees">Interchain Exchange fees</a></h1>
<h2 id="game-theory-exploits"><a class="header" href="#game-theory-exploits">Game theory exploits</a></h2>
<p>The following fees are suggested to prevent the following:</p>
<ol>
<li>Users could potentially take up their own orders to generate fake transactions.</li>
<li>Users could potentially take up other users' orders to eliminate competition and increase own incentives returns.</li>
<li>Users could leave their orders passively and not respond to take requests.</li>
</ol>
<h2 id="general-ideas"><a class="header" href="#general-ideas">General ideas</a></h2>
<ul>
<li>Negative maker fee</li>
<li>Positive taker fee</li>
<li>Also the DFI made by Maker, inclusive of bonus must be less than fees paid by Taker. Without it fake transactions would be generated to game rewards.</li>
</ul>
<h2 id="fees"><a class="header" href="#fees">Fees</a></h2>
<ul>
<li>Previous <code>optionFee</code> is now replaced with non-refundable <code>takerFee</code>.
<ul>
<li>This is to deal the case where Alice refuses to accept Bob's valid HTLC <em>(Scenario 1)</em> and unfairly profits from <code>optionFee</code>.</li>
</ul>
</li>
<li><code>takerFee</code> is in DFI and is fixed at consensus-set (<code>takerFeePerBTC</code> * BTC * <code>DEX DFI per BTC rate</code>).</li>
<li><code>makerDeposit</code> being the same as <code>takerFee</code>.
<ul>
<li>It is refundable upon successful swap.</li>
</ul>
</li>
<li><code>makerIncentive</code>
<ul>
<li><code>25% * takerFee</code></li>
</ul>
</li>
<li><code>makerBonus</code>
<ul>
<li><code>50% * takerFee</code> if it's BTC parity trade. BTC DSTs eligible for <code>makerBonus</code> are consensus-set.</li>
</ul>
</li>
</ul>
<h3 id="dst-maker-exiting-to-bitcoin"><a class="header" href="#dst-maker-exiting-to-bitcoin">DST maker exiting to Bitcoin</a></h3>
<ol>
<li>Maker, pays no fee, but locks up DST <em>(consensus-verifiable)</em>.</li>
<li>Taker makes offer, locks up <code>takerFee</code>.
<ul>
<li>If offer is not accepted after timeout, <code>takerFee</code> is refunded.</li>
</ul>
</li>
<li>Maker accepts offer, locks up DST <em>(consensus-verifiable)</em>, burns <code>makerDeposit</code> &amp; <code>takerFee</code>.
<ul>
<li>If partial amount from offer is accepted, refunds unused <code>takerFee</code> proportionally back to Taker.</li>
</ul>
</li>
<li>Taker locks up BTC <em>(non-consensus-verifiable)</em> and updates ICXC on BTC HTLC.</li>
<li>Maker verifies that BTC HTLC is correct, claims BTC.
<ul>
<li>If Taker locks up incorrectly, both parties lose DFI <em>(neither party wins)</em></li>
<li>If Maker does not verify, both parties lose DFI <em>(neither party wins)</em></li>
</ul>
</li>
<li>Taker claims DST on ICXC.
<ul>
<li>Mints <code>makerDeposit</code> <em>(refund)</em>, <code>makerIncentive</code> &amp; <code>makerBonus</code> <em>(if any)</em> to Maker.</li>
<li>Validate that the amounts are correct – no additional tokens are generated.</li>
</ul>
</li>
</ol>
<h3 id="btc-maker-entering-from-bitcoin"><a class="header" href="#btc-maker-entering-from-bitcoin">BTC maker entering from Bitcoin</a></h3>
<ol>
<li>Maker, pays no fee.</li>
<li>Taker makes offer, locks up <code>takerFee</code>.
<ul>
<li>If offer is not accepted after timeout, <code>takerFee</code> is refunded.</li>
</ul>
</li>
<li>Maker accepts offer, locks up <code>makerDeposit</code>.</li>
<li>Taker locks up DST <em>(consensus-verifiable)</em>, burns both <code>takerFee</code> and <code>makerDeposit</code>.
<ul>
<li>If Taker does not do it, burns <code>takerFee</code> and refund <code>makerDeposit</code> to Maker.</li>
</ul>
</li>
<li>Maker locks up BTC <em>(non-consensus-verifiable)</em> and updates ICXC on BTC HTLC.</li>
<li>Taker verifies that BTC HTLC is correct, claims BTC.
<ul>
<li>If Maker locks up incorrectly, both parties lose DFI <em>(neither party wins)</em></li>
<li>If Taker does not verify, both parties lose DFI <em>(neither party wins)</em></li>
</ul>
</li>
<li>Maker claims DST on ICXC
<ul>
<li>Mints <code>makerDeposit</code> <em>(refund)</em>, <code>makerIncentive</code> &amp; <code>makerBonus</code> <em>(if any)</em> to Maker.</li>
<li>Validate that the amounts are correct – no additional tokens are generated.</li>
</ul>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="loan-and-decentralized-tokenization"><a class="header" href="#loan-and-decentralized-tokenization">Loan and Decentralized Tokenization</a></h1>
<p>Loan is be offered by <a href="pinkpaper/loan/../operator">operator</a> to allow decentralized price-tracking tokens to be created by users.</p>
<p>Before Operator model is ready, it uses only 1 default <a href="pinkpaper/loan/../operator">opspace</a> and requires foundation authorization, that acts on behalf of community.</p>
<p>Possibility of tokens being offered in a decentralized manner can be of many types, including but not limited to:</p>
<ol>
<li>Cryptocurrency such as <code>BTC</code>, <code>ETH</code>, <code>LTC</code>, etc.</li>
<li>Stablecoin such as <code>USD</code>, <code>EUR</code> tokens, etc.</li>
<li>Stocks token such as <code>TSLA</code>, <code>MSFT</code>, etc.</li>
<li>Other asset tokens.</li>
</ol>
<h2 id="concepts-1"><a class="header" href="#concepts-1">Concepts</a></h2>
<h3 id="collateralization-ratio"><a class="header" href="#collateralization-ratio">Collateralization ratio</a></h3>
<p>Loan on DeFiChain operates on over-collateralization mechanism. User first has to open a vault to mint tokens.</p>
<p>Collateralization is calculated for each vaults, using the following formula:</p>
<pre><code>Collateralization ratio =
    Total effective value of collateral /
    (Total value of tokens minted + Total interest)
</code></pre>
<p>For example, if a vault holds $200 worth of collateral asset, with $90 minted tokens and $10 of total interest accrued, the collateralization ratio is 200 / (90 + 10) = 2.</p>
<p>This is not to be confused with <em>collateralization factor</em>.</p>
<h3 id="collateralization-factor"><a class="header" href="#collateralization-factor">Collateralization factor</a></h3>
<p>Assets that are accepted for collateralization could be accepted at different collateralization factor, from 0% to 100%. When an asset collateralization factor is 100%, the entirety of the asset's value contributes to the collateralization value of the vault, however, if an asset collateralization factor is say 50%, then only half of its value contributes to the total vault's collateral.</p>
<p>For example if <code>DOGE</code> is accepted at 70% collateralization factor, $100 of <code>DOGE</code> would contribute to $70 of collateral value in a vault.</p>
<p>This is not to be confused with <em>collateralization ratio</em>.</p>
<h3 id="operator"><a class="header" href="#operator">Operator</a></h3>
<p>Operator plays to role to decide on the following:</p>
<ol>
<li>Collateral tokens and their respective collateralization values.
<ul>
<li>For instance, an Operator can decide to allow users to start a Vault in their opspace with the following collateralization factors:
<ul>
<li><code>DFI</code> at 100% collateralization factor</li>
<li><code>BTC</code> at 100% collateralization factor</li>
<li><code>DOGE</code> at 70% collateralization factor</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>Operator, also via opspace's governance values, can decide the following:</p>
<ul>
<li><code>LOAN_LIQUIDATION_PENALTY</code>: 0.05 (default), for 5% liquidation penalty. This is converted into DFI upon liquidation and burned.</li>
</ul>
<h3 id="loan-scheme"><a class="header" href="#loan-scheme">Loan scheme</a></h3>
<p>Loan scheme allows an operator to set up different loan schemes under the same Operator. Loan schemes allows an operator to define the following:</p>
<ul>
<li>Collateral token and different collateralization factor</li>
<li>Loan interest rates</li>
</ul>
<p>For example, a series of loan schemes could be made available:</p>
<ol>
<li>Min collateralization ratio: 150%. Interest rate: 5% APR.</li>
<li>Min collateralization ratio: 175%. Interest rate: 3% APR.</li>
<li>Min collateralization ratio: 200%. Interest rate: 2% APR.</li>
<li>Min collateralization ratio: 350%. Interest rate: 1.5% APR.</li>
<li>Min collateralization ratio: 500%. Interest rate: 1% APR.</li>
<li>Min collateralization ratio: 1000%. Interest rate: 0.5% APR.</li>
</ol>
<p>Vault owner can define which loan scheme to subscribe to during initial vault creation and can move it freely after that. Take caution though that if you move to a scheme with lower collateralization ratio, liquidation might be triggered.</p>
<h3 id="interest-rate"><a class="header" href="#interest-rate">Interest rate</a></h3>
<p>Interest rate for loan consists of 2 parts:</p>
<ul>
<li>Vault interest, based on loan scheme of individual vaults</li>
<li>Token interest, based on loan tokens, e.g. <code>TSLA</code> token might have its own interest that is chargeable only for <code>TSLA</code> token.</li>
</ul>
<p><a href="pinkpaper/loan/../fees">DeFi fees</a> are burned. Fees are typically collected in the form of the loan token repayment, and automatically swapped on DEX for DFI to be burned.</p>
<p>For example, if a loan of 100 <code>TSLA</code> is taken out and repaid back exactly 6 months later with the APR of 2%, the user will have to repay 101 <code>TSLA</code> during redemption to regain full access of collateral in the vault.</p>
<p>100 <code>TSLA</code> will be burned as part of the repayment process. 1 <code>TSLA</code> that forms the interest payment will be swapped on DEX for DFI. The resulting DFI will burned. All of these occur atomically as part of DeFiChain consensus.</p>
<h3 id="vault-1"><a class="header" href="#vault-1">Vault</a></h3>
<p>User is able to freely open a vault and deposit tokens to a vault. Vault is transferable to other owners, including being controlled by multisig address.</p>
<h3 id="collateral-dfi-requirement"><a class="header" href="#collateral-dfi-requirement">Collateral DFI requirement</a></h3>
<p>Vault's collateral requires at least 50% of it to be DFI.</p>
<p>When depositing non-DFI collateral to a vault, it needs to ensure that the resulting DFI proportion of for vault's collateral is at least 50% or more, or the deposit transaction should fail.</p>
<p>This requirement is only checked upon deposited and does not play a role in liquidation. For instance, if at the time of posit, a vault's DFI collateral is 52%, but falls to 49% without any further deposit. This WILL NOT trigger liquidation as long as vault's minimum collateralization ratio condition is still met.</p>
<h3 id="states"><a class="header" href="#states">States</a></h3>
<ul>
<li>&quot;active&quot; : Vault is above its collateralization ratio and both collaterals and loans price feeds are valid.</li>
<li>&quot;frozen&quot; : Any of collateral or loan price feed is invalid. No action can be undertaken while vault is frozen.</li>
<li>&quot;inLiquidation&quot; : Vault is under liquidation and has undergoing auctions.</li>
<li>&quot;mayLiquidate&quot; : Vault will liquidate at the next price update.</li>
</ul>
<h2 id="liquidation"><a class="header" href="#liquidation">Liquidation</a></h2>
<p>Liquidation occurs when the collateralization ratio of a vault falls below its minimum. Liquidation is crucial in ensuring that all loan tokens are sufficiently over-collateralized to support its price.</p>
<p>For Turing-complete VM-based blockchain, liquidation requires the assistance of publicly run bots to trigger it, in exchange for some incentives.</p>
<p>There are two problems with that:</p>
<ul>
<li>During major price movements, the network fee, or commonly known as gas price, would sky rocket due to a race by both the vault owners frantically trying to save their vaults from getting liquidated, and by the public liquidators trying to trigger liquidation.</li>
<li>If liquidations are not triggered on time, tokens that are generated as a result of loan runs the risk of losing its values. Worse scenario would see it getting into a negative feedback loop situation creating a rapid crash of token values.</li>
</ul>
<p>DeFiChain, a blockchain that's built for specifically for DeFi, enjoy the benefit of automation and can have liquidation trigger automatically on-chain. This address the above two problems.</p>
<h3 id="methodology"><a class="header" href="#methodology">Methodology</a></h3>
<p>On every block, the node would evaluate all vaults and trigger the following automatically for liquidation.</p>
<p>When collateralization ratio of a vault falls below minimum collateralization ratio, liquidation would be triggered. During liquidation collateral auction is initiated.</p>
<p>When a vault is in liquidation mode, it can no longer be used until all the loan amount is repaid before it can be reopened. Interest accrual is also stopped during liquidation process.</p>
<h4 id="collateral-auction"><a class="header" href="#collateral-auction">Collateral auction</a></h4>
<p>The entirety of loan and collateral of a vault if put up for auction. As the first version of collateral auction requires bidding of the full amount, auction is automatically split into batches of <em>around</em> $10,000 worth each to facilitate for easier bidding.</p>
<h4 id="example"><a class="header" href="#example">Example</a></h4>
<p>A vault, that requires a minimum of 150% collateralization ratio contains $15,000 worth of collateral, which consists of $10,000 worth of DFI and $5,000 worth of BTC, and the total loan, inclusive of interest, is $11,000 worth.</p>
<ul>
<li>Collateral: $10,000 DFI + $5,000 BTC</li>
<li>Loan: $10,000 <code>TSLA</code> + $1,000 interest (<code>TSLA</code>)</li>
</ul>
<p>Collateralization ratio = 15k / 11k = 136.36% less than the required 150%. Liquidation is triggered automatically by consensus. Auction will be initiated with the intention to liquidate $15k of collateral to recover $11k of loan.</p>
<p>Liquidation penalty is defined as <code>LOAN_LIQUIDATION_PENALTY</code>. The amount to be recovered should also include the penalty. If <code>LOAN_LIQUIDATION_PENALTY</code> is 0.05, the total amount to be recovered is thus $11k * 1.05 = $11,550</p>
<p>Total collateral worth is $15k, it will thus be split into 2 batches, each not exceeding $10k:</p>
<ol>
<li>2/3 of the whole vault, worth $10k of collateral.</li>
<li>1/3 of the whole vault, worth $5k of collateral.</li>
</ol>
<p>Specifically the following:</p>
<ol>
<li>($6,667 DFI and $3,333 BTC) for $7,700 <code>TSLA</code></li>
<li>($3,333 DFI and $1,667 BTC) for $3,850 <code>TSLA</code></li>
</ol>
<p><code>TSLA</code> recovered at the conclusion of the auction will be paid back to the vault. Once all loan is repaid, vault will exit liquidation state, allowing its owner to continue to use it. It will, however, not terminate all opened auctions. Opened auctions see through to their conclusion.</p>
<h2 id="collateral-auction-1"><a class="header" href="#collateral-auction-1">Collateral auction</a></h2>
<p>Collateral auction will run for 720 blocks (approximately 6 hours) with the starting price based on liquidation vault's ratio.</p>
<p>Using the same illustration, Auction 1: ($6,667 DFI and $3,333 BTC) for $7,700 <code>TSLA</code></p>
<p>Anyone can participate in the auction, including the vault owner by bidding for the entirety of the auction with higher amount. To prevent unnecessary auction sniping at closing blocks, each higher bid, except the first one, has to be at least 1% higher than previous bid.</p>
<p>A user could bid for the same auction by offering $7,800 worth of <code>TSLA</code> tokens. During bidding, the bid is locked and refunded immediately when outbid. Top bid is not cancelable.</p>
<p>At the conclusion of the auction, the entirety of the for sale collateral will be transferred to the winner – in this case the winner would be paying $7,800 for $10,000 worth of BTC and DFI.</p>
<p>$7,800 worth of <code>TSLA</code> token will be processed as follow:</p>
<ul>
<li>Paid back to vault = $7,800 worth of <code>TSLA</code> / (1 + <code>LOAN_LIQUIDATION_PENALTY</code>) = 7800 / 1.05 = $7,428.57 <code>TSLA</code> token</li>
<li>The remaining, i.e. liquidation penalty, will be swapped to DFI and burned. $371.43 worth of <code>TSLA</code> be swapped as follows and  trackably burned:
<ol>
<li><code>TSLA</code> to <code>USD</code> from <code>TSLA-USD</code> DEX.</li>
<li><code>USD</code> to <code>DFI</code> from <code>USD-DFI</code> DEX.</li>
</ol>
</li>
</ul>
<p>If auctions yield more <code>TSLA</code> than the vault's loan, it will be deposited back to the vault as part of vault's asset, but not collateral. It can be withdrawn from the vault after vault exits liquidation state by vault's owner and carries no interest.</p>
<h3 id="multiple-loan-tokens"><a class="header" href="#multiple-loan-tokens">Multiple loan tokens</a></h3>
<p>If a vault consists of multiple loan tokens, they should be auctioned separately.</p>
<p>For instance, a liquidating vault that consists of the following:</p>
<ul>
<li>Collateral: 1 BTC &amp; 100 DFI</li>
<li>Loan: $10k worth of USD * $40k worth TSLA</li>
</ul>
<p>would be liquidated as follows:</p>
<ul>
<li>(0.2 BTC &amp; 20 DFI) for $10k worth of USD</li>
<li>(0.8 BTC &amp; 80 DFI) for $40k worth of TSLA</li>
</ul>
<p>and further split into $10k batches.</p>
<h3 id="failed-auction"><a class="header" href="#failed-auction">Failed auction</a></h3>
<p>Auction that expires after 720 blocks without bids will be reopened immediately based on the remaining amount of collateral and loan that the vault receives due to conclusion of other auction batches.</p>
<h2 id="rpc-2"><a class="header" href="#rpc-2">RPC</a></h2>
<h3 id="operator-1"><a class="header" href="#operator-1">Operator</a></h3>
<p>Requires Operator authorization. Before Operator model is ready, it uses only 1 default <a href="pinkpaper/loan/../operator">opspace</a> and requires foundation authorization.</p>
<h4 id="loan-scheme-1"><a class="header" href="#loan-scheme-1">Loan scheme</a></h4>
<ol>
<li>
<p><code>createloanscheme DATA</code></p>
<ul>
<li><code>DATA</code> (JSON) can consist of the following:
<ul>
<li><code>mincolratio</code>: e.g. 175 for 175% minimum collateralization ratio. Cannot be less than 100.</li>
<li><code>interestrate</code>: Annual rate, but chargeable per block (scaled to 30-sec block). e.g. 3.5 for 3.5% interest rate. Must be &gt; 0.</li>
<li><code>id</code>: Non-colliding scheme ID that's unique within opspace, e.g. <code>MIN_175</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>updateloanscheme MIN_COL_RATIO INTEREST_RATE SCHEME_ID [ACTIVATE_AFTER_BLOCK]</code></p>
<ul>
<li>Update loan scheme details.</li>
<li><code>ACTIVATE_AFTER_BLOCK</code> <em>(optional)</em>: If set, this will only be activated after the set block. The purpose is to allow good operators to provide sufficient warning.</li>
</ul>
</li>
<li>
<p><code>destroyloanscheme SCHEME_ID [ACTIVATE_AFTER_BLOCK]</code></p>
<ul>
<li>Destroy a loan scheme.</li>
<li><code>ACTIVATE_AFTER_BLOCK</code> <em>(optional)</em>: If set, this will only be activated after the set block. The purpose is to allow good operators to provide sufficient warning.</li>
<li>Any loans under the scheme will be moved to default loan scheme after destruction.</li>
</ul>
</li>
<li>
<p><code>setdefaultloanscheme SCHEME_ID</code></p>
<ul>
<li>Designate a default loan scheme from the available loan schemes.</li>
</ul>
</li>
</ol>
<h4 id="general"><a class="header" href="#general">General</a></h4>
<ol>
<li>
<p><code>setcollateraltoken DATA</code></p>
<ul>
<li><code>DATA</code> (JSON)
<ul>
<li><code>token</code>: Token must not be the same decentralized token is issued by the same operator's loan program.</li>
<li><code>factor</code>: A number between <code>0</code> to <code>1</code>, inclusive. <code>1</code> being 100% collateralization factor.</li>
<li><code>fixedIntervalPriceId</code>: Token/currency pair to track token price.</li>
<li><code>activateAfterBlock</code> <em>(optional)</em>: If set, this will only be activated after the set block. The purpose is to allow good operators to provide sufficient warning to their users should certain collateralization factors need to be updated.</li>
<li>This very same transaction type is also used for updating and removing of collateral token, by setting the factor to <code>0</code>.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>setloantoken DATA</code></p>
<ul>
<li>Creates or updates loan token.</li>
<li><code>DATA</code> (JSON)
<ul>
<li><code>symbol</code>Token's symbol (unique), not longer than 8</li>
<li><code>name</code> Token's name (optional), not longer than 128</li>
<li><code>fixedIntervalPriceId</code>: Token/currency pair to track token price.</li>
<li><code>mintable</code> (bool): When this is <code>true</code>, vault owner can mint this token. (defaults to true)</li>
<li><code>interest</code>: Annual rate, but chargeable per block (scaled to 30-sec block). e.g. 3.5 for 3.5% interest rate. Must be &gt;= 0. Default: 0.</li>
</ul>
</li>
<li>To also implement <code>updateloantoken</code> and <code>listloantokens</code>.</li>
</ul>
</li>
</ol>
<h3 id="public"><a class="header" href="#public">Public</a></h3>
<p>Requires no authorizations.</p>
<ol>
<li>
<p><code>getloaninfo</code></p>
<ul>
<li>Returns the attributes of loans offered by Operator.</li>
<li>Includes especially the following:
<ul>
<li>Collateral tokens: List of collateral tokens</li>
<li>Loan tokens: List of loan tokens</li>
<li>Loan schemes: List of loan schemes</li>
<li>Collateral value (USD): Total collateral in vaults</li>
<li>Loan value (USD): Total loan token in vaults</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>listloanschemes</code></p>
<ul>
<li>Returns the list of attributes to all the available loan schemes.</li>
</ul>
</li>
</ol>
<h4 id="vault-2"><a class="header" href="#vault-2">Vault</a></h4>
<p>Vault-related, but does not require owner's authentication.</p>
<ol>
<li>
<p><code>createvault [OWNER_ADDRESS] [SCHEME_ID]</code></p>
<ul>
<li>Create a vault for <code>OWNER_ADDRESS</code>.</li>
<li>No <code>OWNER_ADDRESS</code> authorization required so that it can be used for yet-to-be-revealed script hash address.</li>
<li>2 DFIs needed for createvault.</li>
<li>1 DFI burned, and 1 added to collateral.</li>
<li>The last 1 added to collateral will be reclaimed  on closevault.</li>
</ul>
</li>
<li>
<p><code>deposittovault VAULT_ID TOKEN_TO_DEPOSIT</code></p>
<ul>
<li>Deposit accepted collateral tokens to vault.</li>
<li>Does not require authentication, anyone can top up anyone's vault.</li>
<li><code>TOKEN_TO_DEPOSIT</code> should be in similar format as other tokens on DeFiChain, e.g. <code>23.42@USDC</code> and <code>0.42@DFI</code>.</li>
<li>Also take note on the &gt;= 50% DFI requirement, when depositing a non-DFI token, it should reject if the total value of the vault's collateral after the deposit brings DFI value to less than 50% of vault's collateral.</li>
<li>This also means that the first deposit to a vault has to always be DFI.</li>
</ul>
</li>
<li>
<p><code>paybackloan DATA</code></p>
<ul>
<li><code>DATA</code> (JSON)
<ul>
<li><code>vaultId</code>: loan's vault ID.</li>
<li><code>from</code>: Address containing repayment tokens.</li>
<li><code>amounts</code>: Amounts to pay back in amount@token format.</li>
</ul>
</li>
<li>Pay back of loan token.</li>
<li>Only works when there are loans in the vault.</li>
<li>Refunds additional loan token back to original caller, if 51.1 <code>TSLA</code> is owed and user pays 52 <code>TSLA</code>, 0.9 <code>TSLA</code> is returned as change to transaction originator (not vault owner).</li>
<li>Does not require authentication, anyone can payback anyone's loan.</li>
</ul>
</li>
<li>
<p><code>getvault [VAULT_ID]</code></p>
<ul>
<li>Returns the attributes of a vault.</li>
<li>Includes especially the following:
<ul>
<li>Owner address</li>
<li>Loan scheme ID</li>
<li><code>state</code> Can be one of <code>active</code>, <code>frozen</code>, <code>inLiquidation</code> and <code>mayLiquidate</code>. See <a href="https://github.com/DeFiCh/pinkpaper/tree/main/loan#state">state</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>listvaults</code></p>
<ul>
<li>Returns the list of attributes to all the created vaults.</li>
</ul>
</li>
</ol>
<h3 id="vault-owner"><a class="header" href="#vault-owner">Vault owner</a></h3>
<p>Requires ownerAddress authentication, and vault MUST NOT be in liquidation state.</p>
<ol>
<li>
<p><code>updatevault VAULT_ID DATA</code></p>
<ul>
<li><code>DATA</code> (JSON) may consists of the following:
<ul>
<li><code>scheme</code>: Allows vault owner to switch to a different scheme</li>
<li><code>ownerAddress</code>: Transfers vault's ownership to a new address.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>withdrawfromvault VAULT_ID TO_ADDRESS AMOUNT</code></p>
<ul>
<li>Withdraw collateral tokens from vault.</li>
<li>Vault collateralization ratio must not be less than <code>mincolratio</code> of vault's scheme.</li>
<li>Also used to withdraw assets that are left in a vault due to higher auction yield. See <a href="pinkpaper/loan/index.html#collateral-auction">Collateral auction</a></li>
</ul>
</li>
<li>
<p><code>takeloan DATA</code></p>
<ul>
<li><code>DATA</code> (JSON)
<ul>
<li><code>vaultId</code>: ID of vault used for loan.</li>
<li><code>to</code>: Address to transfer tokens (optional).</li>
<li><code>amounts</code>: Amount in amount@token format.</li>
</ul>
</li>
<li>Vault collateralization ratio must not be less than <code>mincolratio</code> of vault's scheme.</li>
</ul>
</li>
</ol>
<h3 id="auction"><a class="header" href="#auction">Auction</a></h3>
<p>Requires no additional authentications.</p>
<ol>
<li>
<p><code>listauctions</code></p>
</li>
<li>
<p><code>auctionbid VAULT_ID INDEX FROM AMOUNT</code></p>
<ul>
<li>
<p><code>VAULT_ID</code>: Vault id.</p>
</li>
<li>
<p><code>INDEX</code>: Auction index.</p>
</li>
<li>
<p><code>FROM</code>: Address to get tokens.</p>
</li>
<li>
<p><code>AMOUNT</code>: Amount of amount@symbol format.</p>
</li>
<li>
<p><code>TOTAL_PRICE</code> of token in auction will be locked up until the conclusion of the auction, or refunded when outbid.</p>
</li>
</ul>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="operator-2"><a class="header" href="#operator-2">Operator</a></h1>
<h2 id="generalization"><a class="header" href="#generalization">Generalization</a></h2>
<p>Generalization effort in DeFiChain aims at separation between the role of blockchain and operator, the party in charge of offering financial products.</p>
<p>The generalization goals are to allow anyone to create and run as operator on DeFiChain, without requiring any prior permissions from DeFiChain Foundation or its developers.</p>
<h3 id="opspace"><a class="header" href="#opspace">Opspace</a></h3>
<p>Operator operates exclusively within their Opspace and does not interfere with the operations of other Opspaces and entire blockchain ecosystem.</p>
<p>To ensure operation continuity, the current asset tokens, and any other offerings that are available prior to the introduction of Operator, will be migrated to the first Opspace when the functionality is available.</p>
<h3 id="role"><a class="header" href="#role">Role</a></h3>
<p>The role and functionalities available to operators include:</p>
<ol>
<li>Price oracle</li>
</ol>
<ul>
<li>Setting of price feeds.</li>
<li>Appointing of oracles.</li>
</ul>
<ol start="2">
<li>Asset token</li>
</ol>
<ul>
<li>Determining and setting of asset tokens that are available within an opspace.</li>
<li>Previously referred to as &quot;DeFi Asset Token&quot; on white paper.</li>
</ul>
<ol start="3">
<li>Decentralized loan</li>
</ol>
<ul>
<li>Determining loan attributes: collateral types, interest rates, etc</li>
</ul>
<ol start="4">
<li>Futures</li>
</ol>
<ul>
<li>Determining future offerings &amp; attributes</li>
</ul>
<p>... and others as they are made available.</p>
<p>Operator is also free to determine their own Operator fee for all the products that they provide.</p>
<p>Note that operators may only want to participate in a subset of the operations available, for example an operator may only be interested in offering decentralized loan but not interested in offering futures.</p>
<h2 id="operations"><a class="header" href="#operations">Operations</a></h2>
<p>RPC is designed work with multisignatory opcodes of Bitcoin's script, allowing operator to have clear governance over its policies.</p>
<ol>
<li>
<p><code>createoperator</code></p>
<ul>
<li>Costs 1000 DFI in DeFi fee, burned.</li>
</ul>
</li>
<li>
<p><code>updateoperator</code></p>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="price-oracle"><a class="header" href="#price-oracle">Price oracle</a></h1>
<p>Even though Oracle could technically provide any off-chain data, the initial version of Oracle focuses on numeric data especially price feeds to augment various features and functionalities on DeFiChain, especially future, option &amp; loan.</p>
<h2 id="economics--game-theory"><a class="header" href="#economics--game-theory">Economics &amp; game theory</a></h2>
<p>To provide a fully robust trustless oracle service requires components such as reputation, penalty, and various other mechanics, it is not DeFiChain's current focus to build a full oracle system, at least at this stage. DeFiChain utilizes Operator and free economy to ensure that oracles are run as fairly as possible. It is Operator's interest to ensure that oracles that they appoint are fairly run, and users are free to select operators that they like.</p>
<h2 id="mechanics-1"><a class="header" href="#mechanics-1">Mechanics</a></h2>
<p>While truthfullness of the data cannot be assertained on the blockchain alone, the goals of the design should focus on building a <em>robust</em> oracle system that should continue to function fine with a few minotirty oracle outages.</p>
<h3 id="price-feeds"><a class="header" href="#price-feeds">Price feeds</a></h3>
<p>Price feed should be 8 decimal places.</p>
<p>Requires foundation authorization.</p>
<ol>
<li><code>createpricefeed BTC_USD_PRICE</code></li>
<li><code>removepricefeed BTC_USD_PRICE</code></li>
</ol>
<h3 id="oracle-appointments"><a class="header" href="#oracle-appointments">Oracle appointments</a></h3>
<p>Requires Operator authorization. Before Operator model is ready, it uses only 1 default <a href="pinkpaper/price-oracle/../operator">opspace</a> and requires foundation authorization.</p>
<ol>
<li><code>appointoracle ADDRESS '[&quot;BTC_USD_PRICE&quot;, &quot;ETH_USD_PRICE&quot;]' WEIGHTAGE</code>
<ul>
<li>returns <code>oracleid</code>. <code>oracleid</code> should be a deterministic hash and not incremental count.</li>
<li><code>WEIGHTAGE</code> is any number between 0 to 100. Default to 20.</li>
</ul>
</li>
<li><code>removeoracle ORACLEID</code></li>
<li><code>updateoracle ORACLEID ADDRESS '[&quot;BTC_USD_PRICE&quot;, &quot;ETH_USD_PRICE&quot;]' WEIGHTAGE</code></li>
</ol>
<h3 id="price-feeds-operations"><a class="header" href="#price-feeds-operations">Price feeds operations</a></h3>
<p>Requires appointed Oracle authorization.</p>
<ol>
<li><code>setrawprice TIMESTAMP '{&quot;BTC_USD_PRICE&quot;: 38293.12}'</code>
<ul>
<li>Raw price update should only be valid if timestamp is within one hour from the latest blocktime.</li>
<li>timestamp is there so that updates that are stuck in mempool for awhile does not get accepted after timeout.</li>
</ul>
</li>
</ol>
<h3 id="general-usage"><a class="header" href="#general-usage">General usage</a></h3>
<p>General usage, requires no authorizations.</p>
<ol>
<li>
<p><code>listlatestrawprices BTC_USD_PRICE</code></p>
<ul>
<li>Also supports <code>listlatestrawprices</code> to list across all feeds.</li>
<li>Returns an array of all the latest price updates, e.g.</li>
</ul>
<pre><code class="language-json">[
    {
        &quot;pricefeed&quot;: &quot;BTC_USD_PRICE&quot;,
        &quot;oracleid&quot;: &quot;ORACLEID&quot;,
        &quot;weightage&quot;: 50,
        &quot;timestamp&quot;: &quot;timestamp of the last update&quot;,
        &quot;rawprice&quot;: 38293.12000000,
        &quot;state&quot;: &quot;live&quot;
    }
]
</code></pre>
<ul>
<li>Price updates that are older than 1 hour from the latest blocktime would have its state to be <code>expired</code>.</li>
<li>It is also imperative that the node is not storing all raw price data on database, it only needs to know the latest raw price for each oracles.</li>
</ul>
</li>
<li>
<p><code>getprice BTC_USD_PRICE</code></p>
<ul>
<li>Returns number with aggregated price.</li>
<li>Aggregate price = Sum of (latest rawprice of live oracles * weightage) / Sum (live oracles' weightage)</li>
<li>If no live oracle is found for the price, it should throw an error. It MUST NOT return 0 or large number.</li>
</ul>
</li>
<li>
<p><code>listprices</code></p>
<ul>
<li>Same as above, but an array of all feeds.</li>
</ul>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dfip-2203"><a class="header" href="#dfip-2203">DFIP-2203</a></h1>
<h2 id="proposal"><a class="header" href="#proposal">Proposal</a></h2>
<p>For the community discussion that led to the addition of this feature, please have a look at the <a href="https://www.reddit.com/r/defiblockchain/comments/t63ppr/handling_dtoken_premium_with_futures/">Reddit</a> post and hear the <a href="https://twitter.com/i/spaces/1eaKbNRkzqkKX">Twitter Space</a>.</p>
<p>For the proposal, refer to this <a href="https://github.com/DeFiCh/dfips/issues/127">link</a></p>
<h2 id="dfip-summary-"><a class="header" href="#dfip-summary-">DFIP summary :</a></h2>
<ul>
<li>Introduce future trading for settling dToken prices once a week (7*2880 blocks).</li>
<li>Establish 2 different Future contracts - one for the premium case and on for the discount case.</li>
<li>Range for settlement should be +/-5%, which allows anticipating the next price in case of closed markets (constant oracle price)</li>
<li>Premium future should trade 5% above the oracle price - you can buy dTokens with a 5% fee)</li>
<li>Discount future should trade 5% below the oracle price - you can sell dTokens with a 5% discount)</li>
<li>Futures will be a weak binding of DEX price to oracle price: between settlement time higher/lower deviations are possible</li>
<li>Introducing an additional swap fee of 0.1% for every dToken pool to burn dTokens. The fee should be conducted for both swap
directions.</li>
<li>Strengthen dUSD by counting them in the same way as the mandatory 50% DFI in vaults with fix price of $0.99.</li>
</ul>
<h2 id="related-prs"><a class="header" href="#related-prs">Related PRs:</a></h2>
<ul>
<li>DEX fee <a href="https://github.com/DeFiCh/ain/pull/1153">PR</a></li>
<li>DUSD as collateral <a href="https://github.com/DeFiCh/ain/pull/1128">PR</a></li>
<li>Future swap contract <a href="https://github.com/DeFiCh/ain/pull/1155">PR</a></li>
</ul>
<h2 id="governances-variables"><a class="header" href="#governances-variables">Governances variables</a></h2>
<h3 id="v0paramsdfip2203active"><a class="header" href="#v0paramsdfip2203active">v0/params/dfip2203/active</a></h3>
<p>This variable determines wether the DFIP is activated or not. When disabled, no more deposit to the smart contract address will be accepted nor any swap will be executed.</p>
<h3 id="v0paramsdfip2203reward_pct"><a class="header" href="#v0paramsdfip2203reward_pct">v0/params/dfip2203/reward_pct</a></h3>
<p>The percent of premium deducted at the moment of the swap.</p>
<h3 id="v0paramsdfip2203period_blocks"><a class="header" href="#v0paramsdfip2203period_blocks">v0/params/dfip2203/period_blocks</a></h3>
<p>The block interval between two future swaps.</p>
<h3 id="v0tokentoken_iddfip2203_disabled"><a class="header" href="#v0tokentoken_iddfip2203_disabled">v0/token/&lt;token_id&gt;/dfip2203_disabled</a></h3>
<p>Defaults to false. Used to blacklist certain token.</p>
<h2 id="rpc-commands"><a class="header" href="#rpc-commands">RPC commands</a></h2>
<h3 id="getfutureswapblock"><a class="header" href="#getfutureswapblock">getfutureswapblock</a></h3>
<p>Get the next block when the contract will be executed.</p>
<pre><code>defi-cli getfutureswapblock
895100
</code></pre>
<h3 id="futureswap"><a class="header" href="#futureswap">futureswap</a></h3>
<h4 id="parameters-"><a class="header" href="#parameters-">Parameters :</a></h4>
<ul>
<li><code>address</code> : Address to fund contract and receive resulting token.</li>
<li><code>amount</code> : Amount to send in amount@token format.</li>
<li><code>destination</code> : Optional. Expected dToken if DUSD amount supplied.</li>
</ul>
<p>Deposit DUSD or dTokens to be swapped at the next block interval.</p>
<pre><code>defi-cli futureswap &lt;address&gt; &lt;amount&gt; &lt;destination&gt;
fd55837215c7ff29ba43afb196ffbfba8c20f16eb9dbba30ba829853f15b2aeb
</code></pre>
<h3 id="withdrawfutureswap"><a class="header" href="#withdrawfutureswap">withdrawfutureswap</a></h3>
<h4 id="parameters--1"><a class="header" href="#parameters--1">Parameters :</a></h4>
<ul>
<li><code>address</code> : Address to fund contract and receive resulting token.</li>
<li><code>amount</code> : Amount to send in amount@token format.</li>
<li><code>destination</code> : Optional. Expected dToken if DUSD amount supplied.</li>
</ul>
<p>Withdraw DUSD or dTokens previously deposited.</p>
<pre><code>defi-cli withdrawfutureswap &lt;address&gt; &lt;amount&gt; &lt;destination&gt;
bceb216add60c38888d102c737d73d3a559fc214bbe18cab92848a8d31586944
</code></pre>
<h3 id="listpendingfutureswaps"><a class="header" href="#listpendingfutureswaps">listpendingfutureswaps</a></h3>
<p>List all pending futures.</p>
<pre><code>defi-cli listpendingfutureswaps
[{'owner': 'mg1qAZBb28tuWpxNmbRvZha9zhUpEQ5uVx', 'source': '1.00000000@MSFT', 'destination': 'DUSD'}, {'owner': 'mhe4v9VMpinWfJpgUqpmyEXeUXc1AdFoVC', 'source': '1.00000000@GOOGL', 'destination': 'DUSD'}, {'owner': 'mk5RKGj4nNiVPhKvrVqkUh7oX2oGXvtXc5', 'source': '1.00000000@TSLA', 'destination': 'DUSD'}, {'owner': 'msyMCXeC12XwzJ8CbZTbDyDAem3PsWFrRJ', 'source': '1.00000000@TWTR', 'destination': 'DUSD'}]
</code></pre>
<h3 id="getpendingfutureswaps"><a class="header" href="#getpendingfutureswaps">getpendingfutureswaps</a></h3>
<p>Get all pending futures for a specific address.</p>
<h4 id="parameters--2"><a class="header" href="#parameters--2">Parameters :</a></h4>
<ul>
<li><code>address</code> : Address to get futures prices for.</li>
</ul>
<pre><code>defi-cli getpendingfutureswaps &lt;address&gt;
{'owner': '&lt;address&gt;', 'values': [{'source': '1.00000000@MSFT', 'destination': 'DUSD'}]}
</code></pre>
<h3 id="listgovs"><a class="header" href="#listgovs">listgovs</a></h3>
<p>All the governance variables related to this DFIP can be accessed via <code>listgovs</code></p>
<pre><code>defi-cli listgovs
{
    ...,
    &quot;ATTRIBUTES&quot;: {
    &quot;v0/params/dfip2203/active&quot;: &quot;true&quot;,
    &quot;v0/params/dfip2203/reward_pct&quot;: &quot;0.05&quot;,
    &quot;v0/params/dfip2203/block_period&quot;: &quot;20160&quot;,
    &quot;v0/token/10/dfip2203_disabled&quot;:&quot;true&quot;,
    }
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="guides"><a class="header" href="#guides">Guides</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="blockchain-node---defid"><a class="header" href="#blockchain-node---defid">Blockchain Node - defid</a></h1>
<p>DeFiChain is a distributed network of computers running software (known as nodes).
DeFiChain nodes are able to</p>
<ul>
<li>Store all blockchain data</li>
<li>Serve data to lightweight clients</li>
<li>Validate and propogate blocks and transactions</li>
</ul>
<p>Every DeFiChain node runs an implementation of the DeFiChain protocol, and can be run on local and cloud machines. The recommended requirements for running the reference <code>defid</code> node are</p>
<ul>
<li>Desktop or laptop hardware running recent versions of Windows, Mac OS X, or Linux.</li>
<li>Atleast 30 GB of disk space (Minimum: ~8GB)</li>
<li>Atleast 8 gigabytes of physical memory (RAM) (Minimum: ~1GB, but isn't recommended and sufficient swap is required)</li>
<li>4 GB of swap space (Minimum: None, but highly recommended to give room for memory fragmentation spikes)</li>
</ul>
<p>There are two ways start using the node - using the compiled releases or <a href="guides/./compiling.html">compiling the souce</a> code on your own.</p>
<h2 id="using-compiled-releases"><a class="header" href="#using-compiled-releases">Using compiled releases</a></h2>
<p>Download the latest available release from <a href="https://github.com/DeFiCh/ain/releases">Github</a>. Extract the archive by using an archive manager, or running the following command in a terminal</p>
<pre><code class="language-bash">tar xzf &lt;filename&gt;.tar.gz # replace &lt;filename&gt; with the filename downloaded file
</code></pre>
<p>You can run the following install command to globally install the DeFiChain binaries.</p>
<pre><code class="language-bash">sudo install -m 0755 -o root -g root -t /usr/local/bin &lt;defichain-path&gt;/bin/* # replace &lt;defichain-path&gt; with the path to the root of the extracted folder
</code></pre>
<p>Proceed to <a href="guides/defid.html#initial-block-download">Initial Block Download</a>.</p>
<h2 id="initial-block-download"><a class="header" href="#initial-block-download">Initial Block Download</a></h2>
<p>Once you have the required binaries available, you can start the node by running the following commands in the folder with the executables.</p>
<p>Linux and macOS: <code>./defid</code>
Windows: <code>defid.exe</code></p>
<p>This will start the node and the software will begin syncing blockchain data. Your wallets and transaction history will not be visible until the blockchain has been completely synced and up to date with the rest of the nodes. Currently the blockchain takes up <strong>around 4GB</strong> of disk space.</p>
<p>In order to speed up the process, you can download a snapshot from AWS.</p>
<ol>
<li>Stop the <code>defid</code> process.</li>
<li>Go to an AWS bucket and copy the filename of the latest (bottom most) snapshot.</li>
</ol>
<ul>
<li><a href="https://defi-snapshots-us.s3.amazonaws.com/index.txt">America</a></li>
<li><a href="https://defi-snapshots.s3.ap-southeast-1.amazonaws.com/index.txt">Asia</a></li>
<li><a href="https://defi-snapshots-sydney.s3.ap-southeast-2.amazonaws.com/index.txt">Australia</a></li>
<li><a href="https://defi-snapshots-europe.s3.eu-central-1.amazonaws.com/index.txt">Europe</a></li>
</ul>
<ol start="3">
<li>Replace <code>index.txt</code> in the URL with the filename from the previous step.</li>
<li>Extract the contents of the downloaded <code>.zip</code> file.</li>
<li>Copy the extracted contents into the <code>.defi</code> folder.
<ul>
<li>Windows: <code>C:\Users\&lt;username&gt;\AppData\Roaming\DeFi Blockchain</code></li>
<li>Linux: <code>~/.defi/</code></li>
<li>macOS: <code>/Users/&lt;username&gt;/Library/Application\ Support/DeFi</code></li>
</ul>
</li>
<li>Now restart the <code>defi</code> process. There will be a short syncing process to get the node up to date with the rest of the network.</li>
</ol>
<h2 id="interacting-with-the-node"><a class="header" href="#interacting-with-the-node">Interacting with the node</a></h2>
<p>Once <code>defid</code> is running, you interact with the node on a different terminal using the <code>defi-cli</code> application. You can run <code>./defi-cli help</code> to see a list of available commands.</p>
<p>Proceed to <a href="guides/./node/wallet.html">Using a wallet</a> to learn how to get started with using the node.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="upgrading-the-node"><a class="header" href="#upgrading-the-node">Upgrading the node</a></h1>
<p>Masternode operators and other users who want to upgrade their nodes to the latest release to access the latest features and guarantee compatibility with the latest version of the DeFi Blockchain.</p>
<blockquote>
<p><strong>NOTE</strong></p>
<p>DeFiChain Wallet users do not need to manually update the node as the wallet will handle the update for you.</p>
</blockquote>
<p>There are two types of releases:</p>
<ul>
<li><strong>Mandatory</strong>: contain breaking changes. You must upgrade before the upgrade block height for your node to remain in sync.</li>
<li><strong>Optional</strong>: optional but <em>highly reccomended</em>, usually include performance improvements.</li>
</ul>
<p>Mandatory upgrades are marked in the release notes on Github along with the block height before which you should upgrade.</p>
<p><img src="guides/../images/release.png" alt="" /></p>
<center><i>Mandatory upgrade note</i></center>
<p><code>defid</code> updates are usually drop in. Users can simply download and extract the latest <code>.zip</code> files from <a href="https://github.com/DeFiCh/ain/releases/latest">Github</a> and run them instead of the older binaries.</p>
<p>If you upgrade your node, have a wallet, and use a snapshot to reduce sync time, you should run a <code>-rescan</code> (and <code>-spv_resync</code> if you hold BTC) when running for the first time to update wallet balances.</p>
<p>Some releases might require additional parameters to be run on the first time with the new version, these will be stated in the release notes.</p>
<ul>
<li>Reindex required: run with <code>-reindex</code> flag</li>
<li>Rescan required: run with <code>-rescan</code> flag</li>
<li>Fresh sync: delete all files in and directories in the <code>.defi</code> folder except <code>wallets</code> and relaunch</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="compiling-from-source"><a class="header" href="#compiling-from-source">Compiling from source</a></h1>
<h2 id="using-makesh-debianubuntu-only"><a class="header" href="#using-makesh-debianubuntu-only">Using <code>make.sh</code> (Debian/Ubuntu only)</a></h2>
<p>By running <code>./make.sh build</code> will download install required dependencies and run the complete compilation process. Run <code>make install</code> at the end of the process to make the compiled binaries available globally.</p>
<h2 id="compiling-manually"><a class="header" href="#compiling-manually">Compiling manually</a></h2>
<ol>
<li>
<p>Install <code>gcc</code> and <code>boost</code> and other <a href="https://github.com/DeFiCh/ain/blob/master/doc/dependencies.md">dependecies</a> from your distribution's package manager.</p>
<p><em>Arch Linux</em></p>
<pre><code class="language-bash">sudo pacman -S gcc boost libevent python
</code></pre>
<p><em>Debian/Ubuntu</em></p>
<pre><code class="language-bash">sudo apt-get install build-essential libtool autotools-dev automake pkg-config bsdmainutils python3 curl ibssl-dev libevent-dev libboost-system-dev libboost-filesystem-dev libboost-chrono-dev libboost-test-dev libboost-thread-dev
</code></pre>
</li>
<li>
<p>Clone the latest version of <code>ain</code> from GitHub.</p>
<pre><code class="language-bash">git clone https://github.com/DeFiCh/ain.git
cd ain
</code></pre>
</li>
<li>
<p>Install Berekely DB.</p>
<pre><code class="language-bash">./contrib/install_db4.sh `pwd`
</code></pre>
<p>Once installation is complete, take note of the commands provided at the end of the build log.</p>
<pre><code class="language-bash">db4 build complete.

When compiling defid, run `./configure` in the following way:

export BDB_PREFIX='/home/DeFiCha/ain/contrib/db4'
./configure BDB_LIBS=&quot;-L${BDB_PREFIX}/lib -ldb_cxx-4.8&quot; BDB_CFLAGS=&quot;-I${BDB_PREFIX}/include&quot; ...
</code></pre>
</li>
<li>
<p>Now, run the export command from the DB compilation, then run <code>autogen.sh</code> and finally run the configure command from above.</p>
<pre><code class="language-bash">export BDB_PREFIX='/home/DeFiCha/ain/contrib/db4'
./autogen.sh
./configure BDB_LIBS=&quot;-L${BDB_PREFIX}/lib -ldb_cxx-4.8&quot; BDB_CFLAGS=&quot;-I${BDB_PREFIX}/include&quot;
</code></pre>
</li>
<li>
<p>We can now compile the node. Run <code>make</code> in the <code>ain</code> root directory.</p>
<pre><code class="language-bash">make #
make -j &quot;$(($(nproc)))&quot; # for multicore CPUs
</code></pre>
</li>
</ol>
<p><code>defid</code> and other DeFiChain executables will now be in the <code>src/</code> directory. You can run <code>make install</code> to access the compiled binaries globally.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="running-tests"><a class="header" href="#running-tests">Running tests</a></h1>
<p>If you make any changes to the DeFiChain code, you should always update and run tests in order to verify functionality and prevent regressions.</p>
<p>defid tests are located in the following locations</p>
<ul>
<li><a href="guides/testing.html#unit-tests"><code>/src/test</code></a>: defid unit tests</li>
<li><a href="guides/testing.html#unit-tests"><code>/src/wallet/test</code></a>: wallet unit tests</li>
<li><a href="guides/testing.html#functional-tests"><code>/test/functional</code></a>: test using RPC and P2P interfaces</li>
<li><a href="guides/testing.html#util-tests"><code>/test/util</code></a>: test the defi utilities</li>
<li><a href="guides/testing.html#lint-tests"><code>/test/lint</code></a>: static analysis checks</li>
</ul>
<p>Running tests in requires defid to be compiled locally. Click <a href="guides/./compiling.html">here</a> to learn more about how to compile locally.</p>
<h2 id="unit-tests-including-wallet-unit-tests"><a class="header" href="#unit-tests-including-wallet-unit-tests">Unit tests (including wallet unit tests)</a></h2>
<p>Unit tests are compiled unless disabled in <code>./configure</code>. After configuring and compiling, tests can be run by running <code>make check</code>, or by running the <code>test_defi</code> executable in <code>src/test</code>.</p>
<pre><code class="language-bash">make check              # run tests using make
./src/test/test_defi    # run tests using test_defi from project root
</code></pre>
<p>To run an unit test suite, you can pass the filename (without the path and extension) to the <code>--run_test</code> argument in <code>test_defi</code>.</p>
<pre><code class="language-bash">./src/test/test_defi --run_test=blockchain_tests
</code></pre>
<p>You can also run an individual unit test (denoted by <code>BOOST_AUTO_TEST_CASE</code> in test <code>.cpp</code> files) by specifying the test name after a <code>/</code>. For example, running the <code>get_difficulty_for_very_low_target</code> in <code>blockchain_tests.cpp</code> with <code>all</code> log level.</p>
<pre><code class="language-bash">./src/test/test_defi --run_test=blockchain_tests/get_difficulty_for_very_low_target --log_level=all
</code></pre>
<p><code>test_defi</code> has multiple configuration options, which can be listed by running <code>test_defi --help</code>.</p>
<h2 id="functional-tests"><a class="header" href="#functional-tests">Functional tests</a></h2>
<p>The ZMQ functional test requires a python ZMQ library. Install the <a href="https://pypi.org/project/pyzmq/"><code>pyzmq</code></a> dependency through pip or your system's package manager.</p>
<pre><code class="language-bash">pip install pyzmq
</code></pre>
<p>Once you have compiled defid, you can run tests by</p>
<ul>
<li>
<p>directly running the test's <code>.py</code> file</p>
<p>e.g. to run the <code>feature_block</code> tests, we would run</p>
<pre><code class="language-bash">python test/functional/feature_block.py
</code></pre>
</li>
<li>
<p>using <code>test_runner.py</code></p>
<p>e.g. to run the <code>feature_block</code> tests, we would run</p>
<pre><code class="language-bash">python test/functional/test_runner.py feature_block.py
</code></pre>
<p>Multiple tests can be run using the test runner.</p>
<pre><code class="language-bash">python test/functional/test_runner.py &lt;testname1&gt; &lt;testname2&gt; &lt;testname3&gt; ...
</code></pre>
<p>Wildcard test names can be passed, if the paths are coherent and the test runner is called from a <code>bash</code> shell or similar that supports <a href="https://en.wikipedia.org/wiki/Glob_(programming)">globbing</a>. For example, to run all the wallet tests</p>
<pre><code class="language-bash">python test/functional/test_runner.py test/functional/wallet*     # called from project root
python functional/test_runner.py functional/wallet*               # called from the test/ directory
python test_runner.py wallet*                                     # called from the test/functional/ directory
</code></pre>
<p>The paths must be consistent. The following does not work as <code>wallet*</code> is not defined at the project root.</p>
<pre><code class="language-bash">test/functional/test_runner.py wallet*
</code></pre>
<p>Combinations of wildcards can be passed. For example,</p>
<pre><code>test/functional/test_runner.py ./test/functional/tool* test/functional/mempool*
</code></pre>
<pre><code class="language-bash">test_runner.py tool* mempool*
</code></pre>
<p>Run the regression test suite with</p>
<pre><code>test/functional/test_runner.py
</code></pre>
<p>Run all possible tests with</p>
<pre><code>test/functional/test_runner.py --extended
</code></pre>
<p>By default, up to 4 tests will be run in parallel by test_runner. To specify how many jobs to run, append <code>--jobs=n</code></p>
<p>The individual tests and the test_runner harness have many command-line options.</p>
<ul>
<li><code>--ansi</code>: use ANSI colors and dots in output (enabled by default when standard output is a TTY)</li>
<li><code>--combinedlogslen</code>: on failure, print a log (of length n lines) to the console, combined from the test framework and all test nodes</li>
<li><code>--coverage</code>: generate a basic coverage report</li>
<li><code>--ci</code>: run checks and code that are usually only enabled in a continuous integration environment</li>
<li><code>--exclude</code>: specify a comma separated list of tests to exclude</li>
<li><code>--extended</code>: run the extended test suite in addition to the basic tests</li>
<li><code>--help</code>: print help text</li>
<li><code>--jobs</code>: how many test scripts to run in parallel, defaults to 4</li>
<li><code>--keepcache</code>: retain the cache from the previous testrun</li>
<li><code>--quiet</code>: only prints dots, results summary and failure logs</li>
<li><code>--tmpdirprefix</code>: directory for datadirs</li>
<li><code>--failfast</code>: stop execution after the first test failure</li>
<li><code>--filter</code>: run scripts by filtering using regex</li>
</ul>
</li>
</ul>
<h2 id="util-tests"><a class="header" href="#util-tests">Util tests</a></h2>
<p>Util tests can be run locally by running <code>test/util/defi-util-test.py</code>. Use the <code>-v</code> option for verbose output.</p>
<h2 id="lint-tests"><a class="header" href="#lint-tests">Lint tests</a></h2>
<p>Lint tests requires <a href="https://pypi.org/project/codespell/">codespell</a> and <a href="https://pypi.org/project/flake8/">flake8</a> dependencies, you can install them using pip or your system's package manager.</p>
<pre><code class="language-bash">pip install codespell flake8
</code></pre>
<p>Individual tests can be run by directly calling the test script.</p>
<pre><code class="language-bash">./test/lint/&lt;filename&gt;.sh
</code></pre>
<p>You can run all the shell-based lint tests by running <code>lint-all.sh</code>.</p>
<pre><code class="language-bash">./test/lint/lint-all.sh
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-a-wallet"><a class="header" href="#using-a-wallet">Using a wallet</a></h1>
<p>This document will go over how to create a wallet and addresses in order to send and recieve DFI and dTokens.</p>
<h2 id="using-testnet"><a class="header" href="#using-testnet">Using testnet</a></h2>
<p>In this tutorial we will use the testnet network in order to prevent any possibility of financial loss. Testnet is a separate network from mainnet for the purpose of testing. To use the testnet, stop the <code>defid</code> process, if any, and re-run it with the <code>-testnet</code> flag.</p>
<p>Linux and macOS: <code>./defid -testnet</code></p>
<p>Windows: <code>defid.exe -testnet</code></p>
<p>To verify that you are on the testnet, run <code>./defi-cli -testnet getblockchaininfo</code>. You should see an output similar to the following</p>
<pre><code>{
  &quot;chain&quot;: &quot;test&quot;,
  &quot;blocks&quot;: 919519,
  &quot;headers&quot;: 934011,
....
  },
  &quot;warnings&quot;: &quot;&quot;
}
</code></pre>
<p>If you see <code>&quot;chain&quot;: &quot;test&quot;</code>, you are on the testnet!</p>
<h2 id="creating-an-address"><a class="header" href="#creating-an-address">Creating an address</a></h2>
<p>To create an address, run</p>
<pre><code class="language-bash">./defi-cli -testnet getnewaddress
</code></pre>
<p>This will return a new DeFiChain address that you can use to recieve DFI and dTokens.</p>
<pre><code>tnLRVU32vCfGD6...
</code></pre>
<p>You will also require the private keys to this address in order to access your funds. Use the <code>dumpprivkey</code> command to retrieve the private key.</p>
<pre><code class="language-bash">./defi-cli -testnet dumpprivkey
</code></pre>
<p>This will return the corresponding private key to the input address.</p>
<pre><code>cRomqYvttzcXHq...
</code></pre>
<p><strong>Do not share your private keys with anyone.</strong></p>
<p>You can run the <code>listreceivedbyaddress</code> command to see available addresses and the amount of DFI available to each address.</p>
<pre><code>./defi-cli -testnet listreceivedbyaddress 1 true
</code></pre>
<p>Here the first parameter sets the minimum number of confirmations required to include the transaction, and the second parameters enables/disables addresses if they have 0 tokens. After running the command, you should be able to see the following output.</p>
<pre><code>[
  {
    &quot;address&quot;: &quot;tnLRVU32vCfGD6...&quot;,
    &quot;amount&quot;: 0.00000000,
    &quot;confirmations&quot;: 0,
    &quot;label&quot;: &quot;&quot;,
    &quot;txids&quot;: [
    ]
  }
]
</code></pre>
<p>You can also use the <code>getwalletinfo</code> command to see aggregate information if you have generated multiple addresses.</p>
<pre><code>./defi-cli -testnet getwalletinfo
</code></pre>
<pre><code>{
  &quot;walletname&quot;: &quot;&quot;,
  &quot;walletversion&quot;: 169900,
  &quot;balance&quot;: 0.00000000,
  &quot;unconfirmed_balance&quot;: 0.00000000,
  &quot;immature_balance&quot;: 0.00000000,
  &quot;txcount&quot;: 4,
  &quot;keypoololdest&quot;: 1646714869,
  &quot;keypoolsize&quot;: 999,
  &quot;keypoolsize_hd_internal&quot;: 1000,
  &quot;paytxfee&quot;: 0.00000000,
  &quot;hdseedid&quot;: &quot;c43d012bb7c93cd9129dfc42b6643de774b2502f&quot;,
  &quot;private_keys_enabled&quot;: true,
  &quot;avoid_reuse&quot;: false,
  &quot;scanning&quot;: false
}
</code></pre>
<h2 id="getting-some-testnet-dfi"><a class="header" href="#getting-some-testnet-dfi">Getting some testnet DFI</a></h2>
<h2 id="creating-a-transaction"><a class="header" href="#creating-a-transaction">Creating a transaction</a></h2>
<p>Once you have some DFI in your wallet, you use it to create a vault and mint dTokens, or send it to other addresses. There are two options to create a transaction, writing a raw transaction or using the P2PKH template. We will go over sending DFI to another address using the P2PKH template.</p>
<p>Verify your wallet balance using the <code>getbalance</code> command.</p>
<pre><code>./defi-cli -testnet getbalance
</code></pre>
<pre><code>39999.99999160
</code></pre>
<p>You can now use the <code>sendtoaddress</code> command to send DFI.</p>
<pre><code>./defi-cli -testnet sendtoaddress tiiUqg4TqGR7ja... 1
</code></pre>
<p>The value after the address sets the amount of DFI to transfer. The command will output the new transaction ID.</p>
<pre><code>23ee92302e166daf540d358fa726d52ff391f9f3058636ca45d887c747cd8610
</code></pre>
<p>You can inspect the transaction using the <code>gettransaction</code> or <code>getrawtransaction</code> command.</p>
<pre><code>./defi-cli -testnet gettransaction 23ee92302e166daf540d358fa726d52ff391f9f3058636ca45d887c747cd8610
./defi-cli -testnet getrawtransaction 23ee92302e166daf540d358fa726d52ff391f9f3058636ca45d887c747cd8610 true dbbe9b1e4f116d9316a9d1dc024fd4301b72e1f18ed1706fb59711315844a7ff
                                        ^transaction hash                                               ^verbosity          ^block hash
</code></pre>
<p>Sample output for <code>gettransaction</code></p>
<pre><code>{
  &quot;amount&quot;: 0.00000000,
  &quot;fee&quot;: -0.00000840,
  &quot;confirmations&quot;: 4,
  &quot;blockhash&quot;: &quot;dbbe9b1e4f116d9316a9d1dc024fd4301b72e1f18ed1706fb59711315844a7ff&quot;,
  &quot;blockindex&quot;: 1,
  &quot;blocktime&quot;: 1647880878,
  &quot;txid&quot;: &quot;23ee92302e166daf540d358fa726d52ff391f9f3058636ca45d887c747cd8610&quot;,
  &quot;walletconflicts&quot;: [
  ],
  &quot;time&quot;: 1647880831,
  &quot;timereceived&quot;: 1647880831,
  &quot;bip125-replaceable&quot;: &quot;no&quot;,
  &quot;details&quot;: [
    {
      &quot;address&quot;: &quot;tnLRVU32vCfGD6BB5TywSBgHwre84WrZK8&quot;,
      &quot;category&quot;: &quot;send&quot;,
      &quot;amount&quot;: -1.00000000,
      &quot;label&quot;: &quot;&quot;,
      &quot;vout&quot;: 0,
      &quot;fee&quot;: -0.00000840,
      &quot;abandoned&quot;: false
    },
    {
      &quot;address&quot;: &quot;tnLRVU32vCfGD6BB5TywSBgHwre84WrZK8&quot;,
      &quot;category&quot;: &quot;receive&quot;,
      &quot;amount&quot;: 1.00000000,
      &quot;label&quot;: &quot;&quot;,
      &quot;vout&quot;: 0
    }
  ],
  &quot;hex&quot;: &quot;04000000000101a421ebc69f999ea8db7e0322994965518a28e0ed109880bfd9b51a080242586a0000000017160014bf34bd468bc453c1bcce04445bdcd9e1a9838d11feffffff0200e1f5050000000017a914b04e136a8b1618588d89fc7cb8a473059f152fe587007028afcee800000017a9140d935d41bb352dc51b3cf74cf4b74fa322870bf087000247304402204e597c4f7bb4345291dc8aa279015bc878a0da47f1f6886015d78bd69a9def8902202a6db23424d34a303643c8246901febe45adc8c2d261e8c029c49d9a090c12070121020f01f4b43f304835d9860fe1ab874962c9dc4093a5264547b708b6b174a1627aaf400e00&quot;
}
</code></pre>
<p>The other address should recieve the tokens as soon as the transaction is included in a block!</p>
<h2 id="security"><a class="header" href="#security">Security</a></h2>
<p>Your wallet is <strong>not encrypted by default</strong>. This means that anyone with physical access to your computer or wallet file will be able to access your funds. For any wallets with real DFI or dTokens, make use of the <code>encryptwallet</code> command to encrypt your wallet, and use <code>walletlock</code> lock your wallet with a password and prevent hackers from accessing your funds.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="loans-1"><a class="header" href="#loans-1">Loans</a></h1>
<h1 id="table-of-contents"><a class="header" href="#table-of-contents">Table of contents</a></h1>
<ol>
<li><a href="guides/loans.html#1-introduction">Introduction</a></li>
<li><a href="guides/loans.html#2-loans-in-defichain">Loans in DeFiChain</a></li>
<li><a href="guides/loans.html#3-main-concepts">Main concepts</a>
<ul>
<li><a href="guides/loans.html#collateral">Collateral</a>
<ul>
<li><a href="guides/loans.html#collateralization-ratio">Collateralization ratio</a></li>
<li><a href="guides/loans.html#over-collateralization">Over-collateralization</a></li>
<li><a href="guides/loans.html#collateralization-factor">Collateralization factor</a></li>
</ul>
</li>
<li><a href="guides/loans.html#minting">Minting</a></li>
<li><a href="guides/loans.html#loan-scheme">Loan scheme</a>
<ul>
<li><a href="guides/loans.html#minimum-collateralization-ratio">Minimum collateralization ratio</a></li>
<li><a href="guides/loans.html#interest-rate">Interest rate</a></li>
</ul>
</li>
<li><a href="guides/loans.html#price-and-fixed-interval-price">Price and Fixed Interval Price</a></li>
<li><a href="guides/loans.html#liquidation">Liquidation</a>
<ul>
<li><a href="guides/loans.html#liquidation-penalty">Liquidation penalty</a></li>
</ul>
</li>
<li><a href="guides/loans.html#vault">Vault</a>
<ul>
<li><a href="guides/loans.html#vault-state">Vault state</a></li>
<li><a href="guides/loans.html#50-rule">50% rule</a></li>
</ul>
</li>
<li><a href="guides/loans.html#auction">Auction</a>
<ul>
<li><a href="guides/loans.html#auction">Auction batch</a></li>
<li><a href="guides/loans.html#example">Example</a></li>
<li><a href="guides/loans.html#collateral-auction-example">Collateral auction example</a></li>
<li><a href="guides/loans.html#failed-auction">Failed auction</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="guides/loans.html#4-rpc">RPC</a>
<ul>
<li><a href="guides/loans.html#loan-scheme-rpcs">Loan scheme RPCs</a></li>
<li><a href="guides/loans.html#loan-tokens-rpcs">Loan tokens RPCs</a></li>
<li><a href="guides/loans.html#collateral-tokens-rpcs">Collateral tokens RPCs</a></li>
<li><a href="guides/loans.html#vault-rpcs">Vault RPCs</a></li>
<li><a href="guides/loans.html#auction-rpcs">Auction RPCs</a></li>
<li><a href="guides/loans.html#helper-rpcs">Helper RPCs</a></li>
</ul>
</li>
</ol>
<h1 id="1-introduction"><a class="header" href="#1-introduction">1. Introduction</a></h1>
<p>In this document we will try to understand how loans work inside DeFiChain and how they differ from traditional lending services in CeFi (Centralized Finance).</p>
<blockquote>
<p><strong>NOTE</strong></p>
<p>We will be speaking a lot about <strong>amount</strong> and <strong>value</strong> when talking about dTokens, collaterals, loans and interests. It is important to make clear the difference between both.</p>
<p>Amount is the quantity of the referred asset and value is the conversion to $ taken from the oracles.</p>
<p>To make this more clear lets see an example:</p>
<blockquote>
<p>Given 10dTSLA with each tesla priced at 100$:</p>
<p>Amount = 10</p>
<p>Value = 10dTSLA * 100$ = 1000$</p>
</blockquote>
</blockquote>
<p>This documentation is in continuous development, feel free to open an issue or Pull Request to the <a href="https://github.com/DeFiCh/handbook">official repository</a>.</p>
<h1 id="2-loans-in-defichain"><a class="header" href="#2-loans-in-defichain">2. Loans in DeFiChain</a></h1>
<p>To better understand the difference between DeFiChain loans and traditional loans lets start by looking at the definition of traditional <em>loan</em> by the Cambridge Dictionary:</p>
<blockquote>
<blockquote>
<p><em>Loan: An amount of money that is borrowed, often from a bank, and has to be paid back, usually together with an extra amount of money that you have to pay as a charge for borrowing</em></p>
</blockquote>
</blockquote>
<p>Lets adjust this definition to fit in the DeFiChain's implementation of loans.</p>
<blockquote>
<p><em>&quot;an amount of money that is borrowed, often from bank, and has to be paid back...&quot;</em>.</p>
</blockquote>
<p>When operating in DeFiChain it is more accurate to talk about loan tokens or dTokens instead of borrowed money as all operations regarding loans. Moreover, loan tokens are not borrowed like in traditional finance as there is no one lending the assets in the other side. Instead, loan tokens are <a href="guides/loans.html#minting">minted</a>, this is how we call the process to create new dTokens on the blockchain.</p>
<p>For a better understanding of dTokens please have a look at this <a href="https://blog.defichain.com/what-are-decentralised-stock-tokens-and-how-do-they-work/">blog post</a>. For now lets say, <em>borrowed money</em>=loan tokens.</p>
<p>Continuing with the adaptation of the definition, in DeFi (Decentralized finance) there are no central authorities so we can remove any reference to banks. Again, the key part to understand here is that there is not one specific person nor entity approving or rejecting a loan, the network through consensus rules and algorithms will be in charge of providing users for their loans tokens.</p>
<p>The last part <em>&quot;...and has to be paid back.&quot;</em> needs also some refactoring as in DeFiChain <strong>loans have no due date</strong>. In DeFiChain loans need to be backed up by collateral tokens value. We can spot a similar behaviour in traditional finance where the bank asks for a deposit of value as a guarantee (a house, a car...) in return of a certain amount of money.</p>
<p>Applying the changes mentioned, our definition of loan is now:</p>
<blockquote>
<p>An amount of loan tokens that is minted, <del>often from a bank</del>, and which value has to be backed up by collateral during the loan's life cycle.</p>
</blockquote>
<p>The loan's life cycle ends when a loan is fully paid back, i.e. all dTokens + interests are returned to the vault.</p>
<pre class="mermaid">graph LR;
    id1(Create vault) --&gt; id2(Deposit collateral);
    id2 --&gt; id3(Take loan);
    subgraph Loan life cycle;
    direction LR;
    id3 --&gt; id4(...);
    id4 --&gt; id5(Accrue interest);
    id5 --&gt; id6(...);
    id6 --&gt; id7(Payback loan + interest);
    id7 --&gt; id3;
    end;
    id7 --&gt; id8(Close vault)
</pre>
<p>Now lets continue to the second part of the initial definition:</p>
<blockquote>
<p><em>&quot;...usually together with an extra amount of money that you have to pay as a charge for borrowing&quot;</em></p>
</blockquote>
<p>This part talks about <strong>interests</strong> and of course DeFiChain loans also generate interests. Each vault subscribes to a <a href="guides/loans.html#loan-scheme">loan scheme</a>, this loan scheme sets the amount of interest that the minted tokens will generate. Also dTokens can be set to generate interests themselves regardless the vault they operate in. This is explained in detail in the <a href="guides/loans.html#interests">interests</a> definition.</p>
<p>Now we are finished with the adaptation of the definition to suit the DeFiChain implementation of loans, lets have a look at the final result:</p>
<blockquote>
<p>An amount of dToken that is minted and which value + interests has to be backed up by collateral during the loan's life cycle.</p>
</blockquote>
<h1 id="3-main-concepts"><a class="header" href="#3-main-concepts">3. Main concepts</a></h1>
<p>In this section you will find a detailed explanation of the concepts and key aspects regarding loans in DeFiChain.</p>
<h2 id="collateral"><a class="header" href="#collateral">Collateral</a></h2>
<p>Collateral is the guarantee deposited into a <a href="guides/loans.html#vault">vault</a> that let vault owners mint dTokens in DeFiChain i.e., take a loan. This collateral will be locked in the vault until a <a href="guides/">withdraw</a> or <a href="guides/loans.html#closevault">closevault</a> operation succeeds.</p>
<h3 id="collateralization-ratio-1"><a class="header" href="#collateralization-ratio-1">Collateralization ratio</a></h3>
<p>The collateralization ratio is the value of the deposit with respect to the value of the minted or loan tokens plus the interests.</p>
<p>It is calculated using the following formula:</p>
<pre><code>Collateralization ratio =
    Total value of collateral /
    (Total value of tokens minted + Total value interest)
</code></pre>
<h3 id="over-collateralization"><a class="header" href="#over-collateralization">Over-collateralization</a></h3>
<p>Vaults follow an over-collateralization mechanism, i.e., the value of the collateral locked in a vault must be of greater value than the one of the minted dTokens + the interests. How much a vault must be over-collateralized is defined by the <a href="guides/loans.html#minimum-collateralization-ratio">minimum collateralization ratio</a>. This is set by the <a href="guides/loans.html#loan-scheme">loan scheme</a> the vault subscribes to.</p>
<h3 id="collateralization-factor-1"><a class="header" href="#collateralization-factor-1">Collateralization factor</a></h3>
<p>Assets that are accepted for collateralization could be accepted at different collateralization factors, from 0% to 100%. When an asset's collateralization factor is 100%, the entirety of the asset's value contributes to the collateralization value of the vault, however, if an asset's collateralization factor is say 50%, then only half of its value contributes to the total vault's collateral.</p>
<p>For example if <code>DOGE</code> is accepted at 70% collateralization factor, $100 worth of <code>DOGE</code> would contribute to $70 of collateral value in a vault.</p>
<p>This is not to be confused with <a href="guides/loans.html#collateralization-ratio"><em>collateralization ratio</em></a>.</p>
<h2 id="minting"><a class="header" href="#minting">Minting</a></h2>
<p>Minting dTokens is the process by which dTokens are created in DeFiChain. dTokens in DeFiChain can be minted by creating a vault, depositing collateral and taking a loan. As vaults are over-collateralized, this process ensures that all dTokens are backed up by the collaterals locked in vaults at all times.</p>
<p>This loaned tokens can be freely used for other purposes like adding liquidity to a pool, swaping in a liquidity pool or transfer to another address.</p>
<h2 id="loan-scheme-2"><a class="header" href="#loan-scheme-2">Loan scheme</a></h2>
<p>Loan schemes are structures that define the conditions vaults adhere to.</p>
<p>A loan scheme has the following information:</p>
<ul>
<li>An <code>Id</code> (String) used as a unique identifier of the loan scheme.</li>
<li>A <code>minimum collateralization ratio</code> (Natural number greater or equal to 100)</li>
<li>An <code>interest rate</code> (positive rational number from 0-100)</li>
</ul>
<p>Lets see some examples of possible loan schemes:</p>
<ul>
<li>Id: &quot;LOAN150&quot;. Min collateralization ratio: 150%. Interest rate: 5% APR.</li>
<li>Id: &quot;LOAN175&quot;. Min collateralization ratio: 175%. Interest rate: 3% APR.</li>
<li>Id: &quot;LOAN200&quot;. Min collateralization ratio: 200%. Interest rate: 2% APR.</li>
<li>Id: &quot;LOAN350&quot;. Min collateralization ratio: 350%. Interest rate: 1.5% APR.</li>
<li>Id: &quot;LOAN500&quot;. Min collateralization ratio: 500%. Interest rate: 1% APR.</li>
<li>Id: &quot;LOAN1000&quot;. Min collateralization ratio: 1000%. Interest rate: 0.5% APR.</li>
</ul>
<p>Following the above list, a vault subscribed to &quot;LOAN150&quot; would need to have always a <a href="guides/loans.html#collateralization-ratio">collateralization ratio</a> over 150% and it's loans will generate a 5% interest per year.</p>
<h2 id="price-and-fixed-interval-price"><a class="header" href="#price-and-fixed-interval-price">Price and fixed interval price</a></h2>
<p>Price in DeFiChain can be found in two forms:</p>
<ul>
<li>DEX price: obtained by the balance inside the liquidity pools.</li>
<li>Oracle price: retrieved from the actual asset represented by the dToken outside DeFiChain.</li>
</ul>
<p>Oracles are trusted services that inject this prices directly into DeFiChain. Read more about oracles <a href="guides/../pinkpaper/price-oracle">here</a>.</p>
<p>The important thing to understand here is that these prices are different and each is used for different purposes. For instance, when we talk about value, this is calculated with the oracle price and not with the DEX price. DEX price in the other hand is used when swapping between dTokens and DFI to burn the interests or the penalty generated by a vault being liquidated.</p>
<h3 id="fixed-interval-price"><a class="header" href="#fixed-interval-price">Fixed Interval Price</a></h3>
<p>Is a mechanism to provide users time to prevent the liquidation of their vaults when the price of the collateral tokens or loan tokens is unstable. This is achieved by fixing the price of the tokens each 120 blocks (~1 hour) for vault calculations.</p>
<p>There are in reality three prices for each dToken all of them taken from the oracles:</p>
<div id="active-price"></div>
<ul>
<li><code>Active price</code>: the price used for <a href="guides/loans.html#collateralization-ratio">collateralization ratio</a> calculation.</li>
</ul>
<div id="current-price"></div>
<ul>
<li><code>Current price</code>: this is the live price of the oracle used to calculate the dTokens that can be minted within a vault at the time of taking the loan.</li>
</ul>
<div id="next-price"></div>
<ul>
<li><code>Next price</code>: the next price that will be used for calculations, i.e. the next price that will become active.</li>
</ul>
<div id="invalid-price"></div>
<p>Token price feeds become invalid in the following scenarios:</p>
<ul>
<li>Active price and next price deviation is over 30%</li>
<li>Active price is 0.</li>
<li>Next price is 0.</li>
<li>There are less than two active oracles for that price feed.</li>
</ul>
<h3 id="minimum-collateralization-ratio"><a class="header" href="#minimum-collateralization-ratio">Minimum collateralization ratio</a></h3>
<p>This is one of the most important aspects to understand vaults functioning and to do a proper risk management of your loans. The minimum collateralization ratio sets a threshold that will trigger the <a href="guides/loans.html#liquidation">liquidation</a> of a vault if crossed. Basically if <a href="guides/loans.html#collateralization-ratio">collateralization ratio</a> falls under this number, the collaterals locked will be publicly auctioned along with a penalty fee.</p>
<p>We will cover the liquidation process later but for now take a note to remember that <strong>you want your vault's collateralization ratio to be always over the minimum collateralization ratio.</strong></p>
<h3 id="interest-rate-1"><a class="header" href="#interest-rate-1">Interest rate</a></h3>
<p>Interest rate for loan consists of 2 parts:</p>
<ul>
<li>Vault interest, based on loan scheme of individual vaults.</li>
<li>Token interest, based on loan tokens, e.g. <code>TSLA</code> token might have its own interest that is chargeable only for <code>TSLA</code> token.</li>
</ul>
<p><a href="guides/../fees">DeFi fees</a> are burned. Fees are typically collected in the form of the loan token repayment, and automatically swapped on DEX for DFI to be burned.</p>
<p>For example, if a loan of 100 <code>TSLA</code> is taken out and repaid back exactly 6 months later with the APR of 2%, the user will have to repay 101 <code>TSLA</code> during redemption to regain full access of collateral in the vault.</p>
<p>100 <code>TSLA</code> will be burned as part of the repayment process. 1 <code>TSLA</code> that forms the interest payment will be swapped on DEX for DFI. The resulting DFI will burned. All of these occur atomically as part of DeFiChain consensus.</p>
<h2 id="liquidation-1"><a class="header" href="#liquidation-1">Liquidation</a></h2>
<p>Liquidation starts when the <a href="guides/loans.html#collateralization-ratio">collateralization ratio</a> of a vault falls below the <a href="guides/loans.html#minimum-collateralization-ratio">minimum collateralization ratio</a> set by the loan scheme a vault subscribes to. Liquidation is crucial in ensuring that all loan tokens are sufficiently over-collateralized to support its price.</p>
<p>For Turing-complete VM-based blockchain, liquidation requires the assistance of publicly run bots to trigger it, in exchange for some incentives.</p>
<p>There are two problems with that:</p>
<ul>
<li>During major price movements, the network fee, or commonly known as gas price, would sky rocket due to a race by both the vault owners frantically trying to save their vaults from getting liquidated, and by the public liquidators trying to trigger liquidation.</li>
<li>If liquidations are not triggered on time, tokens that are generated as a result of loan runs the risk of losing its values. Worse scenario would see it getting into a negative feedback loop situation creating a rapid crash of token values.</li>
</ul>
<p>DeFiChain, a blockchain that's built for specifically for DeFi, enjoy the benefit of automation and can have liquidation trigger automatically on-chain. This address the above two problems.</p>
<h3 id="liquidation-penalty"><a class="header" href="#liquidation-penalty">Liquidation penalty</a></h3>
<p>If a vault gets liquidated then a penalty fee is charged. Default penalty is set to 5% of the total value of the minted dTokens including interest value.</p>
<h2 id="vault-3"><a class="header" href="#vault-3">Vault</a></h2>
<p>A vault is the place where <a href="guides/loans.html#collateral">collaterals</a> (guarantee) and loans (minted dTokens) are handled. It is also accountant of the generated interests over time.</p>
<p>Vaults are identified by a unique <code>Id</code> on the blockchain. This <code>Id</code> is the transaction hash of the creation of the vault, meaning the return of the <a href="guides/loans.html#createvault"><code>createvault</code></a> RPC command.
To create an empty vault only a valid address is needed, nothing else. If a loan scheme is not set upon creation, the vault will be subscribed to the default loan scheme.</p>
<p>There are many actions that can be made regarding vaults. The following actions can only be performed by the owner of the vault:</p>
<ul>
<li>Update the vault (change owner address and/or loan scheme).</li>
<li>Deposit collateral.</li>
<li>Take a loan (mint dTokens).</li>
<li>Withdraw collaterals from the vault.</li>
<li>Close the vault.</li>
</ul>
<p>Other actions that can be performed by anyone in the blockchain:</p>
<ul>
<li>Create a vault.</li>
<li>Pay back a loan.</li>
</ul>
<p>There are also actions that aim to retrieve vault information and help with the calculation estimation.</p>
<p>This commands can also be run by any node in the network:</p>
<ul>
<li>Get a vault's current information.</li>
<li>List a vault's history (collateral ratios, actions, value changes, states...)</li>
<li>Estimate loan. (return the maximum amount of dToken that can be minted with the current collateral value locked in a vault)</li>
<li>Estimate collateral. (return the minimum amount of collateral needed under a certain loan scheme to mint a given number of dTokens)</li>
<li>Estimate vault. (give back the estimation of collateral value, loan value and ratios that a vault would have given an amount of collaterals and an amount of minted tokens)</li>
</ul>
<p>This is just an introduction to the several actions you can make around vaults. All this actions are translated into RPC commands and will be covered in depth in the <a href="guides/loans.html#rpc">RPC section</a> of this paper.</p>
<h3 id="vault-state"><a class="header" href="#vault-state">Vault state</a></h3>
<p>Depending on the <a href="guides/loans.html#fixed-interval-price">status of the dTokens</a> and the balance between the assets in a vault (collaterals, loans and interests), the vault will be subject to enter different states:</p>
<ul>
<li><code>active</code>: <a href="guides/loans.html#collateralization-ratio">collateralization ratio</a> is over the <a href="guides/loans.html#minimum-collateralization-ratio">minimum collateralization ratio</a> and both collaterals and loans price feeds are valid.</li>
<li><code>frozen</code>: collateral or loan price feed is <a href="guides/loans.html#invalid-price">invalid</a>.</li>
<li><code>inLiquidation</code>: <a href="guides/loans.html#collateralization-ratio">collateralization ratio</a> is below the <a href="guides/loans.html#minimum-collateralization-ratio">minimum collateralization ratio</a> thus vault is under liquidation and has undergoing auctions. When a vault enters in liquidation state, it can no longer be used until all the loan amount is repaid, only then the vault will be reopened. Interest accrual is also stopped during liquidation process.</li>
<li><code>mayLiquidate</code> : <a href="guides/loans.html#collateralization-ratio">collateralization ratio</a> calculated with <a href="guides/loans.html#next-price">next price</a> is below <a href="guides/loans.html#minimum-collateralization-ratio">minimum collateralization ratio</a>, meaning the vault will liquidate at the next price update unless loan is paid back or collateral deposited.</li>
</ul>
<p>Every time an action in the vault is triggered, the state is checked to allow or deny the execution of the action. This table represents the action/state relation:</p>
<table><thead><tr><th>Action/State</th><th>Active</th><th>Frozen</th><th>InLiquidation</th><th>MayLiquidate</th></tr></thead><tbody>
<tr><td>Update</td><td>✅</td><td>❌</td><td>❌</td><td>✅</td></tr>
<tr><td>Take loan</td><td>✅</td><td>❌</td><td>❌</td><td>✅</td></tr>
<tr><td>Withdraw collateral</td><td>✅</td><td>❌</td><td>❌</td><td>✅</td></tr>
<tr><td>Close</td><td>✅</td><td>✅</td><td>❌</td><td>❌</td></tr>
<tr><td>Deposit collateral</td><td>✅</td><td>✅</td><td>❌</td><td>✅</td></tr>
<tr><td>Loan payback</td><td>✅</td><td>❌</td><td>❌</td><td>✅</td></tr>
</tbody></table>
<p>*All other actions can occur regardless the state of the vault.</p>
<p>Now as you can see in the table nothing can be done once a vault enters the <code>inLiquidation</code> state, so what happens when a vault gets liquidated? DeFiChain starts the liquidation process and a public auction takes place.</p>
<p>We will explore the details of these auctions in the next section.</p>
<h3 id="50-rule"><a class="header" href="#50-rule">50% rule</a></h3>
<p>This rule applies to vaults and particularly to collaterals. The rule states:</p>
<blockquote>
<blockquote>
<p>At least 50% of the minimum required collateral must be in <code>DFI</code> or/and <code>DUSD</code>.</p>
</blockquote>
</blockquote>
<h4 id="example-1"><a class="header" href="#example-1">Example</a></h4>
<p>Having a vault which has a <a href="guides/loans.html#minimum-collateralization-ratio">minimum collateralization ratio</a> of 100%. This means the minimum collateral needed would be equal to the value of the loan taken. i.e. If we have 1000$ of dTSLA we would need a minimum of 1000$ of collateral.</p>
<p>Following with the example, this rule forces the vault owner to have at least 50% of the 1000$ collateral either in DFI, DUSD or the sum of both. For instance, having 1000$ of dBTC as collateral would break this rule, we would need at least 500$ (DUSD+DFI) and 500$ in dBTC as collateral.</p>
<p>This rule only affects <code>takeloan</code> action. This means no loan can be taken in a vault that breaks the <code>50% rule</code>.</p>
<h2 id="auction-1"><a class="header" href="#auction-1">Auction</a></h2>
<p>An auction is the mechanism implemented in DeFiChain to recover the dTokens that are at risk of not being backed up by collaterals in vaults. As we have seen, vaults are <a href="guides/loans.html#over-colateralization">over-collateralized</a> so this auctions are triggered way before the dTokens are at risk of not being backed up by the value of the collaterals.</p>
<h3 id="auction-batch"><a class="header" href="#auction-batch">Auction batch</a></h3>
<p>The entirety of loan and collateral of a vault is put up for auction along with the <code>LOAN_LIQUIDATION_PENALTY</code>. As the first version of collateral auction requires bidding of the full amount, auction is automatically split into <strong>batches</strong> of around $10,000 worth each to facilitate for easier bidding.</p>
<p>A batch contains the relevant information for bidders:</p>
<ul>
<li>minimum bid amount of dToken</li>
<li>amount of collaterals that the winner of the auction will receive.</li>
</ul>
<p>Batches may contain multiple collateral tokens, but not more than one loan token.</p>
<p>For instance, a liquidating vault that consists of the following:</p>
<ul>
<li>Collateral: 1 dBTC &amp; 100 DFI</li>
<li>Loan: $10k worth of DUSD * $40k worth TSLA</li>
</ul>
<p>would be liquidated as follows:</p>
<ul>
<li>(0.2 dBTC &amp; 20 DFI) for $10k worth of DUSD</li>
<li>(0.8 dBTC &amp; 80 DFI) for $40k worth of dTSLA</li>
</ul>
<p>and further split into $10k batches.</p>
<h3 id="example-2"><a class="header" href="#example-2">Example</a></h3>
<p>A vault, that requires a minimum of 150% collateralization ratio contains $15,000 worth of collateral, which consists of $10,000 worth of DFI and $5,000 worth of dBTC, and the total loan, inclusive of interest, is $11,000 worth.</p>
<ul>
<li>Collateral: $10,000 DFI + $5,000 dBTC</li>
<li>Loan: $10,000 <code>dTSLA</code> + $1,000 interest (<code>dTSLA</code>)</li>
</ul>
<p>Collateralization ratio = 15k / 11k = 136.36% less than the required 150%. Liquidation is triggered automatically by consensus. Auction will be initiated with the intention to liquidate $15k of collateral to recover $11k of loan.</p>
<p>Liquidation penalty is defined as <code>LOAN_LIQUIDATION_PENALTY</code>. The amount to be recovered should also include the penalty. If <code>LOAN_LIQUIDATION_PENALTY</code> is 0.05, the total amount to be recovered is thus $11k * 1.05 = $11,550</p>
<p>Total collateral worth is $15k, it will thus be split into 2 batches, each not exceeding $10k:</p>
<ol>
<li>2/3 of the whole vault, worth $10k of collateral.</li>
<li>1/3 of the whole vault, worth $5k of collateral.</li>
</ol>
<p>Specifically the following:</p>
<ol>
<li>($6,667 DFI and $3,333 dBTC) for $7,700 <code>dTSLA</code></li>
<li>($3,333 DFI and $1,667 dBTC) for $3,850 <code>dTSLA</code></li>
</ol>
<p><code>dTSLA</code> recovered at the conclusion of the auction will be paid back to the vault. Once all loan is repaid, vault will exit liquidation state, allowing its owner to continue to use it. It will, however, not terminate all opened auctions. Opened auctions see through to their conclusion.</p>
<h2 id="collateral-auction-example"><a class="header" href="#collateral-auction-example">Collateral auction example</a></h2>
<p>Collateral auction will run for 720 blocks (approximately 6 hours) with the starting price based on liquidation vault's ratio.</p>
<p>Using the same illustration, Auction 1: ($6,667 DFI and $3,333 dBTC) for $7,700 <code>dTSLA</code></p>
<p>Anyone can participate in the auction, including the vault owner by bidding for the entirety of the auction with higher amount. To prevent unnecessary auction sniping at closing blocks, each higher bid, except the first one, has to be at least 1% higher than previous bid.</p>
<p>A user could bid for the same auction by offering $7,800 worth of <code>dTSLA</code> tokens. During bidding, the bid is locked and refunded immediately when outbid. Top bid is not cancelable.</p>
<p>At the conclusion of the auction, the entirety of the for sale collateral will be transferred to the winner – in this case the winner would be paying $7,800 for $10,000 worth of BTC and DFI.</p>
<p>$7,800 worth of <code>dTSLA</code> token will be processed as follow:</p>
<ul>
<li>Paid back to vault = $7,800 worth of <code>dTSLA</code> / (1 + <code>LOAN_LIQUIDATION_PENALTY</code>) = 7800 / 1.05 = $7,428.57 <code>dTSLA</code> token</li>
<li>The remaining, i.e. liquidation penalty, will be swapped to DFI and burned. $371.43 worth of <code>dTSLA</code> be swapped as follows and  trackably burned:
<ol>
<li><code>dTSLA</code> to <code>DUSD</code> from <code>dTSLA-DUSD</code> DEX.</li>
<li><code>DUSD</code> to <code>DFI</code> from <code>DUSD-DFI</code> DEX.</li>
</ol>
</li>
</ul>
<p>If auctions yield more <code>dTSLA</code> than the vault's loan, it will be deposited back to the vault as part of vault's asset, but not collateral. It can be withdrawn from the vault after vault exits liquidation state by vault's owner and carries no interest.</p>
<h2 id="failed-auction-1"><a class="header" href="#failed-auction-1">Failed auction</a></h2>
<p>Auction that expires after 720 blocks without bids will be reopened immediately based on the remaining amount of collateral and loan that the vault receives due to conclusion of other auction batches.</p>
<h1 id="4-rpc"><a class="header" href="#4-rpc">4. RPC</a></h1>
<p>Now we will go through all the different RPCs implemented in DeFiChain to handle loans.</p>
<blockquote>
<p>Note: In this section a red asterisk <span style="color: red">*</span> means the parameter is required. If no asterisk is present the argument will then be optional.</p>
</blockquote>
<div id="loan-scheme-rpcs"></div>
<h2 id="loan-scheme-rpcs"><a class="header" href="#loan-scheme-rpcs">Loan scheme RPCs</a></h2>
<div id="createloanscheme"></div>
<ul>
<li>
<p><code>createloanscheme</code>:</p>
<p>Is used to create a loan scheme. The first loan scheme created will be set as the default loan scheme.</p>
<p>Arguments:</p>
<ul>
<li><code>mincolratio</code><span style="color: red">*</span>: e.g. 175 for 175% minimum collateralization ratio. Cannot be less than 100.</li>
<li><code>interest rate</code><span style="color: red">*</span>: annual interest rate, but chargeable per block (scaled to 30-sec block). e.g. 3.5 for 3.5% interest rate. Must be &gt; 0.</li>
<li><code>id</code><span style="color: red">*</span>: non-colliding scheme ID that's unique within opspace, e.g. MIN_175</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: Transaction hash.</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli createloanscheme 150 5 LOAN150 # mincolratio 150%, interest rate 5%, id &quot;LOAN150&quot;
</code></pre>
</li>
</ul>
<div id="updateloanscheme"></div>
<ul>
<li>
<p><code>updateloanscheme</code>:</p>
<p>Used to update a loan scheme.</p>
<p>Arguments:</p>
<ul>
<li><code>mincolratio</code><span style="color: red">*</span>: e.g. 175 for 175% minimum collateralization ratio. Cannot be less than 100.</li>
<li><code>interest rate</code><span style="color: red">*</span>: annual interest rate, but chargeable per block (scaled to 30-sec block). e.g. 3.5 for 3.5% interest rate. Must be &gt; 0.</li>
<li><code>id</code><span style="color: red">*</span>: id of loan scheme that will be updated</li>
<li><code>ACTIVATE_AFTER_BLOCK</code>: if set, this will only be activated after the set block. The purpose is to allow to provide sufficient warning.</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: Transaction hash.</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli createloanscheme 150 5 LOAN150
defi-cli createloanscheme 150 5 LOAN150 3020 # Update only after block 3020
</code></pre>
</li>
</ul>
<div id="destroyloanscheme"></div>
<ul>
<li>
<p><code>destroyloanscheme</code>:</p>
<p>Used to destroy a loan scheme.</p>
<p>Arguments:</p>
<ul>
<li><code>id</code><span style="color: red">*</span>: the unique identifier of the loan scheme to destroy.</li>
<li><code>ACTIVATE_AFTER_BLOCK</code>: if set, loan will be destroyed after the set block. The purpose is to allow to provide sufficient warning.</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: Transaction hash.</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli destroyloanscheme LOAN150
defi-cli destroyloanscheme LOAN150 3020 # Destroy only after block 3020
</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<ul>
<li>
<p>All vaults under this loan scheme will be moved to the default loan scheme after destruction.</p>
</li>
<li>
<p>Default loan scheme cannot be destroyed.</p>
</li>
</ul>
</blockquote>
</li>
</ul>
<div id="setdefaultloanscheme"></div>
<ul>
<li>
<p><code>setdefaultloanscheme</code>:</p>
<p>Used to change the default loan scheme.</p>
<p>Arguments:</p>
<ul>
<li><code>id</code><span style="color: red">*</span>: the unique identifier of the new default loan scheme.</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: Transaction hash.</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli setdefaultloanscheme LOAN150
</code></pre>
</li>
</ul>
<div id="getloanscheme"></div>
<ul>
<li>
<p><code>getloanscheme</code>:</p>
<p>Get loan scheme information.</p>
<p>Arguments:</p>
<ul>
<li><code>id</code><span style="color: red">*</span>: unique identifier of a loan scheme.</li>
</ul>
<p><span style="color: #FF00AF">Return</span>:</p>
<pre><code class="language-bash">{
  &quot;id&quot;: &quot;C150&quot;,
  &quot;mincolratio&quot;: 150,
  &quot;interestrate&quot;: 5.00000000,
  &quot;default&quot;: true
}
</code></pre>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli getloanscheme C150
</code></pre>
</li>
</ul>
<div id="listloanschemes"></div>
<ul>
<li>
<p><code>listloanschemes</code>:</p>
<p>Retrieve the list of all loan schemes. This command receives no arguments.</p>
<p><span style="color: #FF00AF">Return</span>:</p>
<pre><code class="language-bash">[
      {
        &quot;id&quot;: &quot;C150&quot;,
        &quot;mincolratio&quot;: 150,
        &quot;interestrate&quot;: 5.00000000,
        &quot;default&quot;: true
      },
      {
        &quot;id&quot;: &quot;C175&quot;,
        &quot;mincolratio&quot;: 175,
        &quot;interestrate&quot;: 3.00000000,
        &quot;default&quot;: false
      },
      .
      .
      .
]
</code></pre>
<p>If there are no loan schemes an empty list is returned []</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli listloanschemes
</code></pre>
</li>
</ul>
<div id="loan-tokens-rpcs"></div>
<h2 id="loan-tokens-rpcs"><a class="header" href="#loan-tokens-rpcs">Loan tokens RPCs</a></h2>
<div id="setloantoken"></div>
<ul>
<li>
<p><code>setloantoken</code>:</p>
<p>Creates a loan token.</p>
<p>This arguments are wrapped in a <code>metadata</code> object see the example:</p>
<ul>
<li><code>symbol</code><span style="color: red">*</span>: token's symbol (unique).</li>
<li><code>fixedIntervalPriceId</code><span style="color: red">*</span>: the id of the price feed to track tokens price</li>
<li><code>name</code>: token's name. Default is set to an empty string.</li>
<li><code>mintble</code>: token's mintable property. Defaults to True.</li>
<li><code>interest</code>: annual interest rate, but chargeable per block (scaled to 30-sec block). e.g. 3.5 for 3.5% interest rate. Must be &gt; 0. Defaults to 0.</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: Transaction hash.</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli setloantoken {&quot;symbol&quot;:&quot;TSLA&quot;, \
                    &quot;name&quot;:&quot;TSLA stock token&quot;, \
                    &quot;fixedIntervalPriceId&quot;:&quot;TSLA/USD&quot;, \
                    &quot;interest&quot;:&quot;3&quot;}
</code></pre>
</li>
</ul>
<div id="updateloantoken"></div>
<ul>
<li>
<p><code>updateloantoken</code>:</p>
<p>Updates a loan token.</p>
<ul>
<li><code>token</code><span style="color: red">*</span>: token's symbol, id or creation transaction hash.</li>
<li><code>metadata</code><span style="color: red">*</span>: object containing the data to be updated.
<ul>
<li><code>symbol</code>: token's symbol (unique).</li>
<li><code>fixedIntervalPriceId</code>: the id of the price feed to track tokens price</li>
<li><code>name</code>: token's name. Default is set to an empty string.</li>
<li><code>mintble</code>: token's mintable property. Defaults to True.</li>
<li><code>interest</code>: annual interest rate, but chargeable per block (scaled to 30-sec block). e.g. 3.5 for 3.5% interest rate. Must be &gt; 0. Defaults to 0.</li>
</ul>
</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: Transaction hash.</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli updateloantoken TSLA {&quot;symbol&quot;:&quot;NEWTSLA&quot;, \
                            &quot;name&quot;:&quot;NEWTSLA stock token&quot;, \
                            &quot;fixedIntervalPriceId&quot;:&quot;NEWTSLA/USD&quot;, \
                            &quot;interest&quot;:&quot;1&quot;}
</code></pre>
</li>
</ul>
<div id="getloantoken"></div>
<ul>
<li>
<p><code>getloantoken</code>:</p>
<p>Get relevant information about a loan token.</p>
<p>Arguments:</p>
<ul>
<li><code>token</code><span style="color: red">*</span>: token's symbol, id or creation transaction hash.</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: There are only two attributes differencing a token from a loan token: <code>interest</code> and <code>fixedIntervalPricedId</code> which is for tracking tokens oracle price. Lets see an example of real return for a loan token:</p>
<pre><code class="language-bash">{
    &quot;token&quot;: {
        &quot;19&quot;: {
            &quot;symbol&quot;: &quot;TSLA&quot;,
            &quot;symbolKey&quot;: &quot;TSLA&quot;,
            &quot;name&quot;: &quot;TSLA&quot;,
            &quot;decimal&quot;: 8,
            &quot;limit&quot;: 0,
            &quot;mintable&quot;: true,
            &quot;tradeable&quot;: true,
            &quot;isDAT&quot;: true,
            &quot;isLPS&quot;: false,
            &quot;finalized&quot;: false,
            &quot;isLoanToken&quot;: true,
            &quot;minted&quot;: 40018.13292270,
            &quot;creationTx&quot;: &quot;ea485478eb87885cd083faf0dfacd9253d9f15d9bdc016ebacb50becb47e4ce6&quot;,
            &quot;creationHeight&quot;: 686335,
            &quot;destructionTx&quot;: &quot;0000000000000000000000000000000000000000000000000000000000000000&quot;,
            &quot;destructionHeight&quot;: -1,
            &quot;collateralAddress&quot;: &quot;7Q2nZCcKnxiRiHSNQtLB27RA5efxm2cE7w&quot;
        }
    },
    &quot;fixedIntervalPriceId&quot;: &quot;TSLA/USD&quot;,
    &quot;interest&quot;: 6.00000000
}
</code></pre>
<p>If loan token is not found an empty object is returned {}</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli getloantoken TSLA # symbol
defi-cli getloantoken 0    # token id
defi-cli getloantoken c207f70156adb13a76d3ae08814d6735670b901079cbae5e4f1b5ca7bb9e2573 # tx creation hash
</code></pre>
</li>
</ul>
<div id="listloantokens"></div>
<ul>
<li>
<p><code>listloantokens</code>:</p>
<p>Retrieve the list of all loan tokens. This command receives no arguments.</p>
<p><span style="color: #FF00AF">Return</span>:</p>
<pre><code class="language-bash">[
      {
            &quot;token&quot;: {
                  &quot;10&quot;: {
                    &quot;symbol&quot;: &quot;TWTR&quot;,
                    &quot;symbolKey&quot;: &quot;TWTR&quot;,
                    &quot;name&quot;: &quot;TWTR&quot;,
                    &quot;decimal&quot;: 8,
                    &quot;limit&quot;: 0,
                    &quot;mintable&quot;: true,
                    &quot;tradeable&quot;: true,
                    &quot;isDAT&quot;: true,
                    &quot;isLPS&quot;: false,
                    &quot;finalized&quot;: false,
                    &quot;isLoanToken&quot;: true,
                    &quot;minted&quot;: 40492.38394616,
                    &quot;creationTx&quot;: &quot;35113ddb109e60867d1c8a5eddcee4ee73f1f704954a89ab7d0ec12247ec2d4d&quot;,
                    &quot;creationHeight&quot;: 686314,
                    &quot;destructionTx&quot;: &quot;0000000000000000000000000000000000000000000000000000000000000000&quot;,
                    &quot;destructionHeight&quot;: -1,
                    &quot;collateralAddress&quot;: &quot;7Q2nZCcKnxiRiHSNQtLB27RA5efxm2cE7w&quot;
                  }
            },
            &quot;fixedIntervalPriceId&quot;: &quot;TWTR/USD&quot;,
            &quot;interest&quot;: 2.10000000
      },
      {
            &quot;token&quot;: {
                  &quot;11&quot;: {
                    &quot;symbol&quot;: &quot;DUSD&quot;,
                    &quot;symbolKey&quot;: &quot;DUSD&quot;,
                    &quot;name&quot;: &quot;DUSD&quot;,
                    &quot;decimal&quot;: 8,
                    &quot;limit&quot;: 0,
                    &quot;mintable&quot;: true,
                    &quot;tradeable&quot;: true,
                    &quot;isDAT&quot;: true,
                    &quot;isLPS&quot;: false,
                    &quot;finalized&quot;: false,
                    &quot;isLoanToken&quot;: true,
                    &quot;minted&quot;: 5177661.38853472,
                    &quot;creationTx&quot;: &quot;cac1cd0a39e8ac2351ac68075fa651bd831eeef25b1dee005928fdbb2c431d5e&quot;,
                    &quot;creationHeight&quot;: 686314,
                    &quot;destructionTx&quot;: &quot;0000000000000000000000000000000000000000000000000000000000000000&quot;,
                    &quot;destructionHeight&quot;: -1,
                    &quot;collateralAddress&quot;: &quot;7Q2nZCcKnxiRiHSNQtLB27RA5efxm2cE7w&quot;
                  }
            },
            &quot;fixedIntervalPriceId&quot;: &quot;DUSD/USD&quot;,
            &quot;interest&quot;: 1.00000000
      },
      .
      .
      .
]
</code></pre>
<p>If there are no loan tokens an empty list is returned []</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli listloantokens
</code></pre>
</li>
</ul>
<h2 id="collateral-tokens-rpcs"><a class="header" href="#collateral-tokens-rpcs">Collateral tokens RPCs</a></h2>
<div id="setcollateraltoken"></div>
<ul>
<li>
<p><code>setcollateraltoken</code>:</p>
<p>Creates updates and destroys a collateral token.</p>
<p>This arguments are wrapped in a <code>metadata</code> object see the example:</p>
<ul>
<li><code>token</code><span style="color: red">*</span>: token's symbol or id of collateral token (unique).</li>
<li><code>factor</code><span style="color: red">*</span>: collateral factor.</li>
<li><code>fixedIntervalPriceId</code><span style="color: red">*</span>: token/currency pair to use for price of token.</li>
<li><code>activeAfterBlock</code>: token will be active after block height. If not set it will be active immediately.</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: Transaction hash.</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli setcollateraltoken {&quot;token&quot;: &quot;TSLA&quot;, \
                          &quot;factor&quot;: 1, \
                          &quot;fixedIntervalPriceId&quot;: &quot;TSLA/USD&quot;, \
                          &quot;activeAfterBlock&quot;: 3020}
</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>This same command can be used to update an existing collateral token.</p>
<p>To destroy a collateral token just set collateral factor to 0.</p>
</blockquote>
</li>
</ul>
<div id="getcollateraltoken"></div>
<ul>
<li>
<p><code>getcollateraltoken</code>:</p>
<p>Get relevant information about a collateral token.</p>
<p>Arguments:</p>
<ul>
<li><code>token</code><span style="color: red">*</span>: token's symbol e.g. DUSD, DFI...</li>
</ul>
<p><span style="color: #FF00AF">Return</span>:</p>
<pre><code class="language-bash">{
  &quot;token&quot;: &quot;DUSD&quot;,
  &quot;tokenId&quot;: &quot;d9fdcb425a8e770e8689a2cb04e3891b30031b511492981446ecaf8e5d479455&quot;,
  &quot;factor&quot;: 0.99000000,
  &quot;fixedIntervalPriceId&quot;: &quot;DUSD/USD&quot;,
  &quot;activateAfterBlock&quot;: 854986
}
</code></pre>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli getcollateraltoken BTC
</code></pre>
</li>
</ul>
<div id="listcollateraltokens"></div>
<ul>
<li>
<p><code>listcollateraltokens</code>:</p>
<p>Retrieve the list of all collateral tokens. This command receives no arguments.</p>
<p><span style="color: #FF00AF">Return</span>:</p>
<pre><code class="language-bash">[
      {
        &quot;token&quot;: &quot;DFI&quot;,
        &quot;tokenId&quot;: &quot;897dcc7567cd883d9e77e06ee786856db3708c27b75da936e55072fc5300ba89&quot;,
        &quot;factor&quot;: 1.00000000,
        &quot;fixedIntervalPriceId&quot;: &quot;DFI/USD&quot;,
        &quot;activateAfterBlock&quot;: 686335
      },
      {
        &quot;token&quot;: &quot;BTC&quot;,
        &quot;tokenId&quot;: &quot;7705ba258dc7c2a7fb8a8e55d65726d83fbeadcabd9b857f29527dbe4da46f99&quot;,
        &quot;factor&quot;: 1.00000000,
        &quot;fixedIntervalPriceId&quot;: &quot;BTC/USD&quot;,
        &quot;activateAfterBlock&quot;: 686308
      },
      .
      .
      .
]
</code></pre>
<p>If there are no collateral tokens an empty list is returned []</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli listcollateraltokens
</code></pre>
</li>
</ul>
<h2 id="vault-rpcs"><a class="header" href="#vault-rpcs">Vault RPCs</a></h2>
<div id="createvault"></div>
<ul>
<li>
<p><code>createvault</code>:</p>
<p>Is used to create an empty vault.</p>
<p>Arguments:</p>
<ul>
<li><code>ownerAddress</code><span style="color: red">*</span>: the address owning this vault. This address might be owned by the node executing the command or not, meaning, anyone can create vaults to other users.</li>
<li><code>loanSchemeId</code>: id of the <a href="guides/loans.html#loan-scheme">loan scheme</a> this vault is subscribed to. This defines the rules applied to this particular vault; the <a href="guides/loans.html#interest-rate">interest rate</a> and the <a href="guides/loans.html#minimum-collateral-ratio">minimum collateral ratio</a>.
If omitted the vault will subscribe to the default loan scheme.</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: <code>vaultId</code> (transaction hash). This can be used to identify the created vault inside the blockchain.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>2 DFIs are charged when creating a vault:</p>
<ul>
<li>1 DFI will be burned.</li>
<li>1 DFI will be added as collateral of the vault.
This last 1 DFI will be send to the address indicated in <a href="guides/loans.html#closevault"><code>closevault</code></a> RPC command.</li>
</ul>
<p>So the overall cost of creating a vault is 1 DFI.</p>
</blockquote>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli createvault mwSDMvn1Hoc8DsoB7AkLv7nxdrf5Ja4jsF LOAN150
defi-cli createvault mwSDMvn1Hoc8DsoB7AkLv7nxdrf5Ja4jsF #  Choose default loan scheme
</code></pre>
</li>
</ul>
<div id="updatevault"></div>
<ul>
<li>
<p><code>updatevault</code>:</p>
<p>Is used to update a vault's owner, loan scheme or both.</p>
<p>Arguments:</p>
<ul>
<li><code>vaultId</code><span style="color: red">*</span>: id of the vault to be updated</li>
<li><code>parameters</code><span style="color: red">*</span>: object containing the attributes to be updated
<ul>
<li><code>ownerAddress</code>: address to which transfer the vault.</li>
<li><code>loanSchemeId</code>: id of the <a href="guides/loans.html#loan-scheme">loan scheme</a> this vault will be subscribed to.</li>
</ul>
</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: Transaction hash.</p>
<blockquote>
<p><strong>Note</strong></p>
<ul>
<li>
<p>Requires ownerAddress authentication.</p>
</li>
<li>
<p>Update cannot happen while the vault is in either <code>inLiquidation</code> or <code>frozen</code> state.</p>
</li>
<li>
<p>If the loan scheme is set to be destroyed in the future with <code>activateAfterBlock</code>,the update of the vault to that loan scheme will not be allowed.</p>
</li>
</ul>
</blockquote>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli updatevault 84b22eee1964768304e624c416f29a91d78a01dc5e8e12db26bdac0670c67bb2 \
                  { &quot;ownerAddress&quot;: mwSDMvn1Hoc8DsoB7AkLv7nxdrf5Ja4jsF, \
                    &quot;loanSchemeId&quot;: &quot;LOAN150&quot; }
</code></pre>
</li>
</ul>
<div id="closevault"></div>
<ul>
<li>
<p><code>closevault</code>:</p>
<p>Is used to close an empty vault. Only vaults with no active loans can be closed by its owner.</p>
<p>Arguments:</p>
<ul>
<li><code>vaultId</code><span style="color: red">*</span>: identifier of the vault to be closed.</li>
<li><code>to</code><span style="color: red">*</span>: address to which transfer remaining collaterals (if any).</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: Transaction hash.</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli closevault mwSDMvn1Hoc8DsoB7AkLv7nxdrf5Ja4jsF LOAN150
</code></pre>
</li>
</ul>
<div id="getvault"></div>
<ul>
<li>
<p><code>getvault</code>:</p>
<p>Get vault relevant information.</p>
<p>Arguments:</p>
<ul>
<li><code>vaultId</code><span style="color: red">*</span>: identifier of the vault.</li>
</ul>
<p><span style="color: #FF00AF">Return</span>:</p>
<pre><code class="language-bash">{
  &quot;vaultId&quot;: &quot;279e8a0dc5aa5c57baae66277d0135231934b7be7d8fcc2572ee703b6269eea5&quot;,
  &quot;loanSchemeId&quot;: &quot;C200&quot;,
  &quot;ownerAddress&quot;: &quot;tpsc2JrxHBEsRJ1PvXSq7pP12jDzBGydTT&quot;,
  &quot;state&quot;: &quot;active&quot;,
  &quot;collateralAmounts&quot;: [
    &quot;700.00000000@DFI&quot;
  ],
  &quot;loanAmounts&quot;: [
    &quot;0.51774842@TSLA&quot;
  ],
  &quot;interestAmounts&quot;: [
    &quot;0.00774842@TSLA&quot;
  ],
  &quot;collateralValue&quot;: 2199.30307800,
  &quot;loanValue&quot;: 505.27742871,
  &quot;interestValue&quot;: 7.56178403,
  &quot;informativeRatio&quot;: 435.26644038,
  &quot;collateralRatio&quot;: 435
}
</code></pre>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli getvault 279e8a0dc5aa5c57baae66277d0135231934b7be7d8fcc2572ee703b6269eea5
</code></pre>
</li>
</ul>
<div id="listvaults"></div>
<ul>
<li>
<p><code>listvaults</code>:</p>
<p>Get the list of vaults on the network.</p>
<p>Arguments:</p>
<p>We have two optional parameters that will help with the <strong>filtering</strong> and <strong>pagination</strong> of the resulting list.</p>
<ul>
<li><code>options</code>: this object contains the parameters to filter the results
<ul>
<li><code>ownerAddress</code>: return only vaults owned by this address.</li>
<li><code>loanSchemeId</code>: return vaults that subscribe to a specific loan scheme.</li>
<li><code>state</code>: retrieve vaults that are currently in a specific state (active, froze, inLiquidation...)</li>
<li><code>verbose</code>: show the full information of the vaults listed. See the example returns to see the difference. (boolean)</li>
</ul>
</li>
<li><code>pagination</code>: this object contains the parameters needed for pagination purposes.
<ul>
<li><code>start</code>: optional first key to iterate from, in lexicographical order. Typically it's set to last ID from previous request.</li>
<li><code>including_start</code>: if true, then iterate including starting position. False by default.</li>
<li><code>limit</code>: maximum number of orders to return, 100 by default.</li>
</ul>
</li>
</ul>
<p><span style="color: #FF00AF">Return</span>:</p>
<p>Verbose parameter not set or set to false:</p>
<pre><code class="language-bash">[
      {
        &quot;vaultId&quot;: &quot;d5611d2823b09eaa9c3a990ae2b372f6fa8c71cfce272c6f942d25f715732f01&quot;,
        &quot;ownerAddress&quot;: &quot;tXu6Q9UKN4rKEHykANSMSAQ6Gowijear2i&quot;,
        &quot;loanSchemeId&quot;: &quot;C150&quot;,
        &quot;state&quot;: &quot;active&quot;
      },
      {
        &quot;vaultId&quot;: &quot;6a63ec6a5f5fd00d1669e17ed547f54f5c561c10cfb1fadcee427688b5c34702&quot;,
        &quot;ownerAddress&quot;: &quot;tkjZa5HmeCVzry2Tq77tFouKjm5vQ3NsY7&quot;,
        &quot;loanSchemeId&quot;: &quot;C150&quot;,
        &quot;state&quot;: &quot;active&quot;
      },
      .
      .
      .
]
</code></pre>
<p>Verbose parameter set to true:</p>
<pre><code class="language-bash">[
      {
        &quot;vaultId&quot;: &quot;d5611d2823b09eaa9c3a990ae2b372f6fa8c71cfce272c6f942d25f715732f01&quot;,
        &quot;loanSchemeId&quot;: &quot;C150&quot;,
        &quot;ownerAddress&quot;: &quot;tXu6Q9UKN4rKEHykANSMSAQ6Gowijear2i&quot;,
        &quot;state&quot;: &quot;active&quot;,
        &quot;collateralAmounts&quot;: [
        ],
        &quot;loanAmounts&quot;: [
        ],
        &quot;interestAmounts&quot;: [
        ],
        &quot;collateralValue&quot;: 0.00000000,
        &quot;loanValue&quot;: 0.00000000,
        &quot;interestValue&quot;: 0,
        &quot;informativeRatio&quot;: -1.00000000,
        &quot;collateralRatio&quot;: -1
      },
      .
      .
      .
]
</code></pre>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli listvaults
defi-cli listvaults '{&quot;loanSchemeId&quot;: &quot;LOAN1502&quot;}'
defi-cli listvaults '{&quot;verbose&quot;: &quot;true&quot;}'
defi-cli listvaults '{&quot;loanSchemeId&quot;: &quot;LOAN1502&quot;}' '{&quot;start&quot;:&quot;3ef9fd5bd1d0ce94751e6286710051361e8ef8fac43cca9cb22397bf0d17e013&quot;, &quot;including_start&quot;: true, &quot;limit&quot;:100}'
defi-cli listvaults {} '{&quot;start&quot;:&quot;3ef9fd5bd1d0ce94751e6286710051361e8ef8fac43cca9cb22397bf0d17e013&quot;, &quot;including_start&quot;: true, &quot;limit&quot;:100}'
</code></pre>
</li>
</ul>
<div id="listvaulthistory"></div>
<ul>
<li>
<p><code>listvaulthistory</code>:</p>
<p>Get the history of a vault.</p>
<p>Arguments:</p>
<ul>
<li><code>vaultId</code><span style="color: red">*</span>: identifier of the vault.</li>
<li><code>options</code>: this object contains the parameters to filter the results.
<ul>
<li><code>maxBlockHeight</code>: optional height to iterate from (down to genesis block), (default = chaintip).</li>
<li><code>depth</code>: maximum depth, from the genesis block is the default.</li>
<li><code>token</code>: filter by token.</li>
<li><code>txtype</code>: filter by transaction type, supported letter from {CustomTxType} e.g. &quot;CloseVault&quot;, &quot;PaybackLoan&quot;, &quot;UpdateVault&quot;</li>
<li><code>limit</code>: maximum number of records to return, 100 by default.</li>
</ul>
</li>
</ul>
<p><span style="color: #FF00AF">Return</span>:</p>
<pre><code class="language-bash">[
      {
          'address': 'mqYr2o5sGRkBuUm7CkWiBWkM11naYMscog',
          'amounts': ['10.00000000@DFI'],
          'blockHash': '29097a94dbeeac54de137eb706831062ef8296a402388fd212276d0b0d1945c3',
          'blockHeight': 127,
          'blockTime': 1649765301,
          'txid': 'e6b9b0aed8a0752547e8880685db559ea0abdb3648303fa15117fe02caa459f2',
          'txn': 1,
          'type': 'CloseVault'
      },
      {
          'address': 'mqkdzzVL36dsf9vABwWoq5iBjptS5vyUDU',
          'amounts': ['0.50000000@DFI'],
          'blockHash': '7c8a41660884dc28e6e59af39ac662208dabc3f61e76b7a096e9d7953bd32804',
          'blockHeight': 126,
          'blockTime': 1649765300,
          'txid': 'a35ee0798c76c48da748f38b47c9abb945586473816308d06731eb352477084a',
          'txn': 1,
          'type': 'WithdrawFromVault'
      },
      {
          'address': 'mfburnZSAM7Gs1hpDeNaMotJXSGA7edosG',
          'amounts': ['0.00000228@DFI'],
          'blockHash': 'fa20e13c42d2dc3243efcb96f95e2953e30974b46191da074e271077437f2197',
          'blockHeight': 125,
          'blockTime': 1649765299,
          'txid': '611da4b4204eb758f215a383f5602f048cc607f06e9dcd01aca087c963dc1131',
          'txn': 1,
          'type': 'PaybackLoan'
      },
      .
      .
      .
]
</code></pre>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli listvaulthistory 84b22eee1964768304e624c416f29a91d78a01dc5e8e12db26bdac0670c67bb2 \
                          '{&quot;maxBlockHeight&quot;:160,&quot;depth&quot;:10}'
</code></pre>
</li>
</ul>
<div id="deposittovault"></div>
<ul>
<li>
<p><code>deposittovault</code>:</p>
<p>Is used to deposit collateral tokens in a vault. Only the owner of the vault can perform this action.</p>
<p>Arguments:</p>
<ul>
<li><code>vaultId</code><span style="color: red">*</span>: identifier of the vault to which deposit the collateral amount.</li>
<li><code>from</code><span style="color: red">*</span>: address account containing the amount of collateral.</li>
<li><code>amount</code><span style="color: red">*</span>: amount of collateral in amount@symbol format. e.g. 1.3@dTSLA</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: Transaction hash.</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli deposittovault 84b22eee1964768304e624c416f29a91d78a01dc5e8e12db26bdac0670c67bb2i mwSDMvn1Hoc8DsoB7AkLv7nxdrf5Ja4jsF 1.3@dTSLA
</code></pre>
</li>
</ul>
<div id="takeloan"></div>
<ul>
<li>
<p><code>takeloan</code>:</p>
<p>Is used to take a loan (mint dTokens).</p>
<p>All arguments are wrapped in a metadata object, see example usage:</p>
<ul>
<li><code>vaultId</code><span style="color: red">*</span>: identifier of the vault to which deposit the collateral amount.</li>
<li><code>to</code>: address to transfer minted tokens. If not specified a valid address will be taken from the wallet.</li>
<li><code>amounts</code><span style="color: red">*</span>: amount of requested tokens in amount@symbol format. e.g. 20@dTSLA</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: Transaction hash.</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli takeloan '{&quot;vaultId&quot;: &quot;84b22eee1964768304e624c416f29a91d78a01dc5e8e12db26bdac0670c67bb2&quot;, \
                    &quot;amounts&quot;: &quot;10@TSLA&quot;}'

defi-cli takeloan '{&quot;vaultId&quot;: &quot;84b22eee1964768304e624c416f29a91d78a01dc5e8e12db26bdac0670c67bb2&quot;, \
                    &quot;to&quot;: &quot;mwSDMvn1Hoc8DsoB7AkLv7nxdrf5Ja4jsF&quot;, \
                    &quot;amounts&quot;: &quot;10@TSLA&quot;}'
</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>Remember that to be able to take a loan the vault must comply the <a href="guides/loans.html#50-rule">50% rule</a>.</p>
</blockquote>
</li>
</ul>
<div id="paybackloan"></div>
<ul>
<li>
<p><code>paybackloan</code>:</p>
<p>Is used to payback loan tokens and interests. It does not require authentication so anyone can payback anyone's loan.</p>
<p>All arguments are wrapped in a metadata object, see example usage:</p>
<ul>
<li><code>vaultId</code><span style="color: red">*</span>: identifier of the vault to which deposit the collateral amount.</li>
<li><code>from</code><span style="color: red">*</span>: address account containing the amount of collateral.</li>
<li><code>amounts</code><span style="color: red">**</span>: amount of collateral in amount@symbol format. e.g. 1.3@dTSLA</li>
<li><code>loans</code><span style="color: red">**</span>: object list containing specific payment for each loan token.
<ul>
<li><code>dToken</code><span style="color: red">*</span>: dToken symbol to be paid.</li>
<li><code>loans</code><span style="color: red">*</span>: amount in amount@token format that will pay for the above dToken</li>
</ul>
</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: Transaction hash.</p>
<p>Example usage:</p>
<pre><code class="language-bash"># Using amounts
defi-cli paybackloan '{&quot;vaultId&quot;: &quot;84b22eee1964768304e624c416f29a91d78a01dc5e8e12db26bdac0670c67bb2i&quot; \
                       &quot;from&quot;: &quot;mwSDMvn1Hoc8DsoB7AkLv7nxdrf5Ja4jsF&quot; \
                       &quot;amounts&quot;: &quot;1.3@dTSLA&quot;}'

# Using loans object list
defi-cli paybackloan '{&quot;vaultId&quot;: &quot;84b22eee1964768304e624c416f29a91d78a01dc5e8e12db26bdac0670c67bb2i&quot; \
                       &quot;from&quot;: mwSDMvn1Hoc8DsoB7AkLv7nxdrf5Ja4jsF \
                       &quot;loans&quot;: [{&quot;dToken&quot;: &quot;dTSLA&quot;, &quot;amounts&quot;: &quot;1@DFI&quot;} \
                                 {&quot;dToken&quot;: &quot;dDOGE&quot;, &quot;amounts&quot;: &quot;1@DUSD&quot;}]}'
</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p><span style="color: red">**</span> Either use <code>amounts</code> or <code>loans</code> but not both at the same time.
The use of one of this arguments is mandatory.</p>
<p>Using the <code>loan</code> object allows a more specific way to pay back different loan tokens. If in the other hand <code>amounts</code> argument is used, the loan will be first paid back with the available DFI. If there is not enough balance, the rest of the loan will remain unpaid.</p>
</blockquote>
</li>
</ul>
<div id="withdrawfromvault"></div>
<ul>
<li>
<p><code>withdrawfromvault</code>:</p>
<p>Is used to take a loan (mint dTokens).</p>
<p>All arguments are wrapped in a metadata object, see example usage:</p>
<ul>
<li><code>vaultId</code><span style="color: red">*</span>: identifier of the vault from which withdraw the collateral amount.</li>
<li><code>to</code><span style="color: red">*</span>: address to transfer collateral tokens.</li>
<li><code>amounts</code><span style="color: red">*</span>: amount of withdrawn tokens in amount@symbol format. e.g. 20@dTSLA</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: Transaction hash.</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli withdrawfromvault '{&quot;vaultId&quot;: &quot;84b22eee1964768304e624c416f29a91d78a01dc5e8e12db26bdac0670c67bb2&quot;, \
                             &quot;to&quot;: &quot;mwSDMvn1Hoc8DsoB7AkLv7nxdrf5Ja4jsF&quot;, \
                             &quot;amounts&quot;: &quot;14@TSLA&quot;}'
</code></pre>
</li>
</ul>
<h2 id="auction-rpcs"><a class="header" href="#auction-rpcs">Auction RPCs</a></h2>
<div id="listauctions"></div>
<ul>
<li>
<p><code>listauctions</code>:</p>
<p>Retrieve the list of all active auctions.</p>
<p>Arguments:</p>
<ul>
<li><code>pagination</code>: this object contains the parameters needed for pagination purposes.
<ul>
<li><code>start</code>: object providing <code>vaultId</code> and/or <code>liquidation height</code>{}
<ul>
<li><code>vaultId</code>: id of the vault to start from.</li>
<li><code>height</code>: start with auctions with <code>liquidationHeight</code> after this height</li>
</ul>
</li>
<li><code>including_start</code>: if true, then iterate including starting position. False by default.</li>
<li><code>limit</code>: maximum number of orders to return, 100 by default.</li>
</ul>
</li>
</ul>
<p><span style="color: #FF00AF">Return</span>:</p>
<pre><code class="language-bash">[
    {
         'batchCount': 1,
         'batches': [{'collaterals': ['100.00000000@DFI', '100.00000000@BTC'],
                    'index': 0,
                    'loan': '10.00004560@TSLA'}],
         'liquidationHeight': 474,
         'liquidationPenalty': Decimal('5.00000000'),
         'loanSchemeId': 'LOAN0001',
         'ownerAddress': 'mwsZw8nF7pKxWH8eoKL9tPxTpaFkz7QeLU',
         'state': 'inLiquidation',
         'vaultId': '415593c1803370cb83e6646357c9d28d1b890974b8f9934de2ac582272d0f027'
    },
    {
         'batchCount': 1,
         'batches': [{'collaterals': ['100.00000000@DFI', '100.00000000@BTC'],
                      'index': 0,
                      'loan': '10.00004560@TSLA'}],
         'liquidationHeight': 474,
         'liquidationPenalty': Decimal('5.00000000'),
         'loanSchemeId': 'LOAN0001',
         'ownerAddress': 'mwsZw8nF7pKxWH8eoKL9tPxTpaFkz7QeLU',
         'state': 'inLiquidation',
         'vaultId': '7db5032d699ac6696a9cc36a52b642f5785ca187c360116615d3855d0f760e61'
    },
    .
    .
    .
]
</code></pre>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli listauctions

# With pagination
defi-cli listauctions {&quot;start&quot;: {&quot;vaultId&quot;:&quot;eeea650e5de30b77d17e3907204d200dfa4996e5c4d48b000ae8e70078fe7542&quot;, \
                                 &quot;height&quot;: 1000}, \
                       &quot;including_start&quot;: true, \
                       &quot;limit&quot;:100}
</code></pre>
</li>
</ul>
<div id="listauctionhistory"></div>
<ul>
<li>
<p><code>listauctionhistory</code>:</p>
<p>Retrieve auction history.</p>
<p>Arguments:</p>
<ul>
<li><code>owner|vaultId</code>: this parameter admits the following:
<ul>
<li>Single account id (CScript or address).</li>
<li>A vaultId.</li>
<li>One of this reserved words; <code>mine</code> - to list history for all owned accounts; <code>all</code> to list whole DB (default = <code>mine</code>).</li>
</ul>
</li>
<li><code>pagination</code>: this object contains the parameters needed for pagination purposes.
<ul>
<li><code>maxBlockHeight</code>: height to iterate from (down to genesis block).</li>
<li><code>vaultId</code>: show only auctions related to this vault.</li>
<li><code>index</code>: only batches with this index will be listed.</li>
<li><code>limit</code>: maximum number of orders to return, 100 by default.</li>
</ul>
</li>
</ul>
<p><span style="color: #FF00AF">Return</span>:</p>
<pre><code class="language-bash">[
    {
        'auctionBid': '259.00000000@TSLA',
        'auctionWon': ['200.00000400@DFI', '200.00000400@BTC'],
        'batchIndex': 0,
        'blockHash': '833f3b22f8df9b4d6d2e142790dd4a9f4e3b21b524e7f5303e5ea6396745671f',
        'blockHeight': 506,
        'blockTime': 1649803226,
        'vaultId': 'd1b414827c115160ed9eed11ec0bdfa4355f339ed5d6240974eeafe8867af0c2',
        'winner': 'mwsZw8nF7pKxWH8eoKL9tPxTpaFkz7QeLU'
    },
    {
        'auctionBid': '515.00000000@TSLA',
        'auctionWon': ['399.99999600@DFI', '399.99999600@BTC'],
        'batchIndex': 0,
        'blockHash': '58582b7511253f8d1be20c0fad4358141f77255b6e2fa071121ac85cfbb7cbb2',
        'blockHeight': 469,
        'blockTime': 1649803189,
        'vaultId': 'd1b414827c115160ed9eed11ec0bdfa4355f339ed5d6240974eeafe8867af0c2',
        'winner': 'mwsZw8nF7pKxWH8eoKL9tPxTpaFkz7QeLU'
    },
    .
    .
    .
]
</code></pre>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli listauctionhistory

# With pagination
defi-cli listauctionhistory {&quot;maxBlockHeight&quot;: 1000, \
                             &quot;vaultId&quot;:&quot;eeea650e5de30b77d17e3907204d200dfa4996e5c4d48b000ae8e70078fe7542&quot;, \
                             &quot;index&quot;: 1, \
                             &quot;limit&quot;:100}
</code></pre>
</li>
</ul>
<div id="placeauctionbid"></div>
<ul>
<li>
<p><code>placeauctionbid</code>:</p>
<p>Make bid for an open auction's batch.</p>
<p>Arguments:</p>
<ul>
<li><code>vaultId</code><span style="color: red">*</span>: identifier of the vault in liquidation.</li>
<li><code>index</code><span style="color: red">*</span>: index of the target batch in the auction.</li>
<li><code>from</code><span style="color: red">*</span>: address to get tokens from. If set to <code>*</code> (star), an account with sufficient funds is selected from wallet.</li>
<li><code>amounts</code><span style="color: red">*</span>: amount of bid in amount@symbol format. e.g. 20@dTSLA</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: Transaction hash.</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli placeauctionbid 84b22eee1964768304e624c416f29a91d78a01dc5e8e12db26bdac0670c67bb2 \
                         0 \ # batch index
                         mwSDMvn1Hoc8DsoB7AkLv7nxdrf5Ja4jsF \
                         100@TSLA
</code></pre>
</li>
</ul>
<h2 id="helper-rpcs"><a class="header" href="#helper-rpcs">Helper RPCs</a></h2>
<div id="estimateloan"></div>
<ul>
<li>
<p><code>estimateloan</code>:</p>
<p>Returns amount of loan tokens a vault can take depending on a target collateral ratio.</p>
<p>Arguments:</p>
<ul>
<li><code>vaultId</code><span style="color: red">*</span>: identifier of the vault in liquidation.</li>
<li><code>tokens</code><span style="color: red">*</span>: object with the loan tokens as key and their percent split as value. e.g. {&quot;dTSLA&quot;: 0.1, &quot;GOOGL&quot; 0.9}</li>
<li><code>targetRatio</code>: target collateral ratio. (defaults to vault's loan scheme ratio)</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: Array of amount@token e.g. ['1.5@TSLA', '2.2@TWTR']</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli estimateloan 84b22eee1964768304e624c416f29a91d78a01dc5e8e12db26bdac0670c67bb2 \
                      '{&quot;TSLA&quot;:0.8, &quot;TWTR&quot;: 0.2}'
</code></pre>
</li>
</ul>
<div id="estimatecollateral"></div>
<ul>
<li>
<p><code>estimatecollateral</code>:</p>
<p>Returns amount of loan tokens a vault can take depending on a target collateral ratio.</p>
<p>Arguments:</p>
<ul>
<li><code>loanAmounts</code><span style="color: red">*</span>: loan amount for the estimation.</li>
<li><code>targetRatio</code><span style="color: red">*</span>: target collateral ratio. (defaults to vault's loan scheme ratio)</li>
<li><code>tokens</code>: object with the loan tokens as key and their percent split as value. e.g. {&quot;dTSLA&quot;: 0.1, &quot;GOOGL&quot; 0.9}</li>
</ul>
<p><span style="color: #FF00AF">Return</span>: Array of amount@token e.g. ['5@TSLA', '4.01@TWTR']</p>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli estimatecollateral 23.55311144@MSFT \
                            150 \
                            '{&quot;DFI&quot;: 0.8, &quot;BTC&quot;:0.2}'
</code></pre>
</li>
</ul>
<div id="estimatevault"></div>
<ul>
<li>
<p><code>estimatevault</code>:</p>
<p>Returns estimated vault for given collateral and loan amounts.</p>
<p>Arguments:</p>
<ul>
<li><code>collateralAmounts</code><span style="color: red">*</span>: collateral amount as JSON string or array e.g. [&quot;amount@token&quot;].</li>
<li><code>loanAmounts</code><span style="color: red">*</span>: loan amount as JSON string or array e.g. [&quot;amount@token&quot;].</li>
</ul>
<p><span style="color: #FF00AF">Return</span>:</p>
<pre><code class="language-bash">{
    &quot;collateralValue&quot;: 3134.14508000, # in USD
    &quot;loanValue&quot;: 1685.77665785, # in USD
    &quot;informativeRatio&quot;: 185.91698167,
    &quot;collateralRatio&quot;: 186
}
</code></pre>
<p>Example usage:</p>
<pre><code class="language-bash">defi-cli estimatevault '[&quot;1000.00000000@DFI&quot;]' '[&quot;0.65999990@GOOGL&quot;]'

</code></pre>
</li>
</ul>
<div id="getloaninfo"></div>
<ul>
<li>
<p><code>getloaninfo</code>:</p>
<p>Returns the attributes of loans offered by Operator.</p>
<p><span style="color: #FF00AF">Return</span>:</p>
<pre><code class="language-bash">{
    &quot;currentPriceBlock&quot;: 928920,
    &quot;nextPriceBlock&quot;: 929040,
    &quot;defaults&quot;: {
        &quot;scheme&quot;: &quot;C150&quot;,
        &quot;maxPriceDeviationPct&quot;: 30.00000000,
        &quot;minOraclesPerPrice&quot;: 2,
        &quot;fixedIntervalBlocks&quot;: 120
    },
    &quot;totals&quot;: {
        &quot;schemes&quot;: 6,
        &quot;collateralTokens&quot;: 4,
        &quot;collateralValue&quot;: 19892664.24475404,
        &quot;loanTokens&quot;: 6,
        &quot;loanValue&quot;: 501988.43640161,
        &quot;openVaults&quot;: 163,
        &quot;openAuctions&quot;: 0
    }
}
</code></pre>
<p>Example usage:</p>
<pre><code>defi-cli getloaninfo
</code></pre>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="decentralised-exchange"><a class="header" href="#decentralised-exchange">Decentralised Exchange</a></h1>
<h1 id="table-of-contents-1"><a class="header" href="#table-of-contents-1">Table of contents</a></h1>
<ol>
<li><a href="guides/dex.html#introduction">Introduction</a></li>
<li><a href="guides/dex.html#performing-swaps">Performing swaps</a>
<ul>
<li><a href="guides/dex.html#single-swaps">Single swaps</a></li>
<li><a href="guides/dex.html#composite-swaps">Composite swaps</a></li>
</ul>
</li>
<li><a href="guides/dex.html#adding-liquidity">Adding liquidity</a></li>
<li><a href="guides/dex.html#removing-liquidity">Removing liquidity</a></li>
</ol>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>The DeFiChain Decentralised Exchange is a marketplace where users can exchange their tokens for other on chain tokens. The DeFiChain DEX uses the <a href="https://academy.binance.com/en/articles/what-is-an-automated-market-maker-amm">automated market maker</a> model where asset prices are defined by the ratio of available liquidity in the liquidity pool.</p>
<p>Each DeX pair (colloquially called pool pair) has the following properties:</p>
<table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody>
<tr><td>Token A ID</td><td>Token ID of the first asset in the pool</td></tr>
<tr><td>Token B ID</td><td>Token ID of the second asset in the pool (generally <code>0</code> for DFI)</td></tr>
<tr><td>A reserves</td><td>Amount of Token A available in pool pair</td></tr>
<tr><td>B reserves</td><td>Amount of Token B available in pool pair</td></tr>
<tr><td>Commission</td><td>Swap fees for pool pair</td></tr>
</tbody></table>
<p>The price of an asset can be determined by the ratio between the reserves of the two assets in the pool pair.</p>
<blockquote>
<p>In the DeFiChain DEX, liquidity is distributed uniformly.</p>
<p>The DEX uses the <code>x * y = k</code> formula. Learn more about how it works in the <a href="https://github.com/runtimeverification/verified-smart-contracts/blob/uniswap/uniswap/x-y-k.pdf">Uniswap paper</a> on the model and <a href="https://medium.com/phoenix-finance/understanding-the-xyk-model-of-pooled-liquidity-7340fdc20d9c">this article</a>.</p>
</blockquote>
<p>$$
price_A = \frac{reserve_B}{reserve_A}
$$</p>
<p>$$
price_B = \frac{reserve_A}{reserve_B}
$$</p>
<p>The formula used for calculating output amount when swapping from A to B is</p>
<p>$$
output = reserve_B - \frac{reserve_B * reserve_A}{reserve_A + input}
$$</p>
<p>Swaps are executed with the following steps:</p>
<ol>
<li>Check if pool pair is activated</li>
<li>Check if minimum liquidity is available in the pool pair</li>
<li>Check if price is under maximum price</li>
<li>Subtract swap fees from input amount</li>
<li>Subtract DeX input fees from input amount (set using governance variables)</li>
<li>Add input amount to reserves and extract output from reserves</li>
</ol>
<p>There are two possible types of swaps, <strong>single</strong> and <strong>composite</strong>. Single swaps are swaps where the swap route has just one pool pair, whereas composite swaps can go through up to 3 pool pairs.</p>
<p>For example, swapping from ETH to DFI is a single swap since it only uses the ETH-DFI pool. However swapping from DUSD to ETH is a composite swap since the DUSD is first swapped to DFI using the DUSD-DFI pool, and then the DFI is swapped to ETH using the ETH-DFI pool.</p>
<blockquote>
<p>When using composite swaps, every pool pair used will apply their own fees. See <a href="guides/../faq.html#while-using-composite-swaps-are-fees-applied-once-or-multiple-times">FAQ</a>.</p>
</blockquote>
<p>See how the amount of LP tokens are caluclated <a href="guides/../faq.html#how-is-the-number-of-lp-tokens-calculated">here</a>.</p>
<h2 id="lp-rewards"><a class="header" href="#lp-rewards">LP Rewards</a></h2>
<p>Pools have block rewards and swap fees (called commissions). These rewards are paid out in proportion to the user's share of the total liquidity. LP rewards are transferred to the user when performing interactions any pool, such as adding/removing liquidity and swapping.</p>
<p>$$ share = \frac{liquidity}{totalLiquidity} $$</p>
<p>Depending on the token type, the block reward is a share of the &quot;Liquidity Pools&quot; coinbase allocation (<code>rewardPct</code>) for crypto tokens, or &quot;Loans&quot; (<code>rewardLoanPct</code>) for mintable dTokens. </p>
<h2 id="performing-swaps"><a class="header" href="#performing-swaps">Performing swaps</a></h2>
<p>Swapping tokens can be performed using the <code>poolswap</code> RPC for single swaps and <code>compositeswap</code> RPC for composite swaps.</p>
<blockquote>
<p>The <code>testpoolswap</code> RPC can be used to simulate the results of the pool swap. Use the path argument to force simple or composite swaps.</p>
</blockquote>
<h3 id="single-swaps"><a class="header" href="#single-swaps">Single swaps</a></h3>
<p>To perform single swaps, the following metadata must be provided to the RPC endpoint</p>
<ul>
<li>from: address which sends input tokens</li>
<li>tokenFrom: ID or symbol of input token</li>
<li>amountFrom: amount of tokens to swap</li>
<li>to: address to send output to</li>
<li>tokenTo: ID or symbol of output token</li>
<li>maxPrice: maximum acceptable price</li>
</ul>
<p>Optionally, users can specify UTXOs to spend for the swap.</p>
<p>The metadata and UTXO data is passed as a JSON object to the RPC.</p>
<pre><code class="language-bash">defi-cli poolswap {&quot;from&quot;:&quot;str&quot;,&quot;tokenFrom&quot;:&quot;str&quot;,&quot;amountFrom&quot;:n,&quot;to&quot;:&quot;str&quot;,&quot;tokenTo&quot;:&quot;str&quot;,&quot;maxPrice&quot;:n} ( [{&quot;txid&quot;:&quot;hex&quot;,&quot;vout&quot;:n},...] )
defi-cli poolswap '{&quot;from&quot;: &quot;MyAddress&quot;, &quot;tokenFrom&quot;: &quot;MyToken1&quot;, &quot;amountFrom&quot;: &quot;0.001&quot;, &quot;to&quot;: &quot;MyAddress&quot;, &quot;tokenTo&quot;: &quot;Token2&quot;, &quot;maxPrice&quot;: &quot;0.01&quot;}' '[{&quot;txid&quot;: &quot;id&quot;, &quot;vout&quot;: 0}]'
</code></pre>
<p>e.g. Swapping 1 ETH to DFI, the command would be</p>
<pre><code class="language-bash"># using symbols
defi-cli poolswap '{&quot;from&quot;: &quot;tnLRVU32vCfGD6...&quot;, &quot;tokenFrom&quot;: &quot;ETH&quot;, &quot;amountFrom&quot;: &quot;1&quot;, &quot;to&quot;: &quot;tnLRVU32vCfGD6...&quot;, &quot;tokenTo&quot;: &quot;DFI&quot;, &quot;maxPrice&quot;: &quot;0.01&quot;}'
# using token ID
defi-cli poolswap '{&quot;from&quot;: &quot;tnLRVU32vCfGD6...&quot;, &quot;tokenFrom&quot;: &quot;1&quot;, &quot;amountFrom&quot;: &quot;1&quot;, &quot;to&quot;: &quot;tnLRVU32vCfGD6...&quot;, &quot;tokenTo&quot;: &quot;0&quot;, &quot;maxPrice&quot;: &quot;0.01&quot;}'
</code></pre>
<h3 id="composite-swaps"><a class="header" href="#composite-swaps">Composite swaps</a></h3>
<p>Composite swaps have the same RPC structure as single swaps.</p>
<pre><code class="language-bash">defi-cli compositeswap {&quot;from&quot;:&quot;str&quot;,&quot;tokenFrom&quot;:&quot;str&quot;,&quot;amountFrom&quot;:n,&quot;to&quot;:&quot;str&quot;,&quot;tokenTo&quot;:&quot;str&quot;,&quot;maxPrice&quot;:n} ( [{&quot;txid&quot;:&quot;hex&quot;,&quot;vout&quot;:n},...] )
defi-cli compositeswap '{&quot;from&quot;: &quot;MyAddress&quot;, &quot;tokenFrom&quot;: &quot;MyToken1&quot;, &quot;amountFrom&quot;: &quot;0.001&quot;, &quot;to&quot;: &quot;MyAddress&quot;, &quot;tokenTo&quot;: &quot;Token2&quot;, &quot;maxPrice&quot;: &quot;0.01&quot;}' '[{&quot;txid&quot;: &quot;id&quot;, &quot;vout&quot;: 0}]'
</code></pre>
<p>e.g. Swapping 1 ETH to DUSD, the command would be</p>
<pre><code class="language-bash"># using symbols
defi-cli poolswap '{&quot;from&quot;: &quot;tnLRVU32vCfGD6...&quot;, &quot;tokenFrom&quot;: &quot;ETH&quot;, &quot;amountFrom&quot;: &quot;1&quot;, &quot;to&quot;: &quot;tnLRVU32vCfGD6...&quot;, &quot;tokenTo&quot;: &quot;DUSD&quot;, &quot;maxPrice&quot;: &quot;0.0001&quot;}' '[]'
# using token ID
defi-cli poolswap '{&quot;from&quot;: &quot;tnLRVU32vCfGD6...&quot;, &quot;tokenFrom&quot;: &quot;1&quot;, &quot;amountFrom&quot;: &quot;1&quot;, &quot;to&quot;: &quot;tnLRVU32vCfGD6...&quot;, &quot;tokenTo&quot;: &quot;17&quot;, &quot;maxPrice&quot;: &quot;0.0001&quot;}' '[]'
</code></pre>
<h2 id="adding-liquidity"><a class="header" href="#adding-liquidity">Adding liquidity</a></h2>
<p>To enter an LP position, the <code>addpoolliquidity</code> RPC can be used. Equal value of assets must be provided when entering an LP. The RPC will reject the request if the price impact of adding liquidity is more than 3%. The arguments for the RPC are</p>
<ul>
<li>from: addresses and tokens to add to LP</li>
<li>shareAddress: address to credit LP tokens to</li>
<li>inputs: <em>(optional)</em> UTXOs to spend</li>
</ul>
<pre><code class="language-bash">defi-cli addpoolliquidity {&quot;address&quot;:&quot;str&quot;} &quot;shareAddress&quot; ( [{&quot;txid&quot;:&quot;hex&quot;,&quot;vout&quot;:n},...] )
defi-cli addpoolliquidity '{&quot;address1&quot;: &quot;1.0@DFI&quot;, &quot;address2&quot;: &quot;1.0@ETH&quot;}' share_address '[]'
</code></pre>
<p>e.g. adding 0.1 ETH and 1 DFI of liquidity and credit LP tokens to address <code>tnLRVU32vCfGD6...</code></p>
<pre><code class="language-bash"># add liquidity from different addresses
defi-cli addpoolliquidity '{&quot;tnLRVU32vCfGD6...&quot;:&quot;1.0@DFI&quot;,&quot;df1q8e3ce1j51m...&quot;:&quot;0.1@ETH&quot;}' tnLRVU32vCfGD6... '[]'
# add liquidity from same address
defi-cli addpoolliquidity '{&quot;tnLRVU32vCfGD6...&quot;: [&quot;1.0@DFI&quot;, &quot;0.1@ETH&quot;]}' tnLRVU32vCfGD6... '[]'
# auto select accounts to add liquidity with
defi-cli addpoolliquidity '{&quot;*&quot;: [&quot;1.0@DFI&quot;, &quot;0.1@ETH&quot;]}' tnLRVU32vCfGD6... '[]'
</code></pre>
<h2 id="removing-liquidity"><a class="header" href="#removing-liquidity">Removing liquidity</a></h2>
<p>To exit an LP position, the <code>removepoolliquidity</code> RPC can be used. The RPC will redeem LP tokens for equal values of both pool assets.</p>
<p>The arguments are</p>
<ul>
<li>from: address to redeem LP from</li>
<li>amount: amount of LP tokens to redeem</li>
<li>inputs: <em>(optional)</em> UTXOs to spend</li>
</ul>
<pre><code class="language-bash">defi-cli removepoolliquidity &quot;from&quot; &quot;amount&quot; ( [{&quot;txid&quot;:&quot;hex&quot;,&quot;vout&quot;:n},...] )
defi-cli removepoolliquidity from_address 1.0@LpSymbol
</code></pre>
<p>e.g. redeeming 1 ETH-DFI LP token from address <code>tnLRVU32vCfGD6...</code></p>
<pre><code class="language-bash">defi-cli removepoolliquidity tnLRVU32vCfGD6... 1.0@ETH-DFI
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="run-a-local-node"><a class="header" href="#run-a-local-node">Run a Local Node</a></h1>
<blockquote>
<p>✏️ <strong>Note:</strong></p>
<p>Floppynet is an ALPHA stage test network, which means it may be subject to changes. The network may experience execution failures and data persistence issues. Rollbacks are likely to happen periodically.**</p>
</blockquote>
<h3 id="1-get-the-source-code"><a class="header" href="#1-get-the-source-code">1. Get the source code</a></h3>
<p>The main development regarding MetaChain is being merged into the branch <code>feature/evm</code> of the <a href="https://github.com/defich/ain/tree/feature/evm">official DeFiChain node repository</a>. Beware that this branch will be eventually merged into the master branch and this is only a temporal development work in progress branch. For the ease of this guide we will clone the branch directly:</p>
<pre><code class="language-bash">git clone -b feature/evm https://github.com/defich/ain
cd ain
</code></pre>
<h3 id="2-compile-the-node"><a class="header" href="#2-compile-the-node">2. Compile the node</a></h3>
<blockquote>
<p>✏️ <strong>Note:</strong></p>
<p>This build process is currently operational on Linux. We are actively working on the build processes for MacOS and Windows. Once complete, they should exhibit the same behavior as the Linux version.</p>
</blockquote>
<p>Considering this development introduces additional dependencies, notably Rust, it is strongly suggested to utilize the make.sh script for the efficient compilation of the node. This helper script will take care of compiling and linking all of the dependencies of the DeFiChain node.</p>
<p>Before running the script make sure you have docker installed and running. You can follow <a href="https://docs.docker.com/engine/install/">the official guide</a> to install, configure and run docker in yoour machine.</p>
<pre><code class="language-bash">./make.sh docker_release
</code></pre>
<p>This command will compile the node dependencies and the node itself inside a docker container. Beware that this will take some time in the first run as it will download all the source code of the libraries needed and the docker images.</p>
<h3 id="3-running-the-node"><a class="header" href="#3-running-the-node">3. Running the node</a></h3>
<p>Once the build succeeds you will find the binaries in <code>./buld/defichain-latest/bin/</code>. To run the node and connect it to floppynet run the following command:</p>
<pre><code class="language-bash">./build/defichain-latest/bin/defid -devnet -connect=35.187.53.161 --daemon
</code></pre>
<p>With the <code>-connect=35.187.53.161</code> your local node will connect to the  public node which is maintained by the core developers. This way it will start synchronising and finding new nodes running in Floppynet.</p>
<p>Note that if you are not using a snapshot the synchronisation will take some time.</p>
<p>An easy way to see the progress of the syncing is to run:</p>
<pre><code class="language-bash">./build/defichain-latest/bin/defi-cli -devnet getblockchaininfo | head
</code></pre>
<p>This will return something like:</p>
<pre><code class="language-bash">{
  &quot;chain&quot;: &quot;devnet&quot;,
  &quot;blocks&quot;: 1590154,
  &quot;headers&quot;: 1590154,
  &quot;bestblockhash&quot;: &quot;0fcfca2fc40ce21ce8051b1c4cfca0ecba24d44a7b9edc4338596e5cca020685&quot;,
  &quot;difficulty&quot;: 10057949.89351971,
  &quot;mediantime&quot;: 1684309761,
  &quot;verificationprogress&quot;: 1,
  &quot;initialblockdownload&quot;: false,
  &quot;chainwork&quot;: &quot;000000000000000000000000000000000000000000007f7505aaaf5fa8b5ad7b&quot;,
</code></pre>
<p>If <code>blocks</code> and <code>headers</code> are equal and <code>verificationprogress</code> is 1 then your node is synced.</p>
<h4 id="node-logs"><a class="header" href="#node-logs">Node Logs</a></h4>
<p>To check the logs go to the data folder:</p>
<ul>
<li>Windows: C:\Users\%username%\AppData\Roaming\DeFi Blockchain</li>
<li>Mac: /Users/%username%/Library/Application Support/DeFi</li>
<li>Linux: /home/%username%/.defi</li>
</ul>
<p>Open the <code>debug.log</code> inside the <code>devnet/</code> folder with your preferred text editor</p>
<h4 id="rust-debug-logs"><a class="header" href="#rust-debug-logs">Rust debug logs</a></h4>
<p>To display the Rust debug logs first stop the node:</p>
<pre><code class="language-bash">./build/defichain-latest/bin/defi-cli -devnet stop
</code></pre>
<p>Then start the node with <code>RUST_LOG=debug</code>:</p>
<pre><code class="language-bash">RUST_LOG=debug ./build/defichain-latest/bin/defid -devnet --daemon
</code></pre>
<h3 id="4-connect-metamask-to-floppynet"><a class="header" href="#4-connect-metamask-to-floppynet">4. <a href="guides/./guide_floppynet_short.html">Connect Metamask to Floppynet</a></a></h3>
<div style="break-before: page; page-break-before: always;"></div><h1 id="connect-metamask-to-floppynet"><a class="header" href="#connect-metamask-to-floppynet">Connect Metamask to Floppynet</a></h1>
<blockquote>
<p>✏️ <strong>Note:</strong>
FloppyNet is an ALPHA stage test network, which means it may be subject to changes.
The network may experience execution failures and data persistence issues. Rollbacks are likely to happen periodically.**</p>
</blockquote>
<h3 id="to-connect-to-metachain-follow-this-four-steps"><a class="header" href="#to-connect-to-metachain-follow-this-four-steps">To connect to MetaChain follow this four steps:</a></h3>
<h4 id="1-open-network-dropdown"><a class="header" href="#1-open-network-dropdown">1. Open network dropdown.</a></h4>
<p align="center">
<img src="guides/./screenshots/1.png"  width="400px">
</p>
<h4 id="2-add-network"><a class="header" href="#2-add-network">2. Add network</a></h4>
<p align="center">
<img src="guides/./screenshots/2.png"  width="400px">
</p>
<h4 id="3-add-network-manually"><a class="header" href="#3-add-network-manually">3. Add network manually</a></h4>
<p align="center">
<img src="guides/./screenshots/3.png"  width="100%">
</p>
<h4 id="4-fill-network-form-with-connection-data"><a class="header" href="#4-fill-network-form-with-connection-data">4. Fill network form with connection data</a></h4>
<p>Connection data:</p>
<ul>
<li>Network name: <strong>MetaChain</strong> (or whatever name you prefer)</li>
</ul>
<blockquote>
<p>⚠️ <strong>Warning: Due to potential network overloads, it is advised to use a local node over the public node to connect with Metamask. Follow the guide: <a href="guides/./guide_floppynet.html">Run a Local Node in Floppynet</a>.</strong></p>
</blockquote>
<ul>
<li>Local node (Recomended):
<ul>
<li>New RPC URL: <strong>http://127.0.0.1:20551</strong> or <strong>http://localhost:20551</strong></li>
</ul>
</li>
<li>Public node:
<ul>
<li>New RPC URL: <strong>http://35.187.53.161:20551</strong></li>
</ul>
</li>
</ul>
<blockquote>
<p>✏️ <strong>Note:</strong>
The public node is temporarily hosted by the core team for the easy access and convenience of early testers, and it is subject to change.</p>
</blockquote>
<ul>
<li>Chain ID: <strong>1132</strong> (Specific to Floppynet)</li>
<li>Currency symbol: <strong>DFI</strong></li>
<li>Block explorer URL: leave blank for now</li>
</ul>
<p align="center">
<img src="guides/./screenshots/4.png"  width="90%">
<img src="guides/./screenshots/5.png"  width="90%">
</p>
<h3 id="thats-it"><a class="header" href="#thats-it">That's it!</a></h3>
<p>Now you can switch to the MetaChain network and see your new account, transfer funds and call and deploy smart contracts.
To get some DFI, head to <a href="https://join.slack.com/t/defichain/shared_invite/zt-1vpyeesl3-iUa1aMjW4fCt0W53g2y46Q">DeFiChain's Slack</a>, join the <code>#testnet-faucet</code> channel and drop a message with your address, amount and reason like so:</p>
<pre><code>Address: 0x20b50961f7ce10F70874f358d54343cB388D3b71
Amount: 50DFI
Reason: Test Smart Contracts NFT Marketplace
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="run-a-local-node-in-changi"><a class="header" href="#run-a-local-node-in-changi">Run a Local Node in Changi</a></h1>
<h3 id="get-the-binaries"><a class="header" href="#get-the-binaries">Get the binaries</a></h3>
<p>Go to the <a href="https://github.com/DeFiCh/ain/releases">official DeFiChain release section</a> and look for the latest version of the node.</p>
<img src="guides/./screenshots/release-page.png"  width="90%">
<p>Then click on the Assets dropdown at the end of each release section. Then select the binaries for your Operating System.</p>
<img src="guides/./screenshots/assets.png"  width="90%">
<p>Once you have downloaded the binaries extract them to your desired directory. You should see three files inside the bin folder:</p>
<ul>
<li><code>defid</code>: DeFiChain node</li>
<li><code>defi-cli</code>: Command line interface to interact with the node</li>
<li><code>defi-tx</code>: utility tool to build and sign transactions on DeFiChain</li>
</ul>
<p>For the purpose of this guide we will only be using defid and defi-cli.</p>
<h3 id="runing-the-node"><a class="header" href="#runing-the-node">Runing the node</a></h3>
<p>To run the node just run the <code>defid</code> binary with the <code>-changi</code> flag</p>
<pre><code class="language-bash">defid -changi
</code></pre>
<blockquote>
<p>If you want <code>defid</code> to run as a deamon (in the background) add the <code>-daemon</code> flag to the command above. Also if you want to have additional debug information about the EVM add <code>RUST_LOG=debug</code> to the begining of the command.</p>
<p><code>RUST_LOG=debug defid -changi --daemon</code></p>
</blockquote>
<p>Once the node is running it should start syncing. The process of syncing can take up to a couple of hours depending on your machine so just be patient.</p>
<p>To check if the node is synced you can open a new terminal, run the following command and check if the fields <code>blocks</code> and <code>headers</code> are equal:</p>
<pre><code class="language-bash">defi-cli getblockchaininfo | head
</code></pre>
<img src="guides/./screenshots/getblockchaininfo.png"  width="90%">
<h3 id="connect-metamask"><a class="header" href="#connect-metamask">Connect Metamask.</a></h3>
<p>To connect to MetaMask the process is the same as the one described in <a href="guides/./guide_floppynet_short.html">Connect Metamask to Floppynet</a> and in <a href="guides/./guide_floppynet_short.html#4-fill-network-form-with-connection-data">point 4</a> use the Changi Testnet connection data below. For now only the Chain ID and the optional block explorer in the Changi Testnet are different:</p>
<table><thead><tr><th>Network</th><th>RPC URL</th><th>Chain ID</th><th>Block Explorer</th></tr></thead><tbody>
<tr><td>Changi Testnet</td><td>http://changi.dfi.team</td><td>1133</td><td>https://meta.defiscan.live</td></tr>
</tbody></table>
<h3 id="faucet"><a class="header" href="#faucet">Faucet</a></h3>
<p>To get Changi Testnet DFI you can use the faucet provided by the community at <a href="http://tc04.mydefichain.com/faucet/">http://tc04.mydefichain.com/faucet/</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="connect-metamask-to-changi-testnet"><a class="header" href="#connect-metamask-to-changi-testnet">Connect Metamask to Changi TestNet</a></h1>
<h3 id="to-connect-to-metachain-follow-this-four-steps-1"><a class="header" href="#to-connect-to-metachain-follow-this-four-steps-1">To connect to MetaChain follow this four steps:</a></h3>
<h4 id="1-open-network-dropdown-1"><a class="header" href="#1-open-network-dropdown-1">1. Open network dropdown.</a></h4>
<p align="center">
  <img width="356" alt="step1" src="https://github.com/DeFiCh/handbook/assets/113342097/ab62ae59-a140-45ff-a1e8-17db0c0a8683">
</p>
<h4 id="2-add-network-1"><a class="header" href="#2-add-network-1">2. Add network</a></h4>
<p align="center">
<img width="354" alt="step2" src="https://github.com/DeFiCh/handbook/assets/113342097/64a24837-114c-406f-b624-63f4974677fa">
</p>
<h4 id="3-add-network-manually-1"><a class="header" href="#3-add-network-manually-1">3. Add network manually</a></h4>
<p align="center">
<img width="1191" alt="step3" src="https://github.com/DeFiCh/handbook/assets/113342097/8277e3c3-710c-4081-a62e-fb3b337d96b2">
</p>
<h4 id="4-fill-network-form-with-connection-data-1"><a class="header" href="#4-fill-network-form-with-connection-data-1">4. Fill network form with connection data</a></h4>
<p>Connection data:</p>
<ul>
<li>Network name: <strong>MetaChain</strong></li>
</ul>
<blockquote>
<p>⚠️ <strong>Warning: Due to potential network overloads, it is advised to use a local node over the public node to connect with Metamask. Follow the guide: <a href="guides/./guide_changi.html">Run a Local Node in Changi</a>.</strong></p>
</blockquote>
<ul>
<li>RPC URL: https://changi.dfi.team</li>
<li>Chain ID: <strong>1133</strong> (Specific to Changi TestNet)</li>
<li>Currency symbol: <strong>DFI</strong></li>
<li>Block explorer URL: https://meta.defiscan.live</li>
</ul>
<p align="center">
<img width="863" alt ="step4" src="https://github.com/DeFiCh/handbook/assets/113342097/ec0f54dc-908b-4a01-8a7c-e0e778ddef09)">
<img width="863" alt="step5" src="https://github.com/DeFiCh/handbook/assets/113342097/c7d66182-0c57-437a-9f5c-091a40239011">
</p>
<h3 id="thats-it-1"><a class="header" href="#thats-it-1">That's it!</a></h3>
<p>Now you can switch to the MetaChain network and see your new account, transfer funds and call and deploy smart contracts.
To get some DFI, head to <a href="https://join.slack.com/t/defichain/shared_invite/zt-1vpyeesl3-iUa1aMjW4fCt0W53g2y46Q">DeFiChain's Slack</a>, join the <code>#testnet-faucet</code> channel and drop a message with your address, amount and reason like so:</p>
<pre><code>Address: 0x20b50961f7ce10F70874f358d54343cB388D3b71
Amount: 50DFI
Reason: Test Smart Contracts NFT Marketplace
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="concepts-2"><a class="header" href="#concepts-2">Concepts</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hard-forks"><a class="header" href="#hard-forks">Hard Forks</a></h1>
<p>This document lists all the hard forks in DeFiChain history and their changes.</p>
<h2 id="ang-mo-kio-v120"><a class="header" href="#ang-mo-kio-v120">Ang Mo Kio (v1.2.0)</a></h2>
<p><em>Block activated: 356500</em></p>
<h3 id="features"><a class="header" href="#features">Features</a></h3>
<ul>
<li>Support for DeFi Standard Token (DST), DeFi Custom Token (DCT) and DeFi Asset Token (DAT)</li>
<li>The ability to create, mint and distribute tokens has opened to all users.</li>
<li>Bitcoin anchor rewards in block reward</li>
<li>Reserve 25% of block reward for incentive funding</li>
</ul>
<h2 id="bayfront-v130"><a class="header" href="#bayfront-v130">Bayfront (v1.3.0)</a></h2>
<p><em>Block activated: 405,000</em></p>
<h3 id="features-1"><a class="header" href="#features-1">Features</a></h3>
<ul>
<li>DeX and liquidity pools
<ul>
<li>Ability to swap between tokens</li>
<li>Earn returns by providing liquidity through trading fees and liquidity incentives</li>
</ul>
</li>
</ul>
<h2 id="bayfront-gardens-v138"><a class="header" href="#bayfront-gardens-v138">Bayfront Gardens (v1.3.8)</a></h2>
<p><em>Block activated: 488,300</em></p>
<ul>
<li>Fixed issue with rewards distribution where pool shares of less than 0.01% weren't receiving rewards</li>
<li>Improved poolswap performance</li>
<li>Added new RPC calls to improve wallet usability</li>
</ul>
<h2 id="clarke-quay-v140"><a class="header" href="#clarke-quay-v140">Clarke Quay (v1.4.0)</a></h2>
<p><em>Block activated: 595,738</em></p>
<h3 id="features-2"><a class="header" href="#features-2">Features</a></h3>
<ul>
<li>Add custom rewards to pool pairs (<a href="https://github.com/DeFiCh/dfips/issues/5">dfip#3</a>)</li>
<li>Fix auto selecting balances</li>
<li>Do not stake while downloading blocks</li>
</ul>
<h2 id="dakota-v150"><a class="header" href="#dakota-v150">Dakota (v1.5.0)</a></h2>
<p><em>Block activated: 678,000</em></p>
<h3 id="features-3"><a class="header" href="#features-3">Features</a></h3>
<ul>
<li>Reduce masternode collateral requirement from 100,000 DFI to 20,000 DFI</li>
<li>Full refactor of the anchoring system, for more stability and robustness</li>
<li>Fix swap max price calculation. Fixes an issue where slippage protection was not activated correctly during times where the pool liquidity was low</li>
<li>Fix an issue where certain transactions were occasionally stalling the blockchain</li>
<li>Increase performance while staking</li>
</ul>
<h2 id="dakota-crescent-v160"><a class="header" href="#dakota-crescent-v160">Dakota Crescent (v1.6.0)</a></h2>
<p><em>Block activated: 733,000</em></p>
<h3 id="features-4"><a class="header" href="#features-4">Features</a></h3>
<ul>
<li>Consensus efficiency improvements</li>
</ul>
<h2 id="eunos-v170"><a class="header" href="#eunos-v170">Eunos (v1.7.0)</a></h2>
<p><em>Block activated: 894,000</em></p>
<h3 id="features-5"><a class="header" href="#features-5">Features</a></h3>
<ul>
<li>Interchain Exchange</li>
<li>Update block reward scheme (<a href="https://github.com/DeFiCh/dfips/issues/18">dfip#8</a>)
<ul>
<li>Introduce incentives for atomic swap, futures and options</li>
<li>Reduce block emmisions by 1.658% every 32,690 blocks</li>
</ul>
</li>
<li>Burn foundation funds (<a href="https://github.com/DeFiCh/dfips/issues/17">dfip#7</a>)</li>
<li>Price oracles</li>
<li>Track amount of funds burnt</li>
<li>Performance improvements in calculating block reward</li>
<li>Increase difficulty adjustment period from 10 blocks to 1008 blocks</li>
<li>Introduce 1008 block delay to masternode registration, 2016 block delay to resignation</li>
</ul>
<h2 id="eunos-paya-v180"><a class="header" href="#eunos-paya-v180">Eunos Paya (v1.8.0)</a></h2>
<p><em>Block activated: 1,072,000</em></p>
<h3 id="features-6"><a class="header" href="#features-6">Features</a></h3>
<ul>
<li>Introduce 5 and 10 year lock for masternodes for increased staking power</li>
<li><code>listaccounthistory</code> shows pool reward types as block reward or swap fees (commission)</li>
<li>Rename <code>getmintinginfo</code> to <code>getmininginfo</code></li>
<li>Add pagination to <code>listoracles</code>, <code>listlatestrawprices</code> and <code>listprices</code> RPCs</li>
<li>Clear anchor and SPV dasebase when SPV database version changes</li>
<li>Add support for subnode staking to make locked masternode rewards consistent
<ul>
<li>Normal masternodes mines using 2 subnodes.</li>
<li>5-year lockup masternode mines using 3 subnodes.</li>
<li>10-year lockup masternode mines using 4 subnodes.</li>
</ul>
</li>
</ul>
<h2 id="fort-canning-v200"><a class="header" href="#fort-canning-v200">Fort Canning (v2.0.0)</a></h2>
<p><em>Block activated: 1,367,000</em></p>
<h3 id="features-7"><a class="header" href="#features-7">Features</a></h3>
<ul>
<li>Decentralised loans
<ul>
<li>Collateral vaults</li>
<li>Taking loans and repayments</li>
<li>Liquidations and Auctions</li>
</ul>
</li>
<li>Composite swaps, swap across up to 3 pairs</li>
<li><code>spv_refundhtlcall</code> RPC gets all HTLC contracts stored in wallet and creates refunds transactions for all that have expired</li>
<li>Anchoring cost has now been reduced to BTC dust (minimum possible)</li>
<li>Transaction fees which were being burnt after Eunos upgrade will now be included in block rewards again</li>
</ul>
<h2 id="fort-canning-road-v270"><a class="header" href="#fort-canning-road-v270">Fort Canning Road (v2.7.0)</a></h2>
<p><em>Block activated: 1,786,000</em></p>
<h3 id="features-8"><a class="header" href="#features-8">Features</a></h3>
<ul>
<li>Futures contracts</li>
<li>Allow loans in a vault to be payed back with any other token through swaps to DFI</li>
<li>Allow DeX fees to be applied per pool and per token (affects all pools token is in)</li>
</ul>
<h2 id="fort-canning-crunch-v280"><a class="header" href="#fort-canning-crunch-v280">Fort Canning Crunch (v2.8.0)</a></h2>
<p><em>Block activated: 1,936,000</em></p>
<h3 id="features-9"><a class="header" href="#features-9">Features</a></h3>
<ul>
<li>Support for token splits</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="governance-variables"><a class="header" href="#governance-variables">Governance Variables</a></h1>
<p>Governance variables are used to track key stats and set key parameters for key blockchain utilities.</p>
<table><thead><tr><th>Name</th><th>Explanation</th></tr></thead><tbody>
<tr><td>LP_LOAN_TOKEN_SPLITS*</td><td>sets block reward distribution for dToken liquidity providers</td></tr>
<tr><td>LP_SPLITS*</td><td>sets block reward distribution for crypto liquidity providers</td></tr>
<tr><td>ICX_TAKERFEE_PER_BTC</td><td>defines taker fee rate for ICX</td></tr>
<tr><td>LP_DAILY_LOAN_TOKEN_REWARD</td><td>total amount of DFI paid to loaned token holders per day</td></tr>
<tr><td>LP_DAILY_DFI_REWARD</td><td>total amount of DFI paid to liquidity providers per day</td></tr>
<tr><td>LOAN_LIQUIDATION_PENALTY</td><td>liquidation penalty percentage (as percentage)</td></tr>
<tr><td>ORACLE_BLOCK_INTERVAL</td><td>oracle update rate</td></tr>
<tr><td>ORACLE_DEVIATION</td><td>maximum permissible deviation between reported oracle values (as percentage)</td></tr>
</tbody></table>
<p><em>*split between dToken and crypto LPs is defined in the <a href="references/../faq.html#what-is-the-current-block-reward-scheme">coinbase reward scheme</a>.</em></p>
<h2 id="loans-2"><a class="header" href="#loans-2">Loans</a></h2>
<p>Variable path is <code>ATTRIBUTES/v0/params/dfip2203/{attribute name}</code>.</p>
<table><thead><tr><th>Name</th><th>Explanation</th></tr></thead><tbody>
<tr><td>block_period</td><td>futures contract expiration time</td></tr>
<tr><td>reward_pct</td><td>premium/discount on expiry based on price difference between DEX price and oracle price (as percentage) (see <a href="https://github.com/DeFiCh/dfips/issues/127">dfip#2203-A</a>)</td></tr>
<tr><td>active</td><td>are futures enabled</td></tr>
</tbody></table>
<h2 id="economy-stats"><a class="header" href="#economy-stats">Economy stats</a></h2>
<p>Variable path is <code>ATTRIBUTES/v0/live/economy/{attribute name}</code>.</p>
<table><thead><tr><th>Name</th><th>Explanation</th></tr></thead><tbody>
<tr><td>dfip2203_minted</td><td>amount of tokens minted in futures</td></tr>
<tr><td>dfip2203_burned</td><td>amount of collateral burned in futures</td></tr>
<tr><td>dfip2203_current</td><td>amount of tokens minted + amount currently in active contracts</td></tr>
<tr><td>dfi_payback_tokens</td><td>amount of tokens loans are paid back in by token type (DFI and DUSD)</td></tr>
</tbody></table>
<h2 id="token-attributes"><a class="header" href="#token-attributes">Token attributes</a></h2>
<p>Variable path is <code>ATTRIBUTES/v0/token/{Token ID}/{attribute name}</code>.</p>
<table><thead><tr><th>Name</th><th>Explanation</th></tr></thead><tbody>
<tr><td>loan_collateral_factor</td><td>collateral factor percentage for token</td></tr>
<tr><td>fixed_interval_price_id</td><td>oracle price feed for token</td></tr>
<tr><td>dex_in_fee_pct</td><td>DEX fee for swapping from</td></tr>
<tr><td>dex_out_fee_pct</td><td>DEX fee for swapping to</td></tr>
<tr><td>loan_minting_enabled</td><td>allowed to mint token for loans (boolean)</td></tr>
<tr><td>loan_minting_interest</td><td>rate interest per block on minted tokens* (usually set to 0)</td></tr>
</tbody></table>
<p><em>*this interest is in addition to the vault scheme's interest rate</em></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="burns"><a class="header" href="#burns">Burns</a></h1>
<p>DFI and dTokens are burnt when interacting with various dApps such as DEX and loans, as well as due to extrinsic actions such as submitting CFPs (10 DFI) and DFIPs (50 DFI).</p>
<p>The amount of DFI and dTokens burnt can be found using the <code>getburninfo</code> RPC. A breakdown of the various sources of token burns can be found below.</p>
<table><thead><tr><th>Output</th><th>Description</th></tr></thead><tbody>
<tr><td>amount</td><td>(in DFI) the cumulative amount of transaction fees paid. This is redistributed to DeFiChain masternodes.</td></tr>
<tr><td>tokens</td><td>miscellaneous burns (such as CFP/DFIP proposal fee)</td></tr>
<tr><td>feeburn</td><td>(in DFI) DFI locked up to create masternodes (20000 DFI + 11 DFI non-refundable creation fee), tokens and vaults (1 DFI + 1 DFI refundable)</td></tr>
<tr><td>auctionburn</td><td>(in DFI) 5% auction fee + vault interest paid by auction participants</td></tr>
<tr><td>paybackburn</td><td>cumulative loan principal and interest paid back</td></tr>
<tr><td>dexfeetokens</td><td>cumulative DEX input and output fees burnt. Redistributed to liquidity providers.</td></tr>
<tr><td>dfipaybackfee</td><td>loaned DFI paid back in DFI</td></tr>
<tr><td>dfipaybacktokens</td><td>loaned DFI paid back in DUSD</td></tr>
<tr><td>paybackfees</td><td>cumulative dToken loan payback penalties</td></tr>
<tr><td>paybacktokens</td><td>cumulative dToken loan tokens paid back</td></tr>
<tr><td>emissionburn</td><td>DFI burnt due to unallocated block reward (see <a href="references/../faq.html#what-is-the-current-block-reward-scheme">block reward</a>)</td></tr>
<tr><td>dfip2203</td><td>dTokens burnt from DeFiChain Futures</td></tr>
</tbody></table>
<!-- - paybackfees - loan payback penalties (from live economy gov variable)
- paybacktokens - loan tokens paid back (from live economy gov variable)

- paybackFee - fee to payback loan (subintoken = amount \* price / payback penalty price is swapped to DFI and burnt) -->
<div style="break-before: page; page-break-before: always;"></div><h1 id="releases"><a class="header" href="#releases">Releases</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="glossary-1"><a class="header" href="#glossary-1">Glossary</a></h1>
<h2 id="hashing"><a class="header" href="#hashing">Hashing</a></h2>
<p>All DeFiChain hashing implentations follow the Bitcoin hashing implementation. All usage of hashes such as <code>CHash256</code> in DeFiChain are double SHA-256 hashes (such as hashing block headers and transactions). RIPEMD-160 is used when a shorter hash is desirable (for example when creating a DeFiChain address).</p>
<p>All DeFiChain hashing implentations follow the Bitcoin hashing implementation. The following are the key hashing functions used across various points:</p>
<ul>
<li>
<p><a href="https://github.com/DeFiCh/ain/blob/master/src/hash.h#L22"><code>CHash256(x)</code></a> = <code>SHA256(SHA256(x))</code></p>
<p>Example of double-SHA-256 encoding of string &quot;hello&quot;:</p>
<pre><code>hello
2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824 (first round of sha-256)
9595c9df90075148eb06860365df33584b75bff782a510c6cd4883a419833d50 (second round of sha-256)
</code></pre>
</li>
<li>
<p><a href="https://github.com/DeFiCh/ain/blob/master/src/hash.h#L46"><code>CHash160(x)</code></a> = <code>RIPEMD160(SHA256(x))</code></p>
<p>For bitcoin addresses (RIPEMD-160) this would give:</p>
<pre><code>hello
2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824 (first round is sha-256)
b6a9c8c230722b7c748331a8b450f05566dc7d0f (with ripemd-160)
</code></pre>
</li>
</ul>
<p>Double hashing provides protection against <a href="https://en.wikipedia.org/wiki/Length_extension_attack">length extension attacks</a> and reduces collision probability.</p>
<h4 id="external-resources-2"><a class="header" href="#external-resources-2">External Resources</a></h4>
<ul>
<li><a href="https://en.wikipedia.org/wiki/SHA-2">SHA-2</a></li>
<li><a href="https://en.wikipedia.org/wiki/RIPEMD">RIPEMD</a></li>
<li><a href="https://en.bitcoin.it/wiki/Block_hashing_algorithm">Bitcoin Block Hashing Algorithm</a></li>
</ul>
<h2 id="merkle-trees"><a class="header" href="#merkle-trees">Merkle Trees</a></h2>
<p>Merkle trees are binary trees of hashes. Merkle trees in DeFiChain use a double SHA-256. Merkle trees allow us to efficiently if check a transaction is part of the block - in <code>O(log n)</code> time.
If, when forming a row in the tree (other than the root of the tree), it would have an odd number of elements, the final double-hash is duplicated to ensure that the row has an even number of hashes.</p>
<p>First form the bottom row of the tree with the ordered double-SHA-256 hashes of the byte streams of the transactions in the block.</p>
<p>Then the row above it consists of half that number of hashes. Each entry is the double-SHA-256 of the 64-byte concatenation of the corresponding two hashes below it in the tree.</p>
<p>This procedure repeats until we reach a row consisting of just a single double-hash. This is the Merkle root of the tree.</p>
<p>For example, imagine a block with three transactions a, b and c. The Merkle tree is:</p>
<pre><code>d1 = dhash(a)
d2 = dhash(b)
d3 = dhash(c)
d4 = dhash(c) # a, b, c are 3. that's an odd number, so we take the c twice

d5 = dhash(d1 concat d2)
d6 = dhash(d3 concat d4)

d7 = dhash(d5 concat d6)
</code></pre>
<p>where</p>
<pre><code>dhash(a) = sha256(sha256(a))
</code></pre>
<p><code>d7</code> is the Merkle root of the 3 transactions in this block.</p>
<p>The implementation of Merkle trees can be found at <a href="https://github.com/DeFiCh/ain/blob/master/src/consensus/merkle.cpp"><code>src/consensus/merkle.cpp</code></a>.</p>
<p>Note: Hashes in Merkle Tree displayed in the Block Explorer are of little-endian notation. For some implementations and calculations, the bytes need to be reversed before they are hashed, and again after the hashing operation.</p>
<h4 id="external-references"><a class="header" href="#external-references">External References</a></h4>
<div style="break-before: page; page-break-before: always;"></div><h1 id="faq"><a class="header" href="#faq">FAQ</a></h1>
<h3 id="what-is-subnode-staking"><a class="header" href="#what-is-subnode-staking">What is subnode staking?</a></h3>
<p>Masternodes that are locked in for 5 and 10 years should increased rewards of 1.5x and 2x respectively, the subnode staking system was introduced to provide consistent returns. Since each of the subnodes has a unique masternode ID, it therefore allows for multiple hashes in the same interval. Thus, having multiple subnodes is equivalent to having a higher mining hashrate, and therefore proportionally increases chances of mining a block successfully leading to higher returns on average.</p>
<ul>
<li>Normal masternodes uses 2 subnodes</li>
<li>5 year lockup masternode uses 3 subnodes</li>
<li>10 year lockup masternode uses 4 subnodes</li>
</ul>
<h3 id="while-using-composite-swaps-are-fees-applied-once-or-multiple-times"><a class="header" href="#while-using-composite-swaps-are-fees-applied-once-or-multiple-times">While using composite swaps, are fees applied once or multiple times?</a></h3>
<p>Composite swaps will require the user to fees for every DeX pool that is utilised.</p>
<p>For example, swapping from dLTC to DUSD has the following routing and fees</p>
<pre><code>LTC
 ↓ (0.2%)
DFI
 ↓ (0.2%)
DUSD
</code></pre>
<p>$$
fees = 1 - ((1 \times 0.998) \times 0.998) = 0.003996
$$</p>
<p>Net fees for the swap will be 0.3996% without accounting for slippage.</p>
<h3 id="how-is-the-number-of-lp-tokens-calculated"><a class="header" href="#how-is-the-number-of-lp-tokens-calculated">How is the number of LP tokens calculated?</a></h3>
<p>The total number of liquidity tokens in a pool is $$min(\text{liquidity of A}, \text{liquidity of B})$$</p>
<p>When new liquidity is added, the amount of tokens returned to the user is</p>
<p>$$
min(liq_a, liq_b)
$$</p>
<p>where</p>
<p>$$
liq_a = \frac{\text{amount of A added} * \text{total liquidity}}{\text{amount of A}}
$$</p>
<p>and</p>
<p>$$
liq_b = \frac{\text{amount of B added} * \text{total liquidity}}{\text{amount of B}}
$$</p>
<h3 id="what-is-the-current-block-reward-scheme"><a class="header" href="#what-is-the-current-block-reward-scheme">What is the current block reward scheme?</a></h3>
<p>The base block reward is distributed to 6 different recipients. Recipients marked with UTXO are the only transactions present in the coinbase transaction.</p>
<table><thead><tr><th>Recipient</th><th>Coinbase allocation</th><th>Description</th></tr></thead><tbody>
<tr><td>Masternode (UTXO)</td><td>33.33%</td><td>Masternode rewards. Masternode also receives additional income from transaction fees.</td></tr>
<tr><td>Community Fund (UTXO)</td><td>4.91%</td><td>Community fund controlled by the Foundation, used to finance DeFiChain initiatives. <a href="https://github.com/DeFiCh/dfips">ref</a></td></tr>
<tr><td>Anchor</td><td>0.02%</td><td>Fund to pay the Bitcoin transaction fee for anchoring.</td></tr>
<tr><td>Liquidity Pools</td><td>25.45%</td><td>Distributed to crypto-crypto LP providers.</td></tr>
<tr><td>Loans</td><td>24.68%</td><td>Distributed to dToken-DUSD LP providers.</td></tr>
<tr><td>Options</td><td>9.88%</td><td>Distributed to options holders. Not in use currently.</td></tr>
<tr><td>Unallocated</td><td>1.73%</td><td>N/A</td></tr>
</tbody></table>
<div style="break-before: page; page-break-before: always;"></div><h1 id="issues"><a class="header" href="#issues">Issues</a></h1>
<p>A list of issues with breaking changes.</p>
<script src="scripts/getIssues.js"></script>
<script src="https://unpkg.com/showdown/dist/showdown.min.js"></script>
<table id="issues-table">
    <thead>
        <tr>
            <th>Issue Number</th>
            <th>Title</th>
            <th>URL</th>
        </tr>
    </thead>
    <tbody id="issues-body"></tbody>
</table>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_line_numbers = true;
        </script>
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="scripts/mermaid.min.js"></script>
        <script type="text/javascript" src="scripts/mermaid-init.js"></script>
        <script type="text/javascript">
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>
    </body>
</html>
